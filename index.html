
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fluxus Frequency</title>
  <meta name="author" content="Ben Lewis">

  
  <meta name="description" content="This post originally appeared on Engine Yard.
It was also a featured article in Ruby Weekly. With the announcement of Rails 4.2 came some exciting &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fluxusfrequency.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Fluxus Frequency" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
	<div class="header-title"><a href="/">Fluxus Frequency</a></div>


	<br><div class="header-subtitle">How I Hacked The Mainframe</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fluxusfrequency.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/10/15/getting-started-with-active-job/">Getting Started With Active Job</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-10-15T06:40:09-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2014/getting-started-with-active-job">Engine Yard</a>.
It was also a featured article in <a href="http://rubyweekly.com/issues/215">Ruby Weekly</a>.</p>

<p>With the announcement of Rails 4.2 came some exciting <a href="news:">news:</a> Rails now has built-in support for executing jobs in the background using Active Job. The ability to schedule newsletters, follow-up emails, and database housekeeping tasks is vital to almost any production application. In the past, developers had to hand-roll this functionality, and configuration varied between different queueing services. With the release of Rails 4.2, setting up jobs to be executed by workers at a later time is standardized. In this article, we&rsquo;ll take a look at how to set up Active Job and use it to send a follow-up email to a new user.</p>

<p><a href="https://blog.engineyard.com/2014/getting-started-with-active-job">Read More</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/10/02/wrapping-your-api-in-a-custom-ruby-gem/">Wrapping Your API in a Custom Ruby Gem</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-10-02T07:03:19-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2014/wrapping-your-api-in-a-ruby-gem">Engine Yard</a>.</p>

<p>In the modern web, API-based projects are becoming the norm. Why? For one thing, APIs are necessary to serve Single Page Applications, which are all the rage right now. From a business standpoint, APIs give companies a new way to charge others for access to their data. If you are part of a company that offers such a service, a great way to generate interest in your API is to offer a Ruby gem that makes fetching and consuming your data easy for Ruby developers.</p>

<p><a href="https://blog.engineyard.com/2014/wrapping-your-api-in-a-ruby-gem">Read more</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/09/25/using-services-to-keep-your-rails-controllers-clean-and-dry/">Using Services to Keep Your Rails Controllers Clean and DRY</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-09-25T07:02:57-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">Engine Yard</a>.</p>

<p>It also appeared in <a href="http://rubyweekly.com/issues/214">Ruby Weekly</a>.</p>

<p>We&rsquo;ve heard it again and again, like a nagging schoolmaster: keep your Rails controllers skinny. Yeah, yeah, we know. But easier said than done, sometimes. Things get complex. We need to talk to some other parts of our codebase or to external APIs to get the job done. Mailers. Stripe. External APIs. All that code starts to add up.</p>

<p><a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">Read more</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/09/04/looking-for-a-needle-in-a-haystack-with-ack/">Looking for a Needle in a Haystack! (or Using Ack to Improve Your Development Workflow)</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-09-04T06:19:42-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on the <a href="http://quickleft.com/blog/looking-for-a-needle-in-a-haystack-or-using-ack-to-improve-your-development-workflow">Quick Left Blog</a>.</p>

<p>Every day when I&rsquo;m programming, I invariably come to a point where I&rsquo;m looking for a certain line of code in my project. I could just use my editor&rsquo;s &ldquo;find in files&rdquo; feature and look for it, but sometimes I need more fine grained control. What if I want to find all the lines of code that don&rsquo;t contain a certain phrase? What if I want to search on a Regular Expression? What if I want to easily save the search results to a file?</p>

<p>When I need MOAR POWER in finding something, I turn my favorite command line search tool: ack. In this blog post, we&rsquo;ll explore the ins and outs of this fantastic application.</p>

<p><a href="http://quickleft.com/blog/looking-for-a-needle-in-a-haystack-or-using-ack-to-improve-your-development-workflow">Read more</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/07/24/angular-js-unit-testing-for-real-though/">AngularJS Unit Testing, for Real Though</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-07-24T06:20:37-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on the <a href="http://quickleft.com/blog/angularjs-unit-testing-for-real-though">Quick Left Blog</a>.</p>

<p>It also appeared as a featured article in <a href="http://javascriptweekly.com/issues/192">JavaScript Weekly</a>.</p>

<p>When it comes to contemporary web development, AngularJS is the new hotness. Its unique approach to HTML compilation and two-way data binding make it an effective tool for efficiently building client-side web apps. But when it comes to the testing, many tutorials on the interwebs hand-wave testing. This article covers some of the &ldquo;gotchas&rdquo; you&rsquo;ll come across when trying to test Angular. Let&rsquo;s build our chops, so we can get into a &ldquo;Red-Green-Refactor&rdquo; flow when testing Angular.</p>

<p><a href="http://quickleft.com/blog/angularjs-unit-testing-for-real-though">Read more</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/05/20/five-capybara-hacks-to-make-your-testing-experience-less-painful/">Five Capybara Hacks to Make Your Testing Experience Less Painful</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-05-20T06:20:08-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on the <a href="http://quickleft.com/blog/five-capybara-hacks-to-make-your-testing-experience-less-painful">Quick Left Blog</a>.</p>

<p>Everyone knows it&rsquo;s important to test your code. But sometimes, the experience can be a little bit painful. Ok, sometimes it&rsquo;s very painful. Like when you&rsquo;re trying to feature test a JavaScript-heavy Rails app.</p>

<p>What to do? Abandon the tests? Never! Smokey, this is not &lsquo;Nam. This is coding. There are rules.</p>

<p><a href="http://quickleft.com/blog/five-capybara-hacks-to-make-your-testing-experience-less-painful">Read more</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/02/14/service-oriented-architecture/">Service Oriented Architecture</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-02-14T06:40:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We just finished up our penultimate project at gSchool, an application built using a Service Oriented Architecture (SOA). The project ideas were generated in small groups, and focused a the theme of health and wellness. Once the ideas were decided, our teacher Jeff Casimir generated a randomized list of the students, and we drafted projects.</p>

<p>I went first, and selected an idea that was close to my heart: an app to help home vegetable gardeners plan out their beds for the season. Having spent several years as an organic farm worker, garden company owner, and home garden hobbyist, I was excited to use this app. Every spring, before the ground warms up, my partner and I sit down with a pencel and graph paper to plan out the different beds in my garden: what will go where, how it will be spaced, when it will be harvested, and what we&rsquo;ll plant there afterwards.</p>

<p>I had big hopes for our project, dubbed <a href="http://plantingseason.tk">Planting Season</a> (<a href="https://github.com/VirginSoil">code</a>). A user would have several gardens, each with many beds. The app would keep track of her plans from month to month, and she would be able to click on a month to see what she&rsquo;d planned to plant there, which spots were empty, and which plants were ready for harvest. It would find her USDA Hardiness Zone and suggest plants well-suited to grow there. If there was impending frost, or a bed needed water, it would send her a text message, email, or a Google voice message.</p>

<p>Ah, the dreams of the young and inexperienced&hellip;</p>

<h2>Planting Season&rsquo;s Structure</h2>

<p>Two of my group members had just completed <a href="https://github.com/foofoberry">FooFoBerry</a>, an SOA app that exposed and consumed APIs from various project management tools, such as GitHub, Travis, and Code Climate. With their experience setting up services, I figured that getting the project up and running would be a breeze. In practice, it was more challenging than I expected.</p>

<p>I&rsquo;m a big fan of a &ldquo;lean startup&rdquo; / &ldquo;minimum viable product&rdquo; approach in my projects. I like to get a simple product up as fast as possible, then expand on it, adding value. Given that we had three weeks, we planned three iterations for Planting Season:</p>

<p>Week 1 - Put up a landing page where users could enter their email to be notified when the app was ready.</p>

<p>Week 2 - Change the landing page to allow users to sign up or sign in, then send them to a dashboard page, where they could add and remove plants from a single garden.</p>

<p>Week 3 - Add functionality for multiple beds, text and email weather notifications, and a timeline for the garden through the year.</p>

<p>With this functionality in mind, we decided to build the following services:</p>

<ol>
<li>Landing Page App</li>
<li>User Authentication App</li>
<li>Client-Facing Dashboard (&ldquo;Coordinator&rdquo;) App</li>
<li>RESTful JSON API with Bed and Plant data</li>
<li>A gem to facilitate communication between the Dashboard and the API</li>
<li>External Services - Weather and Geolocation APIs</li>
</ol>


<p>Here&rsquo;s how the project ended up looking in the end:</p>

<p><br /></p>

<p><img class="center" src="http://s5.postimg.org/w893s8cuf/planting_season_graph.png" title="Planting Season Project Structure" alt="A web application diagram"></p>

<h2>Project Management &amp; Workflow</h2>

<p>Over the course of gSchool, I&rsquo;ve been learning a lot about the social aspect programming. I worked solo in my ealiest projects, then graduated to pairing, and later went on to work in groups of three or four. In the beginning, I was just doing my own thing, but as I started getting into the larger groups, project management became a key skill. I&rsquo;ve found myself in the role of Project Manager in many successive projects. The first couple of times were messy: I didn&rsquo;t make enough space for people to express how they were <em>feeling</em> at our standups, our iteration planning was nonexistent, and I didn&rsquo;t understand how to use Pivotal Tracker at all. As I learned from these experiences, I began to firmly value things like daily standups with technical <em>and</em> emotional checkins, persona and wireframing UX design, iteration planning, proper use of Pivotal Tracker, consistent version control practices, and continuous integration.</p>

<p>We started Planting Season with the best of intentions, but this time around, it proved harder to practice these strategies than I hoped. At our checkins, it was clear that we were all feeling unfocused and pulled in different directions by job applications and interviews, burnout, and Jeff&rsquo;s absence after his wife gave birth to their latest addition to the family. We planned our iterations, but we didn&rsquo;t meet the first one because a couple of us were out of town or at interviews. Soon we fell behind. On top of that, Pivotal Tracker stopped letting us edit our stories, because our free trial was expired. The Travis CI specs wouldn&rsquo;t pass, because the specs couldn&rsquo;t talk to the API (more on this in a minute). Of all the agile practices we hoped to use, only the UX planning went well.</p>

<h2>Nginx, Passenger, and VPS Woes</h2>

<p>Our troubles were compounded by the difficulty of getting our services to talk to each other. Our plan was to run Foreman locally, booting our apps onto different ports on localhost, then use Nginx to route everything through different namespaced routes on port 8080. Getting Foreman up and running was easy enough, but Nginx was a bear to configure. Meanwhile, getting Phusion Passenger and Nginx to play nicely on our VPS was also a struggle. It turns out that you have to install Passenger first, then add Nginx as an extension to it. If you install Nginx first, you end up with two conflicting versions. Additionally, one of our team mates was having RVM issues, and had to reinstall Ruby and all of his gems twice.</p>

<p>In the second week, we lost two solid days of of development time to the fight with the Nginx config file, Passenger, and RVM.</p>

<p>For posterity&rsquo;s sake, here&rsquo;s a snapshot of the <code>nginx.conf</code> file that finally worked for local production:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>worker_processes  1<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>error_log  logs/error.log<span class="p">;</span>
</span><span class='line'><span class="c">#pid        logs/nginx.pid;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections  1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    include       mime.types<span class="p">;</span>
</span><span class='line'>    default_type  application/octet-stream<span class="p">;</span>
</span><span class='line'>    <span class="c">#passenger_root /usr/local/opt/passenger/libexec/lib/phusion_passenger/locations.ini;</span>
</span><span class='line'>    <span class="c">#passenger_ruby /usr/bin/ruby;</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen       8080<span class="p">;</span>
</span><span class='line'>        server_name  localhost<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># PLANTING SEASON</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Landing Page</span>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3000<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Auth</span>
</span><span class='line'>        location /auth <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3001<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Coordinator</span>
</span><span class='line'>        location /dashboard <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3002<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># API</span>
</span><span class='line'>        location /api <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3003<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Troubles</h2>

<p>Once we had the services running on a single port, we figured everything would be gravy. We added the VCR gem to save the results of our API calls, and began testing. We covered the landing page, auth app, and our gem.</p>

<p>Then I started to dig in on some Capybara tests for the coordinator app, and had some major headaches. In order to view the dashboard, I needed to set a signed cookie to simulate the authorization app. Easy enough. All you have to do is use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">set_cookie</span> <span class="s1">&#39;user_id=1&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is, unless you&rsquo;re using Poltergeist for a JS driver. Then, you clearly use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now, I had a different problem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failure/Error: within <span class="s1">&#39;#bed-functions&#39;</span> <span class="k">do</span>
</span><span class='line'>     Capybara::ElementNotFound:
</span><span class='line'>       Unable to find css <span class="s2">&quot;#bed-functions&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the launchy gem and <code>save_and_open_page</code>, <code>#bed-functions</code> was there, all right. I could feel another configuration battle coming on as we headed into the third week.</p>

<h2>Getting Back on the Horse</h2>

<p>On Monday morning of the week the project was due, we had little to show for our two weeks of work. There were services, but they couldn&rsquo;t talk to each other on the server. There were mock-ups, but the CSS wasn&rsquo;t in the views yet. The tests were thin. We had a meeting with Jeff, and told him we planned to bolster the test coverage and solidify what we already had. His advice: &ldquo;that would be  a good idea if you had a thing, but right now you don&rsquo;t. You might want to make a thing first.&rdquo;</p>

<p>So we saddled up, and the cowboy coding began.</p>

<h2>jQuery Sparkle</h2>

<p>The next two days were actually pretty fun, if a little painful (coding without tests makes me uncomfortable). We got the CSS hooked up, integrated with the weather service, and added a healthy dose of JavaScript to the dashboard. Although we would have liked to explore Ember.js, we decided to stick to plain old jQuery in the interest of time. We quickly coded 275 lines of jQuery sparkle, and we had a thing! If you&rsquo;re interested, go <a href="http://plantingseason.tk/">check out</a> what we made!</p>

<p>My favorite part was adding the ability to click and drag on the garden bed squares for multi-selection. Here&rsquo;s what that looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">).</span><span class="nx">mousedown</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">thisClass</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">toggleSquare</span><span class="p">(</span><span class="nx">thisClass</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">).</span><span class="nx">mouseenter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">thisClass</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">toggleSquare</span><span class="p">(</span><span class="nx">thisClass</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">mouseup</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to see more of what we did with the JS, you can check out the <a href="https://github.com/VirginSoil/planting_season_coordinator/tree/master/app/assets/javascripts">code on GitHub</a>.</p>

<h2>Conclusion</h2>

<p>From the beginning of gSchool, the SOA project was one of the things I was looking forward to the most. Although Jeff said he thought that it was probably &ldquo;not a reasonable thing&rdquo; to start a project from the beginning with SOA, I set out with the highest of expectations. But the problems along the way were numerous.</p>

<p>The job search was a distraction. But more troubling to me was the difficulty of testing. I&rsquo;ve gotten really comfortable with using Travis CI, and driving my development with Pivotal Tracker user stories translated into Capybara feature tests. It was really hard to do with services. Between setting up Passenger and Nginx and the testing troubles, we lost a <em>lot</em> of time on configuration.</p>

<p>Reflecting on the experience, I&rsquo;d say that SOA is probably a practice better left until it is needed. If I were in charge building a new app for a startup, I would still start by iterate on delivering business value with successive MVPs. When I began to feel the pain of scaling, then I would think about splitting off services.</p>

<p>However, it&rsquo;s possible that I&rsquo;ve only come to this conclusion because the process was so painful. There&rsquo;s another way of looking at this.</p>

<p>Here&rsquo;s a lesson that I&rsquo;ve learned about programming again and again over the last six months:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">The</span> <span class="nx">first</span> <span class="nx">time</span> <span class="nx">you</span> <span class="k">do</span> <span class="nx">something</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">hard</span> <span class="nx">and</span> <span class="nx">doesn</span><span class="err">&#39;</span><span class="nx">t</span> <span class="nx">make</span> <span class="nx">any</span> <span class="nx">sense</span><span class="p">.</span>
</span><span class='line'><span class="nx">The</span> <span class="nx">second</span> <span class="nx">time</span> <span class="nx">you</span> <span class="k">do</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">seems</span> <span class="nx">vaguely</span> <span class="nx">familiar</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">makes</span> <span class="nx">a</span> <span class="nx">little</span> <span class="nx">bit</span> <span class="nx">of</span> <span class="nx">sense</span><span class="p">.</span>
</span><span class='line'><span class="nx">From</span> <span class="nx">then</span> <span class="nx">on</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">makes</span> <span class="nx">sense</span> <span class="nx">and</span> <span class="nx">feels</span> <span class="nx">natural</span> <span class="nx">to</span> <span class="k">do</span> <span class="nx">it</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>If this is true (which it seems to be for me), then it might actually make sense to build apps using services from the get go, if you expect them to have to scale down the road. I&rsquo;d love to nail down a workflow for getting Passenger, Foreman, and Nginx set up in less than 30 minutes. I&rsquo;d also like to learn how to better test services and get them set up with continuous integration. I think that if I understood these things, SOA would be a tool I&rsquo;d be a lot more likely to reach for.</p>

<p>If you have any tips about these two aspects of services, let&rsquo;s talk! Tweet at me: @fluxusfrequency.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/01/31/building-a-binary-search/">Building a Binary Search</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-01-31T10:34:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of days ago I had an interview with a big startup in Boulder. I was really excited about the possibility of working there, because they solve some <em>really</em> hard problems on a daily basis, and because I&rsquo;ve heard great things about their office culture.</p>

<p>It was just supposed to be a quick interview, but it ended up taking a few hours. First, I met up with the CTO. It all started off innocent enough. We went to a restaurant on Pearl Street for lunch. He asked me about my background and skills, and I asked him about the company. We shared personal stories about the flood last summer. After hearing about the way he treats his workers (like adults), and some of the technical details of what they were working on, I was even more excited about the company. We headed went to a coffee shop for a drink, then went back to the office.</p>

<p>When we got there, he introduced me to the head of the team that the best fit for me if I worked there. The team lead, one of his coworkers and I headed back to the coffee shop. We chatted about Rails, <a href="http://www.exercism.io">Exercism</a>, TDD, and Ember.js, and life at their company. Pretty soon, the CTO came in again. Seeing that we were still talking, he asked the team lead to take me back and &ldquo;dig in technically&rdquo; a little bit.</p>

<p>We went back to the office again, and found a conference room. He asked me to solve <a href="http://en.wikipedia.org/wiki/Fizz_buzz">FizzBuzz</a> in JavaScript. I fired up Jasmine-Node and built it with tests the whole way. That went fairly well, I thought. Then he asked me a couple of CSS questions. I answered them, and he said that I answered them better than many of the people he interviews.</p>

<p>Finally, we came to some algorithm questions. Although I&rsquo;ve learned a lot at gSchool in the last five months, algorithms are something that I haven&rsquo;t spent as much time on, yet. I&rsquo;ve only had enough programming context to begin understanding them for the last two of those months. I&rsquo;ve played around with them as much as I could, solving Linked List, the Luhn Algorithm, Nth Prime Factor, Sum of Squares, and Binary Search Tree. I&rsquo;ve also had a go at writing the MD5 algorithm. But compared to someone with a four year CS degree, I haven&rsquo;t had much time to get comfortable with them.</p>

<p>My interviewer drew an array on the board, and asked me how I would find a given element&rsquo;s position within 2-3 queries. I thought about it, made a guess that it had to do with bit operators, and finally conceded that I had no idea. My heart sunk. Things were going so well. When I asked for the solution, he told me that it was to use a Binary Search. I got excited, because I <em>had</em> done a Binary Search Tree. But no, this was just plain old Binary Search.</p>

<p>Bitten that I didn&rsquo;t know how to do Binary Search, I set out to build it on my own. This rest of this post is a walkthrough of how I solved it.</p>

<h2>Research</h2>

<p>First, I visited Wikipedia and read up on <a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">Binary Search</a>. It was pretty easy to follow. So easy, in fact, I decided to lift some of the text verbatim and translate it into a set of tests to drive my implementation. Here&rsquo;s what I found:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Searching a sorted collection is a common task. A dictionary is a sorted list of
</span><span class='line'> word definitions. Given a word, one can find its definition. A telephone book
</span><span class='line'> is a sorted list of people's names, addresses, and telephone numbers. Knowing
</span><span class='line'> someone's name allows one to quickly find their telephone number and address.
</span><span class='line'>
</span><span class='line'>If the list to be searched contains more than a few items (a dozen, say) a
</span><span class='line'>binary search will require far fewer comparisons than a linear search, but it
</span><span class='line'>imposes the requirement that the list be sorted.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>In computer science, a binary search or half-interval search algorithm finds
</span><span class='line'>the position of a specified input value (the search "key") within an array
</span><span class='line'>sorted by key value.
</span><span class='line'>
</span><span class='line'>In each step, the algorithm compares the search key value with the key value of
</span><span class='line'>the middle element of the array.
</span><span class='line'>
</span><span class='line'>If the keys match, then a matching element has been found and its index, or
</span><span class='line'>position, is returned.
</span><span class='line'>
</span><span class='line'>Otherwise, if the search key is less than the middle element's key, then the
</span><span class='line'>algorithm repeats its action on the sub-array to the left of the middle element
</span><span class='line'>or, if the search key is greater, on the sub-array to the right.
</span><span class='line'>
</span><span class='line'>If the remaining array to be searched is empty, then the key cannot be found in
</span><span class='line'>the array and a special "not found" indication is returned.
</span><span class='line'>
</span><span class='line'>A binary search halves the number of items to check with each iteration, so
</span><span class='line'>locating an item (or determining its absence) takes logarithmic time. A binary
</span><span class='line'>search is a dichotomic divide and conquer search algorithm.</span></code></pre></td></tr></table></div></figure>


<p>I decided to take this step-by-step description and turn each step into a test.</p>

<h2>Setting Up the Binary Search Test &amp; Class</h2>

<p>The first step was to create an object that knew about &ldquo;an array sorted by key value&rdquo;, or as I like to call it, a list. I wrote a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearchTest</span> <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_has_list_data</span>
</span><span class='line'>    <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">list</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And a class to make it pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@list</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That was easy! Next, it needed to be able to check whether the list was actually sorted, so I wrote a test to make sure it would throw an error if it wasn&rsquo;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_raises_error_for_unsorted_list</span>
</span><span class='line'>  <span class="n">assert_raises</span> <span class="no">ArgumentError</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make it pass, I implemented the following check: compare the input with itself in sorted form. Not that elegant, but it worked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ArgumentError</span> <span class="k">unless</span> <span class="n">data</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">data</span>
</span><span class='line'>    <span class="vi">@list</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>According to the Wikipedia article, the algorithm was going to have to find &ldquo;the key value of the middle element of the array&rdquo;. So I wrote a test to make sure that it knew where the middle of its list was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_of_middle_item</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">3</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">middle</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was fairly trivial to solve:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">middle</span>
</span><span class='line'>    <span class="n">list</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the class all set up, I turned my attention to the actual search algorithm itself.</p>

<h2>Building the Search Algorithm</h2>

<p>The goal was to search for the index of a specific element, so I wrote a test for a method that did that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_of_search_data</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">5</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next came the hard part. I took the text from Wikipedia and broke it down into pseudo-code:</p>

<ul>
<li>Get the search value</li>
<li>Find the middle element in the list</li>
<li>Check if they are equal</li>
<li>If they are equal, return the position of the middle element in the list</li>
<li>If they are not equal, branch:</li>
</ul>


<p>If the search key is less than the middle index:</p>

<ul>
<li>Cut the list we&rsquo;re searching in half</li>
<li>Instantiate a new BinarySearch</li>
<li>Pass the first half of the list into it</li>
<li>Call the search method on the new object, with the same search key</li>
<li>Repeat until the keys are equal</li>
<li>If they&rsquo;re never equal, raise &ldquo;Not Found&rdquo;</li>
</ul>


<p>If the search key is more than the middle index:</p>

<ul>
<li>Cut the list we&rsquo;re searching in half</li>
<li>Instantiate a new BinarySearch</li>
<li>Pass the second half of the list into it</li>
<li>Call the search method on the new object, with the same search key</li>
<li>Repeat until the keys are equal</li>
<li>If they&rsquo;re never equal, raise &ldquo;Not Found&rdquo;</li>
</ul>


<p>With this plan in place, I started to build the method. First, I created the method and passed in the search key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I checked it against the middle element in the list, returning the index if they were equal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next thing on my to do list was to branch for the other two conditions: whether the key was less than or greater than the middle value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># ???</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># ???</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I filled in the branches some more of my pseudo-code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the second half of the list into it</span>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I filled them in with real code, one step at a time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">search</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">search</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Seeing some duplication here, I went ahead and refactored:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to run the tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Expected: 5
</span><span class='line'>  Actual: 2
</span></code></pre></td></tr></table></div></figure>


<p>Fail.</p>

<p>Why? I did some <code>pry</code> action and discovered that I was getting back the index of the <em>new</em> list&rsquo;s middle element, not the <em>original</em> list&rsquo;s middle element. To fix this, I added the current list&rsquo;s middle to the recursive call. That meant undoing my refactor. I guess I refactored too soon.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">middle</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The tests were now passing. Good. Time to try with another example. This time looking for keys on both sides of the middle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_in_a_larger_list</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoops! <code>stack level too deep</code>! I forgot to change value of the search on line 3. I was getting an infinite loop when I searched for a bad value. I skipped this test and wrote one for the bad search condition, instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_raises_error_for_data_not_in_list</span>
</span><span class='line'>  <span class="n">assert_raises</span> <span class="no">RuntimeError</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make this pass, I had to validate that the search wasn&rsquo;t stuck looking through the same sublist over and over:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Not Found&quot;</span> <span class="k">if</span> <span class="n">sublist</span> <span class="o">==</span> <span class="n">list</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Not Found&quot;</span> <span class="k">if</span> <span class="n">sublist</span> <span class="o">==</span> <span class="n">list</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">middle</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It passed! I went back and rewrote the other test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_in_a_larger_list</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">7</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Passed again! How about one more for good measure? I also wanted to check if the middle was still coming out right when I passed in a list with an even number of elements. All the others had been of an odd length.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_correct_position_in_a_list_with_an_even_number_of_elements</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">377</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">5</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">6</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok! Green!</p>

<h2>Conclusion</h2>

<p>Even if I didn&rsquo;t know my stuff in the conference room at that moment, I&rsquo;m glad that my interviewer asked me about Binary Search. It was fun to learn, and it turned out to be a little easier than I expected. I always expect algorithms to be really hard to grasp, but maybe now that I&rsquo;ve done a few algorithms that use recursion, it&rsquo;s not such a jump for me to understand it.</p>

<p>At any rate, it&rsquo;s pretty cool to be able to find an element in a list with so few queries. Lately, I&rsquo;ve really been enjoying pure math programming problems like this one. I&rsquo;m going to try to find a few more like this to do in the near future.</p>

<h2>Footnote</h2>

<p>Since I had already done all of the work, I went ahead and submitted this as a new exercise for <a href="http://www.exercism.io">Exercism.io</a>. So, if you use Exercism, and you enjoy doing algorithms, I&rsquo;d suggest giving Binary Search a go yourself. If you get stuck, you know where to find the answer!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/01/27/refactoring-4-remove-middle-man/">Refactoring 4: Remove Middle Man</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-01-27T19:34:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today, in my latest journey on the <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactor</a> Tractor, I&rsquo;ll be taking a look at a strategy called Move Method.</p>

<p>Move Method is used to help remove duplication. Sometimes, in the interest of encapsulation, it&rsquo;s a good idea to make an object as unaware of another object as possible. If the first needs to access the second, though, it may have to &ldquo;reach through&rdquo; a third object. If this reaching is minimal, it can sometimes be a worthwhile trade off. But when it becomes an ongoing pattern, you can end up with a lot of duplication. And a lot of what my teacher Franklin Webber calls &ldquo;bad touching&rdquo;. The Refactoring book points out that &ldquo;it&rsquo;s hard to figure out what the right amount of hiding is&rdquo;,  but it&rsquo;s easy to change your mind with refactoring. Using a combination of this strategy and Hide Delegate, you can always change it again later.</p>

<p>Today I&rsquo;ll be practicing Remove Middle Man on another example from the <a href="https://github.com/fluxusfrequency/mancala">Mancala</a> app I was refactoring in my recent post: <a href="fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/">Refactoring 2 - Replace Method With Method Object</a>.</p>

<p>Here are the steps to Remove Middle Man:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Create an accessor for the delegate.
</span><span class='line'>
</span><span class='line'>2. For each client use of a delegate method, remove the method from the server and replace the call in the client to call the method on the delegate.
</span><span class='line'>
</span><span class='line'>3. Test after each method.
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s fairly cryptic. I think it means: just pass a reference to the distant object into the first object, and access it directly (instead of through object two).</p>

<h2>Mancala Game View</h2>

<p>There are many poorly-built parts to Mancala. That&rsquo;s probably because I didn&rsquo;t test it at all as I was writing it. At the time, I thought I was taking a shortcut. In reality, I was making a big mess that was difficult to understand and deal with. I didn&rsquo;t realize it at the time, but <a href="http://blog.testdouble.com/posts/2014-01-25-the-failures-of-intro-to-tdd.html">&ldquo;TDD&rsquo;s primary benefit is to improve the design of our code&rdquo;</a>.</p>

<p>One of my poorly designed classes is called the MancalaGameView. Its job is to draw the beads in their respective pits, and print the winner to the screen, using <a href="https://github.com/jashkenas/ruby-processing">Ruby Processing</a>. Here&rsquo;s the problem with my design: I pass in the &lsquo;app&rsquo; object, then call through it to get information about the &lsquo;rules&rsquo; and &lsquo;model&rsquo; objects. Here&rsquo;s what it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">fill</span> <span class="mi">225</span>
</span><span class='line'>    <span class="n">n</span> <span class="o">=</span> <span class="n">pit</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">9</span>
</span><span class='line'>      <span class="n">draw_x_beads</span><span class="p">(</span><span class="n">pit</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">draw_many_beads</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fill_a_random_color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">store</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">draw_beads_in_player_one_store</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">store</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>      <span class="n">draw_beads_in_player_two_store</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">475</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Player two is the winner!&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">250</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">475</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The calls to <code>app.fill</code> and <code>app.text</code> are built into Ruby Processing. Outside of that, I&rsquo;m not going to get into the details of what some of these methods, like <code>draw_x_beads</code> and <code>draw_beads_in_player_one_store</code>. Because the coupling in this app is so high, it would require pulling in too many methods.</p>

<h2>Setting Up the Test</h2>

<p>I&rsquo;m going to stub out a few things, so that we can build a test without having to drag in the rest of the app and the Ruby Processing Gem.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Player one is the winner!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Player two is the winner!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Tie Game!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">all_pits</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">all_stores</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Ruler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">winner</span>
</span><span class='line'>    <span class="n">winners</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:player_1</span><span class="p">,</span> <span class="ss">:player_2</span><span class="p">,</span> <span class="ss">:tie</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@winner</span> <span class="o">||=</span> <span class="n">winners</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">game_over?</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now, to build a test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="no">Model</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="no">Ruler</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@model</span><span class="p">,</span> <span class="vi">@ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_draw_all_beads_succeeds</span>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span> <span class="s2">&quot;Player two is the winner!&quot;</span><span class="p">,</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="vi">@view</span><span class="o">.</span><span class="n">draw_all_beads</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">expected</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>This test is green. I don&rsquo;t like to start from green. It&rsquo;s supposed to be: &ldquo;red, green, refactor&rdquo;! I could comment out some code or change <code>game_over?</code> to false, but that wouldn&rsquo;t prove anything about the code. Since this is an instance of Test After, and the code is already understood, I&rsquo;m feel comfortable going forward from green here.</p>

<h2>Applying the Strategy</h2>

<p>Now, to begin removing the middle man object, <code>app</code>. There are two classes I&rsquo;m accessing through <code>app</code>: <code>Model</code> and <code>Ruler</code>. I&rsquo;ll extract them one at a time, beginning with <code>Model</code>. The first step is to &ldquo;create an accessor for the delegate&rdquo;. I could just do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">model</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But I would rather pass the model into the MancalaGameView directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step two is to change &ldquo;client&rdquo; calls so that they use the new accessor instead of calling through the &ldquo;server&rdquo; (which is <code>app</code> in this case). Step three is to test after each method. So here we go:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def draw_all_beads</span>
</span><span class='line'><span class="c1">#   app.model.all_pits.each do |pit|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_pit(pit)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   app.model.all_stores.each do |store|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_store(store)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   print_winner if app.ruler.game_over?</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s30.postimg.org/va1jflych/red_pattern.jpg" title="Red Tests" alt="The color red"></p>

<p>The test fails with: <code>wrong number of arguments (1 for 2)</code>. The problem lies in the test setup. I now need to pass in the model when I create the <code>MancalaGameView</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="c1"># Code omitted</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>Ahh, that&rsquo;s better. Now to repeat the process with the <code>ruler</code>. Step one: create the accessor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Steps two and three: replace the method calls to use the accessor instead of reaching through <code>app</code>. Test after each step.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="c1"># Code omitted</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s30.postimg.org/va1jflych/red_pattern.jpg" title="Red Tests" alt="The color red"></p>

<p>It fails, because I&rsquo;m not passing <code>ruler</code> into the test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="c1"># Code omitted</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>That gets me back to green. Now to refactor the <code>print_winner</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def print_winner</span>
</span><span class='line'><span class="c1">#   return &quot;Player one is the winner!&quot; if app.ruler.winner == :player_1</span>
</span><span class='line'><span class="c1">#   return &quot;Player two is the winner!&quot; if app.ruler.winner == :player_2</span>
</span><span class='line'><span class="c1">#   return &quot;Tie Game!&quot; if app.ruler.winner == :tie</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Player one is the winner!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Player two is the winner!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Tie Game!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>Success! That was pretty easy.</p>

<h2>Further Refactoring</h2>

<p>Now that I&rsquo;ve cleaned up the MancalaGameView somewhat, I&rsquo;m going to refactor a few other things. Along the way, I noticed that <code>print_winner</code> is pretty ugly, so I changed it to use a hash lookup instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def print_winner</span>
</span><span class='line'><span class="c1">#   return &quot;Player one is the winner!&quot; if ruler.winner == :player_1</span>
</span><span class='line'><span class="c1">#   return &quot;Player two is the winner!&quot; if ruler.winner == :player_2</span>
</span><span class='line'><span class="c1">#   return &quot;Tie Game!&quot; if ruler.winner == :tie</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>  <span class="n">win_messages</span><span class="o">[</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">win_messages</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:player_1</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:player_2</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:tie</span>      <span class="o">=&gt;</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also decided to use extract method on the loops in <code>draw_all_beads</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def draw_all_beads</span>
</span><span class='line'><span class="c1">#   model.all_pits.each do |pit|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_pit(pit)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   model.all_stores.each do |store|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_store(store)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   print_winner if ruler.game_over?</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="n">draw_pits</span>
</span><span class='line'>  <span class="n">draw_stores</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_pits</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_stores</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s much better. Here&rsquo;s the final result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">draw_pits</span>
</span><span class='line'>    <span class="n">draw_stores</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="n">win_messages</span><span class="o">[</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_pits</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_stores</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">win_messages</span>
</span><span class='line'>    <span class="p">{</span> <span class="ss">:player_1</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:player_2</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:tie</span>      <span class="o">=&gt;</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Remove Middle Man was really easy to use. Maybe it&rsquo;s because I&rsquo;ve heard Franklin harp on the evils of &ldquo;bad touching&rdquo; so much, or maybe it&rsquo;s just that I&rsquo;m violating the Law of Demeter, but I start to feel pretty nervous when I see two dots in my method calls. This was a quick and easy refactor that I&rsquo;m sure I&rsquo;ll use regularly. Since it sets you up for <a href="http://codeulate.com/2013/01/a-criticism-of-dhhs-post-on-dependency-injection/">Dependency Injection</a>, it also opens up the class&rsquo;s possibilities for <a href="http://en.wikipedia.org/wiki/Duck_typing">Duck Typing</a> and easy mocking.</p>

<p>As I continue to code and refactor, Remove Middle Man will be a vital tool in my tool kit.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/01/18/refactoring-3-introduce-named-parameter-and-introduce-class-annotation/">Refactoring 3 - Introduce Named Parameter / Introduce Class Annotation</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-01-18T13:22:00-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been trying to get better at refactoring lately. To do that, I&rsquo;m digging into my old code from the first months of gSchool and applying strategies from <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactoring Ruby</a> by Jay Fields, Shane Harvie, Martin Folwer, and Kent Beck.</p>

<p>Just a couple of days ago I posted about trying out <a href="http://fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/">Replace Method with Method Object</a>. Almost immediately afterwards, I read about two more strategies that seemed like they would fit well with the same refactoring example, so I thought I&rsquo;d give them a try: Introduce Named Parameter and Introduce Class Annotation.</p>

<h2>Introduce Named Parameter</h2>

<p>According to the book, naming your parameters is a good thing to do if you want to improve the readability of a method. Using it prevents the work of having to go searching through dependency objects to figure out what&rsquo;s going on. It works easily with the new <code>BeadDistributor</code> class I created in my last article. Here&rsquo;s that code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compute</span>
</span><span class='line'>    <span class="n">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="n">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">distribute_beads</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads</span>
</span><span class='line'>    <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="n">rules</span><span class="o">.</span><span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">add_bead_to_model</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">next_pit_id</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">find_next_pit_in_model</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="k">if</span> <span class="n">landed_on_players_own_empty_pit?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_players_own_empty_pit?</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">check_if_pit_belongs_to_player</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landing_spot</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">||=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The most important parts here will be the <code>attr_reader</code>s and the <code>initialize</code> method.</p>

<p>Here are the steps for Introduce Named Parameter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Choose the parameters that you want to name. If you are not naming all of the parameters, move the parameters that you want to name to the end of the parameter list.
</span><span class='line'>
</span><span class='line'>2. Test
</span><span class='line'>
</span><span class='line'>3. Replace the parameters in the calling code with name/value pairs.
</span><span class='line'>
</span><span class='line'>4. Replace the parameters with a Hash object in the receiving method. Modify the receiving method to use the new Hash.
</span><span class='line'>
</span><span class='line'>5. Test.
</span></code></pre></td></tr></table></div></figure>


<p>As always, I started with the tests. They were still passing after my last refactoring adventure:</p>

<p><img src="http://s5.postimg.org/iav0trapz/All_green_start.png" title="All Green to Start" alt="A set of passing Ruby tests"></p>

<p>For the purposes of this example, I wanted to make all of the parameters required, so I skipped steps 1 and 2.</p>

<p>Here are the relevant parts of the code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Replace the params in the calling method with key/value pairs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
</span><span class='line'>      <span class="ss">:rules</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:app</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:first_pit_id</span> <span class="o">=&gt;</span> <span class="n">first_pit_id</span><span class="p">,</span>
</span><span class='line'>      <span class="n">player</span> <span class="o">=&gt;</span> <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="n">count</span><span class="p">})</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 4: Modify the params taken into the receiving object to take a hash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:rules</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:first_pit_id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 5: Test.</p>

<p><img src="http://s5.postimg.org/ypoy6bsp3/Failing_after_first_refactor.png" title="Failing After First Refactor" alt="A set of passing Ruby tests"></p>

<p>The test is failing, because I haven&rsquo;t modified it to send a hash instead of the individual params. After fixing this, it passes again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributorTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_compute_returns_the_correct_count</span>
</span><span class='line'>    <span class="n">rules</span> <span class="o">=</span> <span class="no">MancalaKalahRules</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">player</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">distributor</span> <span class="o">=</span> <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
</span><span class='line'>      <span class="ss">:rules</span> <span class="o">=&gt;</span> <span class="n">rules</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:app</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:player</span> <span class="o">=&gt;</span> <span class="n">player</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="n">count</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="mi">9</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">distributor</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s5.postimg.org/6e7zn0y6f/Passing_after_test_fix.png" title="Passing After Test Fix" alt="A set of passing Ruby tests"></p>

<p>At this point, everything&rsquo;s working. But why did I do it? If anything, it just added duplication to what was already there. Here&rsquo;s why: you can combine it with the Introduce Class Annotation strategy to DRY up object initialization.</p>

<h2>Introduce Class Annotation</h2>

<p>Although I&rsquo;ve heard from many developers more experienced than I am that metaprogramming is generally a bad idea, I also get the impression that many of them consider doing it anyway a guilty pleasure, particularly in non-production code.</p>

<p>However you feel about it, gird yourself, because we&rsquo;re heading into a little bit of <code>define_method</code> territory.</p>

<p>I&rsquo;m going to use the same annotation the book gives as an example. It&rsquo;s a way of defining a helper along the lines of <code>attr_reader</code>, <code>attr_writer</code>, and <code>attr_successor</code>. In it, you wrap all of the object initialization code into a neat new method called <code>hash_initializer</code>.</p>

<p>Here are the steps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Decide on the signature of your class annotation. Declare it in the appropriate class.
</span><span class='line'>
</span><span class='line'>2. Convert the original method to a class method. Make the apppropriate changes so that the method works at the class scope.
</span><span class='line'>
</span><span class='line'>3. Test.
</span><span class='line'>
</span><span class='line'>4. Consider using Extract Module on the class method to make the annotation more prominent in your class definition.
</span></code></pre></td></tr></table></div></figure>


<p>Here we go.</p>

<p>Step 1: Declare the new class annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:rules</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:first_pit_id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 2: Convert the method to a class method. I also called the <code>hash_initializer</code> at the top of the <code>BeadDistributor</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hash_initializer</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Test.</p>

<p>All green!</p>

<p><img src="http://s5.postimg.org/lqrqh1xc7/Passing_after_metaprogramming.png" title="Passing After Metaprogramming" alt="A set of passing Ruby tests"></p>

<p>Step 4: Extract the class annotation into a module.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomInitializers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">CustomInitializers</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hash_initializer</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To me, the module you get at the end is like the gift that keeps on giving. Now I have a cool utility modult that I can use in other objects that take a hash of parameters. Right away, I can think of a program where I can use it in at least six classes.</p>

<p>Running the tests once more, everything is still cool.</p>

<p><img src="http://s5.postimg.org/i8fqknwg7/Everything_is_still_cool.png" title="Everything is Still Cool" alt="A set of passing Ruby tests"></p>

<h2>Conclusion</h2>

<p>As I got toward the end of the fifth chapter, Refactoring got pretty deep into some <code>method_missing</code> and <code>define_method</code> metaprogramming madness. While I can&rsquo;t say I&rsquo;m very excited to use these things in my day-to-day refactoring, it&rsquo;s nice to have them there as a reference in case I ever need them. If nothing else, tricks like the ones I tried out here help me think about the relationships between classes in new ways. Next week, I&rsquo;ll try some strategies from the next chapter: &ldquo;Moving Features Between Objects&rdquo;.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/15/getting-started-with-active-job/">Getting Started With Active Job</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/02/wrapping-your-api-in-a-custom-ruby-gem/">Wrapping Your API In A Custom Ruby Gem</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/25/using-services-to-keep-your-rails-controllers-clean-and-dry/">Using Services to Keep Your Rails Controllers Clean and DRY</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/04/looking-for-a-needle-in-a-haystack-with-ack/">Looking For A Needle In A Haystack! (or Using Ack To Improve Your Development Workflow)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/24/angular-js-unit-testing-for-real-though/">AngularJS Unit Testing, For Real Though</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  Ben Lewis <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
