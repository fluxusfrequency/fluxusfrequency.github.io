<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Fluxus Frequency]]></title>
  <link href="http://fluxusfrequency.github.io/atom.xml" rel="self"/>
  <link href="http://fluxusfrequency.github.io/"/>
  <updated>2015-01-29T21:07:00-07:00</updated>
  <id>http://fluxusfrequency.github.io/</id>
  <author>
    <name><![CDATA[Ben Lewis]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    
    <title type="html"><![CDATA[Instances]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2015/01/29/instances/"/>
    
    <updated>2015-01-29T21:05:58-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2015/01/29/instances</id>
    
    <content type="html"><![CDATA[<h1>Instances, Classes, and Modules, Oh My!</h1>

<p>One of the biggest challenges of object oriented programming in Ruby is defining the interface of your objects. In other languages, such as Java, there is an explicit way to define an interface that you must conform to. But in Ruby, it&rsquo;s up to you.</p>

<p>Compounding with this difficulty is the problem of deciding which object should own a method that you want to write. Trying to choose between modules, class methods, instance methods, structs, and lambdas can be overwhelming.</p>

<p>In this post, we&rsquo;ll look at several ways to solve the Exercism <a href="http://exercism.io/nitpick/ruby/leap">Leap Year</a> problem, exploring different levels of method visiblitiy and scope level along the way.</p>

<h2>Leap Year</h2>

<p>If you sign up for <a href="http://exercism.io/">Exercism.io</a> and start solving Ruby problems, one of the first problems you will look at is called Leap Year. The tests guide you to write a solution that has an interface that works like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Year</span><span class="o">.</span><span class="n">leap?</span><span class="p">(</span><span class="mi">1984</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>A leap year is defined as a year that is divisible by four, unless it&rsquo;s also divisible by 100. Apparently, centuries aren&rsquo;t leap years. That is, unless they are centuries that are divisible by 400. So there are three rules for leap years:</p>

<p>1) If it&rsquo;s divisible by 400, it&rsquo;s an exceptional century and is a leap year.
2) If it&rsquo;s divisible by 100, it&rsquo;s a mundane century and in not a leap year.
3) Otherwise, if it&rsquo;s divisible by 4, it&rsquo;s a leap year, otherwise it&rsquo;s not.</p>

<h2>The First Approach: Using Class Methods</h2>

<p>Here&rsquo;s one simple solution to this problem. You can rearrange the booleans in a couple of different ways and it will still work. This is the version I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is nice and compact, but not entirely easy to understand. I&rsquo;m a pretty big fan of self-documenting code, so I used the <a href="http://fluxusfrequency.github.io/blog/2014/01/10/refactoring-1-extract-method/">extract method</a> refactoring pattern to name these three rules.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Class Methods and Privacy</h2>

<p>This is a lot more understandable, in my mind. But there&rsquo;s a problem with this. <code>mundane_leap?</code>, <code>century?</code>, and <code>exceptional_century?</code> are all publicly exposed methods. They really only exist in support of <code>leap?</code>, and I&rsquo;m not sure how reusable they are, with the possible exception of <code>century?</code>. If I write this test, it will pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">test_exceptional_century</span>
</span><span class='line'>    <span class="n">assert</span> <span class="no">Year</span><span class="o">.</span><span class="n">exceptional_century?</span><span class="p">(</span><span class="mi">2400</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I would like to make <code>exceptional_century?</code> private, so that it can&rsquo;t be accessed outside of the <code>Year</code> class. I can try something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, unfortunately, this won&rsquo;t work. The test still passes, becuase the <code>private</code> keyword doesn&rsquo;t work on class methods. Instead, I would have to use <code>private_class_method</code> after my method definition.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">private_class_method</span> <span class="ss">:mundane_leap?</span><span class="p">,</span> <span class="ss">:century?</span><span class="p">,</span> <span class="ss">:exceptional_century?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if I run that last test, it will raise an error.</p>

<h2>All About the Eigenclass</h2>

<p>In my mind, what we&rsquo;ve now done is somewhat better, but there&rsquo;s still a smell here. I&rsquo;ll get to exactly what that is in just a moment, but for now I&rsquo;ll say that it&rsquo;s due to the fact that we&rsquo;ve defined all of these methods on the singleton class, or eigenclass, of <code>Year</code>. If you don&rsquo;t know about eigenclasses, you can read about them <a href="http://madebydna.com/all/code/2011/06/24/eigenclasses-demystified.html">here</a>.</p>

<p>We can define methods on an eigenclass by prepending each method definition with <code>self.</code>, or we can use <code>class &lt;&lt; self</code> or <code>class &lt;&lt; Year</code> and nesting our method definitions inside of that block. Doing it this way makes it possible to use the <code>private</code> keyword, because we&rsquo;re now working at the instance level of scope. If we were to introduce <code>class &lt;&lt; self</code>, then, we could do away with our <code>private_class_method</code> call.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we haven&rsquo;t really changed much here. In my mind, there&rsquo;s still a big smell, which is this. <a href="http://en.wikipedia.org/wiki/Class_%28computer_programming%29">According to Wikipedia</a>, a class is (emphasis mine) &ldquo; an extensible program-code-template for <em>creating objects</em> &rdquo;. Our <code>Year</code> class never creates a single instance. It&rsquo;s just an eigenclass that happens to be able to create (mostly) useless <code>Year</code> instances.</p>

<p>So where <em>should</em> we be putting class-level methods that are not associated with any instance object?</p>

<h2>Second Approach: Module Functions</h2>

<p>In Ruby, the <code>Class</code> object inherits from <code>Module</code>. A module is basically a collection of methods, constants, and classes. Their primary feature is that they can be mixed into other modules and classes to extend their functionality. They&rsquo;re also frequently used for namespacing (for example, the <code>ActiveRecord</code> constant is a module).</p>

<p>We can put our <code>Year</code> implementation into a module without changing much: just swap the word <code>class</code> for <code>module</code>. Instead of using <code>class &lt;&lt; self</code> as we did for the class version, we can use <code>extend self</code> in our module, and get the same effect, allowing us to use the <code>private</code> keyword. <code>extend</code> takes the methods defined in a module and makes them into class-level methods on the target module (or class). This is in contrast with <code>include</code>, which mixes them in as instance-level methods. Thus, if we extend the module into itself, it gets all of it&rsquo;s own methods at the class level.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Year</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we wanted to define some other methods in a <code>Year</code> class that had nothing to do with leap years, we could change the name of our module to <code>Leap</code> and mix it into a <em>class</em> called <code>Year</code>.</p>

<p>If we want to make the three leap year rule methods private, we now have another choice of how to do it. We can use <code>module_function</code>.  <code>module_function</code> will make these methods available to the module, but when they get mixed into the class, they will be private. Module functions allow you to be selective with what can be called by the module itself, while still defining methods that can be mixed into other modules and classes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Leap</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">module_function</span> <span class="ss">:mundane_leap?</span><span class="p">,</span> <span class="ss">:century?</span><span class="p">,</span> <span class="ss">:exceptional_century?</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Year</span><span class="p">;</span> <span class="kp">extend</span> <span class="no">Leap</span><span class="p">;</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we run the tests, they will all still pass, with the exception of the one we wrote that tries to call <code>exceptional_century?</code></p>

<h2>Third Approach: Instance Methods</h2>

<p>I want to stay with the idea that we might want a <code>Year</code> class that can do other things unrelated to determining whether we are talking about leap year or not. Really, there are a bunch of different years, but they all have certain things in common (which era they fall in, whether they are leap, etc.). In my mind, this would be a good use case for instances instead of class level methods.</p>

<p>What it look like if we brought the responsibility for knowing whether a year is leap back into a <code>Year</code> class, but passing that behavior onto <em>instances</em> of year, instead of putting it on the eigenclass?</p>

<p>It&rsquo;s a little weird to be able to do something like <code>Year.new(2015).year</code>, so I&rsquo;ll name the state we&rsquo;re going to store <code>reckoning</code> instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">leap?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:reckoning</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">reckoning</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@reckoning</span> <span class="o">=</span> <span class="n">reckoning</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span>
</span><span class='line'>    <span class="n">mundane_leap?</span> <span class="o">||</span> <span class="n">exceptional_century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The instance-based approach has certain advantages. We don&rsquo;t have to use anything exotic like <code>private_class_method</code>, <code>class &lt;&lt; self</code>, or <code>module_function</code>, to make our methods private. This might make things easier to understand for future maintainers of our code.</p>

<p>We also gained access to the <code>reckoning</code>, that could be used to calculate other properites in the future. For example, if we wanted to write <code>to_julian</code> or <code>to_hebrew</code> methods, we&rsquo;d already have the number we&rsquo;d need to use to calculate that available to us.</p>

<p>Finally, we can now use a <code>protected</code> section as well. Methods in this section will only be visible to other instances of <code>Year</code>. We might use it to do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">recoking</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">reckoning</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>We&rsquo;ve looked at several different ways to write a program that can tell us whether a given year is a leap year. Each has its advantages and disadvantages.</p>

<p>We started with a class method that was a single-liner. There&rsquo;s a lot of value in the compactness of <code>year % 4 == 0 &amp;&amp; !(year % 100 == 0) || year % 400 == 0</code>. But it&rsquo;s also fairly hard to understand. If we decide to split some of that logic into separate methods, now we&rsquo;re faced with the problem of how to keep these new methods out of the interface of <code>Year</code>.</p>

<p>We used an eigenclass-based approach, simply hiding the implementation methods with <code>private_class_method</code>. We solved it using a module, treating the <code>leap?</code> method both as a mix-in and as a <code>module_function</code>. Finally, we pushed the functionality down to the instance level, which could help us in dealing with multiple <code>Year</code> objects down the road.</p>

<p>Which of these approaches is best?</p>

<p>It depends on lots of things: how you feel about privacy, how you expect the program to change in the future, how comfortable you are with scope and the more arcane methods in Ruby.  At the very least, it&rsquo;s nice to know what&rsquo;s available to you when thinking about what methods you want to expose, and what level of scope you should use it on.  I hope this post will factor into your thoughts when making these kind of decisions in the future.</p>

<p>P.S. What do you think? Did this make sense? Should I have used Structs or Lambdas? Throw us a comment below!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Five Ruby Methods You Should Be Using]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2015/01/16/five-ruby-methods-you-should-be-using/"/>
    
    <updated>2015-01-16T06:55:21-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2015/01/16/five-ruby-methods-you-should-be-using</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2015/five-ruby-methods-you-should-be-using">Engine Yard</a>.
It was also the top featured article in <a href="http://rubyweekly.com/issues/229">Ruby Weekly</a>.</p>

<p>There&rsquo;s something magical about the way that Ruby just flows from your fingertips. why once <a href="http://mislav.uniqpath.com/poignant-guide/book/chapter-2.html">said</a> &ldquo;Ruby will teach you to express your ideas through a computer.&rdquo; Maybe that&rsquo;s why Ruby has become such a <a href="http://blog.codeeval.com/codeevalblog/2014">popular choice</a> for modern web development.</p>

<p>Just as in English, there are lots of ways to say the same thing in Ruby. I spend a lot of time reading and nitpicking people&rsquo;s code on <a href="http://exercism.io">Exercism</a>, and I often see exercises solved in a way that could be greatly simplified if the author had only known about a certain Ruby method.</p>

<p>Here&rsquo;s a look at some lesser-used methods solve a specific problem very well.</p>

<h2>Object#tap</h2>

<p>Did you ever find yourself calling a method on some object, and the return value not being what you wanted it to? You were hoping to get back the object, but instead you got back some other value. Maybe you wanted to add an arbitrary value to a set of parameters stored in a hash. You update it with <code>Hash.[]</code>, but you get back <code>'bar</code> instead of the params hash, so you have to return it explicitly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">params</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>  <span class="n">params</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>params</code> line at the end of that method seems extraneous.</p>

<p>We can clean it up with <a href="http://www.ruby-doc.org/core-2.1.5/Object.html#method-i-tap">Object#tap</a>.</p>

<p>It&rsquo;s easy to use. Just call it on the object, then pass <code>tap</code> a block with the code that you wanted to run. The object will be yielded to the block, then be returned. Here&rsquo;s how we could use it to improve <code>update_params</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">params</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are dozens of great places to use <code>Object#tap</code>. Just keep your eyes open for methods called on an object that don&rsquo;t return the object, when you wish that they would.</p>

<h2>Array#bsearch</h2>

<p>I don&rsquo;t know about you, but I do a lot of looking through arrays for data. Ruby enumerables make it easy to find what I need: <code>select</code>, <code>reject</code>, and <code>find</code> are valuable tools that I use daily. But when the dataset is big, I start to worry about the length of time it will take to go through all of those records.</p>

<p>If you&rsquo;re using <code>ActiveRecord</code> and dealing with a <code>SQL</code> database, there&rsquo;s a lot of magic that happens behind the scenes to make sure that your searches are conducted with the least algorithmic complexity. But sometimes you have to pull all of the data out of the database before you can work with it. For example, if the records are encrypted in the database, you can&rsquo;t query them very well with <code>SQL</code>.</p>

<p>At times like these, I think hard about how to sift through the data with an algorithm that has the least complex <em>Big O</em> classification that I can. If you don&rsquo;t know about Big O notation, check out Justin Abrahms&rsquo;s <a href="https://justin.abrah.ms/computer-science/big-o-notation-explained.html">Big-O Notation Explained By A Self-Taught Programmer</a> or the <a href="http://bigocheatsheet.com/">Big-O Complexity Cheat Sheet</a>.</p>

<p>The basic gist is that algorithms can take more or less time, depending on their complexity, which is ranked in this order: O(1), O(log n), O(n), O(n log(n)), O(n<sup>2</sup>), O(2<sup>n</sup>), O(n!). So we prefer searches to be in one of the classifications at the beginning of this list.</p>

<p>When it comes to searching through arrays in Ruby, the first method that comes to mind is <code>Enumerable#find</code>, also known as <code>detect</code>. However, this method will search through the entire list until the match is found. While that&rsquo;s great if the record is at the beginning, it&rsquo;s a problem if the record is at the end of a really long list. It takes O(n) complexity to run a <code>find</code> search.</p>

<p>There is a faster way. Using <a href="http://www.ruby-doc.org/core-2.1.5/Array.html#method-i-bsearch">Array#bsearch</a>, you can find a match with only O(log n) complexity. To find out more about how a Binary Search works, check out my post <a href="http://fluxusfrequency.github.io/blog/2014/01/31/building-a-binary-search/">Building A Binary Search</a>.</p>

<p>Here&rsquo;s a look at the difference in search times between the two approaches when searching a range of 50,000,000 numbers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">50_000_000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="ss">:find</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">40_000_000</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="ss">:bsearch</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="o">.</span><span class="n">bsearch</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">40_000_000</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">user</span>       <span class="nb">system</span>     <span class="n">total</span>       <span class="n">real</span>
</span><span class='line'><span class="n">find</span>     <span class="mi">3</span><span class="o">.</span><span class="mo">020000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">3</span><span class="o">.</span><span class="mo">030000</span>   <span class="p">(</span><span class="mi">3</span><span class="o">.</span><span class="mo">02</span><span class="mi">8417</span><span class="p">)</span>
</span><span class='line'><span class="n">bsearch</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">000006</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>bsearch</code> is much faster. However, there is a pretty big catch involved with using <code>bsearch</code>: the array must be sorted. This somewhat limits its usefulness, but it&rsquo;s still worth keeping in mind for occasions where it might come in handy, such finding a record in by a <code>created_at</code> timestamp that has already been loaded from the database.</p>

<h2>Enumerable#flat_map</h2>

<p>When dealing with relational data, sometimes we need to collect a bunch of unrelated attributes and return them in an array that is not nested. Let&rsquo;s imagine you had a blog application, and you wanted to find the authors of comments left on posts written in the last month by a given set of users.</p>

<p>You might do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">map</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You would then end up with a result such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[[[</span><span class="s1">&#39;Ben&#39;</span><span class="p">,</span> <span class="s1">&#39;Sam&#39;</span><span class="p">,</span> <span class="s1">&#39;David&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;Keith&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="o">[[]</span><span class="p">,</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]]</span><span class="p">,</span> <span class="o">[[</span><span class="s1">&#39;Chris&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[]]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But you just wanted the authors! I guess we can call <code>flatten</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another option would have been to use <code>flat_map</code>.</p>

<p>This just does the flattening as you go:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">flat_map</span> <span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">flat_map</span> <span class="p">{</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s not too much different, but better than having to call <code>flatten</code> a bunch of times.</p>

<h2>Array.new with a Block</h2>

<p>One time, when I was in bootcamp, our teacher Jeff Casimir (founder of <a href="http://turing.io/">Turing School</a>) asked us to build the game Battleship in an hour. It was a great exercise in object-oriented programming. We needed <code>Rule</code>s, <code>Player</code>s, <code>Game</code>s, and <code>Board</code>s.</p>

<p>Creating a represention of a <code>Board</code> is a fun exercise. After several iterations, I found the easiest way to set up an 8x8 grid was to do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Board</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">board</span>
</span><span class='line'>    <span class="vi">@board</span> <span class="o">||=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;0&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s going on here? When you call <a href="http://www.ruby-doc.org/core-2.1.5/Array.html#method-c-new">Array.new</a> with an argument, it creates an array of that length:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [nil, nil, nil, nil, nil, nil, nil, nil]</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you pass it a block, it populates each of its members with the result of evaluating that block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;O&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; [&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So if you pass an array with eight elements a block that produces an array with eight elements that are all <code>'O'</code>, you end up with an 8x8 array populated with <code>'O'</code> strings.</p>

<p>Using the <code>Array#new</code> with a block pattern, you can create all kinds of bizarre arrays with default data and any amount of nesting.</p>

<h2>&lt;=></h2>

<p>The <a href="http://www.ruby-doc.org/core-2.1.5/Object.html#method-i-3C-3D-3E">spaceship</a>, or sort, operator is one of my favorite Ruby constructs. It appears in most of the built-in Ruby classes, and is useful when working with enumerables.</p>

<p>To illustrate how it works, let&rsquo;s look at how it behaves for <code>Fixnums</code>.  If you call <code>5&lt;=&gt;5</code>, it returns <code>0</code>. If you call <code>4&lt;=&gt;5</code>, it returns <code>-1</code>. If you call <code>5&lt;=&gt;4</code>, it returns <code>1</code>. Basically, if the two numbers are the same, it returns <code>0</code>, otherwise it returns <code>-1</code> for least to greatest sorting, and <code>1</code> for reverse sorting.</p>

<p>You can use the spaceship in your own classes by including the <code>comparable</code> module and redefining <code>&lt;=&gt;</code> with logic branching to make it return <code>-1</code>, <code>0</code>, and <code>1</code> for the cases you want.</p>

<p>Why would you ever want to do that?</p>

<p>Here&rsquo;s a cool use of it I came across on Exercism one day. There&rsquo;s an exercise called Clock, where you have to adjust the hours an minutes on a clock using custom <code>+</code> and <code>-</code> methods. It gets complicated when you try to add more than 60 minutes, because that will make your minute value invalid. So you have to adjust by incrementing another hour and subtracting 60 from the minutes.</p>

<p>One user, <code>dalexj</code>, had a brilliant way to solve this, using the spaceship operator:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">fix_minutes</span>
</span><span class='line'>    <span class="k">until</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">member?</span> <span class="n">minutes</span>
</span><span class='line'>      <span class="vi">@hours</span> <span class="o">-=</span> <span class="mi">60</span> <span class="o">&lt;=&gt;</span> <span class="n">minutes</span>
</span><span class='line'>      <span class="vi">@minutes</span> <span class="o">+=</span> <span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="o">&lt;=&gt;</span> <span class="n">minutes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@hours</span> <span class="o">%=</span> <span class="mi">24</span>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It works like this: until the minutes passed in are between 0 and 60, he subtracts either <code>1</code> or <code>-1</code> from the hours, depending on whether the minute amount is greater than 60. He then adjusts the minutes, adding either <code>-60</code> or <code>60</code> depending on the sort order.</p>

<p>The spaceship is great for defining custom sort orders for your objects, and can also come in handy for arithmetic operations if you remember that it returns one of three <code>Fixnum</code> values.</p>

<h2>Wrapping Up</h2>

<p>Getting better at writing code is a process of learning. Since Ruby is a language, a lot of the time I spend trying to improve is spent of reading &ldquo;literature&rdquo; (i.e. code on Exercism andGitHub), and reading (what is essentially) the dictionary for my language: (<a href="http://ruby-doc.org/">Rubydocs</a>.</p>

<p>It&rsquo;s so much easier to write expressive code when you know more methods. I hope that this collection of curiosities helped expand your Ruby vocabulary.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Seven Reasons I Love Minitest]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/12/18/seven-reasons-i-love-minitest/"/>
    
    <updated>2014-12-18T05:36:48-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/12/18/seven-reasons-i-love-minitest</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/seven-reasons-i-love-minitest">Engine Yard</a>.
It was also a featured article in <a href="http://rubyweekly.com/issues/225">Ruby Weekly</a>.</p>

<p>The other day at our company standup, I mentioned that I was eager to read an article on [Concurrency in Minitest] (<a href="http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/">http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/</a>) that was featured in <a href="http://rubyweekly.com/issues/216">Ruby Weekly</a>. One of my coworkers asked: &ldquo;people still use Minitest?&rdquo; My reply: &ldquo;you mean you&rsquo;re not using Minitest yet?&rdquo;</p>

<p>I love Minitest. It&rsquo;s small, lightweight, and ships with Ruby. It&rsquo;s used by respected programmers like <a href="http://rubyrogues.com/001-rr-testing-practices-and-tools/">Aaron Patterson</a>, Katrina Owen, Sandi Metz, and of course, DHH. Here&rsquo;s a look at why Minitest remains a powerful and popular choice for testing Ruby code.</p>

<h2>Witness the Firepower of this Fully Armed and Operational Testing Tool</h2>

<p>Although I come from a <a href="http://fluxusfrequency.github.io/blog/2013/10/03/the-history-of-programming-in-the-life-of-russ-lewis/">family of programmers</a>, I entered the profession by going to a bootcamp.  I was a student in the second <a href="http://www.galvanize.it/school/">gSchool</a> class. At that time, it was being taught by <a href="http://jumpstartlab.com/">Jumpstart Lab</a>.  My instructors were <a href="https://twitter.com/j3">Jeff Casimir</a>, <a href="https://twitter.com/franklinwebber">Franklin Webber</a>, and [Katrina Owen] (<a href="https://twitter.com/kytrinyx">https://twitter.com/kytrinyx</a>).</p>

<p>My classmates and I were brought up with TDD from day one. We practiced it in everything we did. The tool we used was Minitest. When it was first introduced, I scoffed a little because of the name.</p>

<p>&ldquo;Why are we using a &lsquo;mini&rsquo; testing framework?  I want to use what the pros use,&rdquo;
I complained to Katrina.</p>

<p>&ldquo;Minitest is a fully-featured testing framework, and is used in plenty of production apps,&rdquo; was her reply.</p>

<p>I&rsquo;ve been using it ever since. Here are seven reasons I think Minitest is the bees&#8217; knees.</p>

<h2>1. It&rsquo;s Simple</h2>

<p>Minitest ships with Ruby because it&rsquo;s easy to understand, and can be written by anyone who knows the language.  I love this simplicity because it makes it easy to focus on designing code.  Just imagine what you want it to do, and write your assertion, and make it pass.</p>

<p>I recently reached out to Katrina to ask her thoughts on what&rsquo;s good about Minitest. Its simplicity was at the top of her list:</p>

<p>&ldquo;It&rsquo;s simpler. There&rsquo;s no &lsquo;magic&rsquo; (just plain Ruby) [&hellip;] When there is &#8220;magic&rdquo; then it&rsquo;s very easy to assume that you <em>can&rsquo;t</em> understand it [&hellip;] You can read through the [Minitest] source code, and understand what is going on.&#8221;</p>

<p>I also asked Sandi Metz what she thought of Minitest. She said:</p>

<p>&ldquo;Minitest is wonderfully simple and encourages this same simplicity in tests and code.&rdquo;</p>

<p>Minitest is low in sugar. All you need to know is <code>assert</code> for booleans, and <code>assert_equal</code> for everything else. If you want to test a negative case, use <code>refute</code> or <code>refute_equal</code> instead. For everything else, just write Ruby.</p>

<h2>2. It&rsquo;s Extensible</h2>

<p>The relatively &ldquo;low-level&rdquo; status of Minitest makes it easy to customize tests. Katrina observes:</p>

<p>&ldquo;Because Minitest is so simple, it&rsquo;s not too hard to extend. It feels like a tool that I can shape to my needs, rather than a tool that I need to use the way it was intended.&rdquo;</p>

<p>If you want to repeat an assertion in multiple contexts, you can write a custom assertion for it, and call it in as many tests as you need.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Do some additional work here</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;11 MPS&#39;</span><span class="p">,</span> <span class="n">swallow</span><span class="o">.</span><span class="n">speed</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_african</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;African&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_european</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;European&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are testing something that requires nearly the same test to be run repeatedly, for example when testing a controller that has a user authentication <code>before_action</code>, you can create a shared example by <a href="https://canaryup.com/blog/shared-examples-with-minitest">including a module</a>.</p>

<p>If you need even more control, you can create an object with custom behavior that inherits from <code>Minitest::Test</code>, and have your tests inherit from it. Doing so allows you to completely customize your test suite with new methods as you see fit.</p>

<p>Finally, Minitest comes with hooks to help you easily write extensions to the gem. You can define a plugin by adding a <code>minitest/XXX_plugin.rb</code> file to your project folder, and Minitest will automatically find and require it. You can use extensions to define command-line options, custom reporters, and anything else you want Minitest to be able to do.</p>

<h2>3. It&rsquo;s Flat If You Use Assert</h2>

<p>The default syntax for Minitest is <code>assert</code>. Although the BDD <code>expect</code> syntax is available in <a href="https://github.com/seattlerb/minitest/blob/master/lib/minitest/spec.rb">mintest/spec</a>, I recommend giving <code>assert</code> a try. Maybe you love expectations because they read like English, sort of. Although <code>assert</code> doesn&rsquo;t try to imitate natural language, it&rsquo;s actually quite intuitive to use. It also provides the benefit of making your test files flat.</p>

<p>With nested <code>context</code>, <code>describe</code>, and <code>it</code> blocks, it can be difficult to remember what <code>it</code> refers to, and which <code>before</code> blocks are accessible in your scope. I find myself scanning indentation in BDD tests to figure out what scope I&rsquo;m working in.</p>

<p>When you use <code>assert</code> syntax, your test file is flat. You start with a test class, then you write a bunch of test methods inside of it. It&rsquo;s clear that the only variables available are those defined in the <code>setup</code> method or in the test itself. This flatness also means it gets painful quickly if your test is tied to too many dependencies. As Katrina puts it, &ldquo;the lack of nested contexts means that I&rsquo;m faced with the appropriate amount of pain when I make bad choices. It quickly becomes ugly if I have too many dependencies. I like that.&rdquo;</p>

<p>Using <code>assert</code> also makes it easy to document the desired behavior of your code: just name the test method to describe what you are testing. If you&rsquo;re really worried you&rsquo;ll forget what the test was for, you can output a message to the console if the test fails:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">test</span> <span class="s1">&#39;it calculates the air-speed velocity of an unladen swallow&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">wing_span</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="ss">laden</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;European&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;11 MPS&#39;</span>
</span><span class='line'>  <span class="n">actual</span> <span class="o">=</span> <span class="n">swallow</span><span class="o">.</span><span class="n">average_speed</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s1">&#39;The average speed of an unladen</span>
</span><span class='line'><span class="s1">    swallow was incorrect&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Minitest&rsquo;s flatness is also beneficial when it comes to practicing a Test-Driven workflow. You can <code>skip</code> all of the tests in a file easily, without scanning through nested blocks. Then you can make them pass, one at a time.</p>

<h2>4. It Lends Itself to A Good Test-Driven Workflow</h2>

<p>Minitest is awesome for getting into a red/green/refactor loop. Write a test, watch it fail, make it pass, refactor. Repeat. A Minitest file is just a list of tests that are waiting for you to make them pass.</p>

<p>Plus, since you&rsquo;re just writing Ruby, you can use a style like this to get the next test set up with a minimum of effort:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">test</span> <span class="s1">&#39;something&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expected</span> <span class="o">=</span> <span class="c1"># some code</span>
</span><span class='line'>  <span class="n">actual</span> <span class="o">=</span> <span class="c1"># some simple result</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to repeat an assertion in different contexts, you can write a method for it, and call it in as many tests as you want to. Need a <a href="https://canaryup.com/blog/shared-examples-with-minitest">shared example</a>? Include a module.</p>

<h2>5. Minitest::Benchmark is Awesome</h2>

<p>If you are dealing with large amounts of data, and performance is a concern, <a href="https://github.com/seattlerb/minitest/blob/master/lib/minitest/benchmark.rb">Minitest::Benchmark</a> is your new best friend.</p>

<p>It lets you test your algorithms in a repeatable manner, to make sure that their algorithmic efficiency don&rsquo;t accidentally get changed. You can collect benchmarks in &ldquo;tab-separated format, making it easy to paste into a spreadsheet for graphing or further analysis&rdquo;.</p>

<p>Here are a few of the assertions in Minitest::Benchmark that might be of interest:</p>

<ul>
<li><code>assert_performance_constant</code></li>
<li><code>assert_performance_exponential</code></li>
<li><code>assert_performance_logarithmic</code></li>
<li><code>assert_performance_linear</code></li>
</ul>


<h2>6. It&rsquo;s Randomized By Default</h2>

<p>Running the tests in a different order each time can help catch bugs caused by unintended dependencies between examples. Here&rsquo;s how Aaron Patterson described the benefit of randomized tests in an <a href="http://rubyrogues.com/001-rr-testing-practices-and-tools/">episode of Ruby Rogues</a>:</p>

<p>&ldquo;I’m sure you’ve been in a situation where your [&hellip;] test fails in isolation, but when you run [the entire test suite] it works. [T]hat’s typically because one test set up some particular environment that another test depended on. [&hellip;] Since Minitest runs the test in a random order, you can’t make one test depend another, so you’ll see an error case.&rdquo;</p>

<h2>7. It&rsquo;s Faster</h2>

<p>Minitest doesn&rsquo;t create any matchers or example objects that have to be garbage collected. Many people have benchmarked Minitest against other frameworks, and it usually comes out at ahead. Often it&rsquo;s a marginal difference, but sometimes it comes out <a href="http://blog.rawonrails.com/2012/01/very-cursory-test-of-rspec-28-speed.html">significantly ahead</a>.</p>

<p>Minitest also supports concurrent test runs. Although I thought this would lead to great speed gains, it turns out that it <a href="http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/">only makes a difference in JRuby and Rubinius</a>. The Matz Ruby Implementation (MRI) <a href="https://blog.engineyard.com/2010/concurrency-real-and-imagined-in-mri-threads">doesn&rsquo;t get speed gains</a> when using concurrency. Still, it&rsquo;s nice to know that the option is there, in case you are using JRuby or Rubinius, or the MRI changes in the future.</p>

<h2>Have You Tried It?</h2>

<p>I&rsquo;ve talked to a lot of people that are surprised when I say I prefer Minitest. They often ask, &ldquo;why should I switch to Minitest?&rdquo; Perhaps a better question to ask is this one, posed by <a href="https://github.com/metaskills/holy_grail_harness/issues/3">Ken Collins</a>: &ldquo;What is in [other testing frameworks] that you need that Minitest does not offer?&rdquo;</p>

<p>Programming tools are a matter of individual taste. When I&rsquo;ve asked programmers about Minitest, they&rsquo;ve all expressed that they were not <em>against</em> RSpec or other frameworks. Sandi Metz said: &ldquo;I&rsquo;m agnostic about testing frameworks [&hellip;] I also use RSpec and I find it equally useful in it&rsquo;s own way.&rdquo; Katrina Owen said: &ldquo;I don&rsquo;t dislike RSpec, but I do prefer Minitest.&rdquo; In the end, I think most would agree that testing frameworks are a personal choice.</p>

<p>That said, if you haven&rsquo;t used Minitest lately (or ever), why not check it out?  If you&rsquo;re curious, but feel like you still need some convincing, just try it!  It&rsquo;s a small investment. You&rsquo;ll be up and running in a few minutes. Why not go try the first Ruby <a href="http://exercism.io/getting-started">Exercism</a>?</p>

<p>I hope this tour of Minitest&rsquo;s features has been informative, and piqued your interest in this fabulous test framework. Is there anything I missed? Disagree? Let&rsquo;s talk! Please share your point of view in the comments section, or tweet at me at @fluxusfrequency.</p>

<h2>Other Resources</h2>

<p><a href="http://www.slideshare.net/markykang/minitest-2013-0910">A Big Look At Minitest</a>
<br />
An informative slide deck that explores the ins and outs of Minitest.</p>

<p><a href="https://speakerdeck.com/ahawkins/bow-before-minitest">Bow Before Minitest</a>
<br />
A more opinionated slide deck comparing Minitest with other testing
tools.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Caching Asynchronous Queries In Backbone]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/12/09/caching-asynchronous-queries-in-backbone/"/>
    
    <updated>2014-12-09T06:32:04-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/12/09/caching-asynchronous-queries-in-backbone</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/caching-asynchronous-queries-backbone">Engine Yard</a>.</p>

<p>I was working on a <em>Backbone</em> project with Bob Bonifield recently, when we came across a problem. We were building an administration panel to be used internally by a client, and there were a couple of views that needed to display the same information about users in a slightly different way. To prevent unnecessary AJAX calls, we decided to cache the result of <code>Backbone.Model#fetch</code> at two levels of our application.</p>

<p>The result: less network time and a snappier user experience.</p>

<p>Here&rsquo;s how we did it.</p>

<h2>Caching the Controller Call</h2>

<p>We decided to use Brent Ertz&rsquo;s <a href="https://www.npmjs.org/package/backbone-route-control">backbone-route-control</a> package. It makes separation of concerns in the Backbone router easier by splitting the methods associated with each route into controllers.</p>

<p>I&rsquo;ll show how we set up the <code>UsersController</code> to handle the first level of caching. In this example, we&rsquo;ll use <code>backbone-route-control</code>. If you weren&rsquo;t using it, you could accomplish the same thing in the Backbone router.</p>

<p>First, we set up the app view and initialized a new Router as a property of it, passing in the controllers we wanted to use.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Main</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">UsersController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;controllers/users&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">controllers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">users</span><span class="o">:</span> <span class="k">new</span> <span class="nx">UsersController</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we defined the router and set it up to use the UsersController to
handle the appropriate routes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Router</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">BackboneRouteControl</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone-route-control&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">BackboneRouteControl</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;users/:id&#39;</span><span class="o">:</span> <span class="s1">&#39;users#show&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;users/:id/dashboard&#39;</span><span class="o">:</span> <span class="s1">&#39;users#dashboard&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Caching the User at the Controller Level</h2>

<p>After we got the router set up, we defined the UsersController and the appropriate route methods. We needed to wait until the user was loaded before we could generate the DOM, because we needed to display some data about the user.</p>

<p>We opted to cache the ID of the last user that was accessed by either the <code>show</code> or <code>dashboard</code> method, so that we wouldn&rsquo;t repeat the fetch call when we didn&rsquo;t need to. We set the result of the call to <code>Backbone.Model#fetch</code> (a promise) to a variable called <code>userLoadedDeferred</code>, and passed it down the the views themselves.</p>

<p>In doing so, we took advantage of the fact that, behind the scenes, <code>fetch</code> uses <a href="http://api.jquery.com/jquery.ajax/">jQuery.ajax</a> and returns a <a href="http://api.jquery.com/category/deferred-object/">deferred object</a>. When saving the result of a call to <code>jQuery.ajax</code> to variable, the value of the deferred&rsquo;s <code>.complete</code> or <code>.fail</code> callback will always return the same payload after it has been fetched from the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// UsersController</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">UsersController</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">lastUserID</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">userLoadedDeferred</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">user</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">lastUser</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_checkLastUser</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">usersView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserShowView</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">lastUser</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span><span class="o">:</span> <span class="nx">userLoadedDeferred</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">usersView</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dashboard</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_checkLastUser</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">usersView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserDashboardView</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">lastUser</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span><span class="o">:</span> <span class="nx">userLoadedDeferred</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">usersView</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_checkLastUser</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">lastUserId</span> <span class="o">!=</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">lastUserId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">lastUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span> <span class="p">});</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span> <span class="o">=</span> <span class="nx">lastUser</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Caching the User at the Model Level</h2>

<p>Although our <code>UsersController</code> was now caching the result of a fetch for a given user, we soon found that also needed to refetch the user to display their information in a sidebar view as well.</p>

<p>Since the <code>UsersController</code> and the <code>SidebarView</code> were making two separate calls to the <code>User</code> model <code>fetch</code> method, we decided to do some more caching in the Backbone Model. We opted to save the results of the <code>fetch</code> call for 30 seconds, only making a new server request if the timer had expired.</p>

<p>This allowed us to simply call <code>fetch</code> from within the view, without needing to know whether the <code>User</code> model was making an AJAX call or just returning the cached user data.</p>

<p>Here&rsquo;s what the code looked like in the model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// User Model</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// Set the timeout length at 30 seconds.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">FETCH_CACHE_TIMEOUT</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// set a flag to bust the cache if we have ever set it</span>
</span><span class='line'>    <span class="c1">// before, and it&#39;s been more than 30 seconds</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bustCache</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">&lt;</span> <span class="nx">FETCH_CACHE_TIMEOUT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// if we&#39;ve never cached the call to `fetch`, or if we&#39;re busting</span>
</span><span class='line'>    <span class="c1">// the cache, make a note of the current time, hit the server, and</span>
</span><span class='line'>    <span class="c1">// set the cache to this.lastFetchDeferred.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">bustCache</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// return the promise object that was cached</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">User</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Busting the Cache</h2>

<p>Later on in our development, we came across a situation where we needed to force a new fetch of <code>User</code>, right after updating some of their attributes. Because we were caching the result for 30 seconds, the newly updated attributes were not getting pulled from the server on our next fetch call. To overcome this, we neede to bust our cache manually. To make this happen, we changed our overridden <code>fetch</code> method to take an option that allowed us to force a refetch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// User Model</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// check if we passed the forceRefetch flag in the options</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">forceRefetch</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceRefetch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// updated the check to if the flag was passed</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span> <span class="o">||</span> <span class="nx">bustCache</span> <span class="o">||</span> <span class="nx">forceRefetch</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Caching the <code>User</code> model in this app reduced our network time by quite a bit. Initially, we were making <em>two</em> server calls per route, because we had to fetch the user to display data in both the main view and the sidebar. After saving the result of the <code>fetch</code> in the controller, we were now only calling to the server once per User ID.</p>

<p>With the addition of model-level caching, we were also able to remove the duplicated call between the main views and the sidebar view, by saving the results of the <code>fetch</code> call for 30 seconds.</p>

<p>Overall, we reduced four calls per route to one call per 30 seconds. Making these adjustments helped make our application behave a lot more smoothly, and reduced server load in the process.</p>

<p>P.S. Have you implemented anything like this before? What are some of the tricks you use to make Backbone more efficient? Tweet at me @fluxusfrequency.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Building A Ruby List Comprehension]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/11/03/building-a-ruby-list-comprehension/"/>
    
    <updated>2014-11-03T05:40:09-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/11/03/building-a-ruby-list-comprehension</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/ruby-list-comprehension">Engine Yard</a>.
It was also a featured article in <a href="http://rubyweekly.com/issues/221">Ruby Weekly</a>.</p>

<p>As developers, we&rsquo;re in the business of continually bettering ourselves. Part of that process is pushing ourselves to learn and use better code patterns, try new libraries, and pick up new languages. For me, the latest self-learning project has been picking up Python.</p>

<p>As I’ve worked with it, I’ve discovered the joy of <a href="https://docs.python.org/3.5/tutorial/datastructures.html#list-comprehensions">list comprehensions</a>, and I’ve been wondering what it would take to implement a similar syntax in Ruby. I decided to give it a try. This exercise yielded several insights into the inner workings of Ruby, which we&rsquo;ll explore in this post.</p>

<h2>Snake Handling</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/194/asset.gif"></p>

<p>I’m primarily a Rubyist. I’ve always enjoyed the natural way that Ruby flows off the fingers, and heard that Python was similar. It sounded easy enough, especially since <a href="http://www.stavros.io/tutorials/python/">this article</a> promised I could learn Python in ten minutes.</p>

<p>It took a little while to get used to some of the differences in Python, like capitalizing booleans and passing <code>self</code> into all of my methods&ndash;but they were mostly superficial differences. As I solved more and more Python problems on <a href="http://exercism.io/">exercism.io</a>, the syntax began to feel natural.  I felt like everything I wrote in Python had an analog in Ruby. Except list comprehensions.</p>

<h2>You Cannot Grasp The True Form Of Lists</h2>

<p>In Python, Coffeescript, and many functional languages, there is a really cool operation you can do called a <em>list comprehension</em>. It&rsquo;s something like a <code>map</code>, but it&rsquo;s written in mathematical <a href="http://en.wikipedia.org/wiki/Set-builder_notation">set builder notation</a>, which looks like this:</p>

<p>Instead of doing this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(1..100).map { |i| 2 * i if i.even? }</span></code></pre></td></tr></table></div></figure>


<p>You do this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2 * x for x in xrange(1, 100)]</span></code></pre></td></tr></table></div></figure>


<p>You can even nest comprehensions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>return [[print(str(x) for x in y] for 2 * y in xrange(1, 100)]</span></code></pre></td></tr></table></div></figure>


<p>These are so cool, in fact, that I decided to see if I could implement them in Ruby.</p>

<h2>How It Works</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/193/asset.gif"></p>

<p>My first thought in writing a list comprehension in Ruby was to make it look like Python. I wanted to be able to write square brackets with an expression inside of them. To make that happen, I would need to override the <code>main</code> <code>[]()</code> method. It turns out that that method is an alias for the <code>Array#[]</code> <a href="http://www.ruby-doc.org/core-2.1.3/Array.html#method-c-5B-5D">singleton method</a>.  It&rsquo;s not so easy to monkey patch, because you can&rsquo;t really call <code>super</code> on it.</p>

<p>I decided to abandon this approach and create a new method called <code>c()</code>, that I would put in a module and include in <code>main</code>.  Ideally, this method would take a single argument with this syntax: <code>x for x in my_array if x.odd?</code>. Since you can&rsquo;t really pass an expression like this into a method and expect Ruby to parse it properly, I opted to pass it in as a string and parse it. I was into this idea, but not really interested in rewriting the Ruby source code.</p>

<h2>Caught In A Loop</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/192/asset.gif"></p>

<p>My first goal was to get the basic <code>x for x in my_array</code> part working.</p>

<p>I wrote a test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ComprehensionTest &lt; Minitest::Test
</span><span class='line'>  def setup
</span><span class='line'>    extend ListComprehension
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def test_simple_array
</span><span class='line'>    result = c('n for n in [1, 2, 3, 4, 5]')
</span><span class='line'>    assert_equal [1, 2, 3, 4, 5], result
</span><span class='line'>  end
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>This was fairly straightforward to get passing.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module ListComprehension
</span><span class='line'>  def c(comprehension)
</span><span class='line'>    parts = comprehension.split(' ')
</span><span class='line'>    if parts[0] == parts[2]
</span><span class='line'>      eval(comprehension.scan(/\[.*\]/).last)
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>I continued working along, refactoring to have the module instantiate a <code>Comprehension</code> class and evaluate parts of the string:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module ListComprehension
</span><span class='line'>  def c(expression)
</span><span class='line'>    Comprehension.new(expression).comprehend
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class Comprehension
</span><span class='line'>  def initialize(expression)
</span><span class='line'>    @expression = expression
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def comprehend
</span><span class='line'>    # Do some parsing and call `eval` on some stuff
</span><span class='line'>  end
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>But pretty soon, I ran into a problem.</p>

<h2>No Scope</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/191/asset.gif"></p>

<p>When I defined a variable in the test scope, then tried to evaluate it in the <code>comprehension</code> argument string, my Comprehension couldn&rsquo;t access it.</p>

<p>For example, I wrote this test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def test_array_variable
</span><span class='line'>  example = [1, 2, 3, 4, 5]
</span><span class='line'>  result = c ('x for x in example)
</span><span class='line'>  assert_equal [1, 2, 3, 4, 5], result
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>When I tried to call <code>eval</code> on <code>example</code>, I got:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NameError: undefined local variable or method `example' for #&lt;Comprehension:0x007f9cec989fc8&gt;</span></code></pre></td></tr></table></div></figure>


<p>So how could I acceess the scope where <code>example</code> was defined? I did some googling, and discovered that you can access the calling scope a lot more easily from block than a string that you pass into a method.</p>

<p>With that in mind, I changed the interface of <code>Comprehension</code> to take a block instead of a string. To call <code>c()</code>, you would now write <code>c{ 'x for x in example' }</code> instead of <code>c('x for x in example')</code>.</p>

<p>Inside of the <code>Comprehension</code> class, I did:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Comprehension
</span><span class='line'>  def initialize(&block)
</span><span class='line'>    @comprehension = block.call
</span><span class='line'>    @scope = block.send(:binding)
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  ...
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Now I could call <code>eval</code> on the calling scope by doing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def comprehend
</span><span class='line'>  # some parsing
</span><span class='line'>  collection = scope.send(:eval, parts.last)
</span><span class='line'>  # carry out some actions on the collection
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>I had no idea you could access the calling scope like this in Ruby. It opened my eyes to the whole world of accessing callers and callees in a way that I normally don&rsquo;t think about in Ruby.</p>

<h2>You Obviously Worked Hard On These Plans, Kernel Klink</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/190/asset.gif"></p>

<p>I wasn&rsquo;t all that happy with having to define my <code>c()</code> method in a module and include it in the <code>main</code> scope. I really just wanted it to be available automagically if you required <code>comprehension.rb</code>.</p>

<p>After poking around a bit, I found an <a href="http://hopsoft.github.io/blog/ruby-metaprogramming-idioms/">article</a> on metaprogramming that showed me how you can monkey patch <code>Kernel</code> itself.</p>

<p>After changing <code>module ListComprehension</code> to <code>module Kernel</code>, I was able to remove the setup method entirely from my test suite. I didn&rsquo;t realize it was this easy to get methods defined in the <code>main</code> scope. Even though it is probably very wrong in many situations, it&rsquo;s cool to get an understanding of how Ruby itself is put together.</p>

<h2>Lessons Learned</h2>

<p>I set out to write a list comprehension in Ruby, and in a way, I failed.  I was hoping to be able to write an expression inside of square brackets and have Ruby parse it. I ended up settling for a string inside of a block instead.</p>

<p>What&rsquo;s more, my comprehension implementation is lacking several features. It doesn&rsquo;t support method calls in the conditional, so you can&rsquo;t write <code>c{'x for x in (0..10) if Array(x)'}</code>. You can&rsquo;t pass arguments to the conditional either, so you can&rsquo;t do <code>c{'x for x in (1..10) if x.respond_to?(:even?)'}</code>. You can&rsquo;t access an index while you&rsquo;re looping. And perhaps most disappointing of all, you can&rsquo;t nest comprehensions.</p>

<p>But despite these shortcomings, I felt like this exercise was a great success, because I learned three things:</p>

<ol>
<li><p>When you call <code>[]</code> to create an array, you&rsquo;re really calling <code>Array#[]</code>, which delegates to <code>Array#new</code>.</p></li>
<li><p>You can access the calling scope of a block with <code>block.send(:binding)</code>.</p></li>
<li><p>You can monkey patch <code>module Kernel</code> to get methods available in <code>main</code>.</p></li>
</ol>


<p>To the the knowledge gained from this adventure was totally worth it.  Although I did not create a library I would expect people to use, I learned a lot about how Ruby works, and had a great time solving the problem. To check out the full results, please <a href="https://github.com/fluxusfrequency/ruby-comprehension.git">visit my GitHub profile</a>.</p>

<p>P.S. How would you have solved it? Maybe you&rsquo;ve written a natively parsed list comprehension yourself? If so, tweet at me @fluxusfrequency.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Better SOA Development With Foreman and NGINX]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/11/03/better-soa-development-with-foreman-and-nginx/"/>
    
    <updated>2014-11-03T05:40:09-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/11/03/better-soa-development-with-foreman-and-nginx</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/better-soa-development-with-foreman-and-nginx">Engine Yard</a>.
It also appeard on the <a href="http://quickleft.com/blog/better-service-oriented-architecture-project-development-with-scripts-foreman-and-nginx">Quick Left Blog</a>.</p>

<h2>MOAR!</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/165/asset.jpg"/></p>

<p>Everyone knows more is better. More kittens, more money, more apps. Why settle for one Ruby project, when you can have three? We&rsquo;ll take one Rails app for authorization and one to serve an API. Hey, let&rsquo;s throw in a Sinatra proxy server serving up an AngularJS app to while we&rsquo;re at it! Now we&rsquo;re cookin&#8217;!</p>

<p>There are many ways organizations stand to gain by splitting their application into multiple projects running in symphony. If we&rsquo;re being good programmers and following the Single Responsibility Principle (SRP), it makes sense to embrace it at all levels of organization, from our methods and classes up through our project structure. To organize this on the macro level, we can use a Service Oriented Architecture (SOA) approach. In this article, we&rsquo;ll explore some patterns that make it easier to develop SOA apps with a minimum of headaches.</p>

<h2>Service Oriented Architecture</h2>

<p>In the mid-2000s, some programmers began to organize their applications in a new way. Led by enterprise behemoths like Microsoft and IBM, the programming community saw a rise in the use of Web Services: applications that provide data or functionality to others. When you stick a few of these services together, and coordinate them in some kind of client-facing interface, you&rsquo;ve built an application using SOA. The benefits of this approach remain relevant in modern web development:</p>

<ul>
<li>Data storage is encapsulated</li>
<li>You can reuse services between multiple applications (e.g. authentication)</li>
<li>You can monitor messages sent between services for business intelligence</li>
<li>Services are modular, and can be composed into new applications without repetition of common functionality</li>
</ul>


<h2>A Sample Project</h2>

<p>To illustrate some processes that make it easier to develop an SOA project, we&rsquo;ll imagine that we&rsquo;re building a project called <code>Panda</code>, that is composed of three services:</p>

<p>PandaAPI: A RESTful API that serves data about Giant Pandas
PandaAuth: Login page and user authentication service
PandaClient: An AngularJS app sitting atop a Sinatra proxy server</p>

<h2>Setting Up GitHub</h2>

<p>To deal with an SOA project like this, it&rsquo;s helpful to make sure you have everything well-structured on GitHub, so that all developers working on it can get up to speed quickly, and stay in sync with each other. I recommend creating an <a href="https://github.com/organizations/new">organization</a>, and setting up all of the service project repositories under that organization. For Panda, I would start with a structure that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>panda-org (organization)
</span><span class='line'>|- panda-auth (repo)
</span><span class='line'>|- panda-api (repo)
</span><span class='line'>|- panda-client (repo)
</span><span class='line'>|- processes (repo)</span></code></pre></td></tr></table></div></figure>


<p>The first three repos will hold the actual service projects, and the <code>processes</code> repo will hold scripts and processes that are shared between them.</p>

<h2>Git Your S#*&amp; Together</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/168/asset.jpg" /></p>

<p>It can be pretty annoying to have your projects all out of sync. To make it easier to keep things up to date, here&rsquo;s a bash script you can use to pull all of your projects down and update them in one go. Inside of the processes folder, touch a file called <code>git_update.sh</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#git_update.sh</span>
</span><span class='line'>
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">BRANCH</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>: <span class="k">${</span><span class="nv">BRANCH</span><span class="p">:=</span><span class="s2">&quot;master&quot;</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> ../panda-auth   <span class="o">&amp;&amp;</span> git checkout <span class="nv">$BRANCH</span> <span class="o">&amp;&amp;</span> git pull origin <span class="nv">$BRANCH</span>
</span><span class='line'><span class="nb">cd</span> ../panda-api    <span class="o">&amp;&amp;</span> git checkout <span class="nv">$BRANCH</span> <span class="o">&amp;&amp;</span> git pull origin <span class="nv">$BRANCH</span>
</span><span class='line'><span class="nb">cd</span> ../panda-client <span class="o">&amp;&amp;</span> git checkout <span class="nv">$BRANCH</span> <span class="o">&amp;&amp;</span> git pull origin <span class="nv">$BRANCH</span>
</span></code></pre></td></tr></table></div></figure>


<p>When executing this script, you can specify the branch by running <code>sh ./git_update &lt;feature-name&gt;</code>.</p>

<p>We can do something similar for bundling and running migrations.</p>

<p>Create the <code>bundle_and_migrate.sh</code> file.</p>

<p>It should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Load RVM</span>
</span><span class='line'><span class="o">[[</span> -s <span class="s2">&quot;$HOME/.rvm/scripts/rvm&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="s2">&quot;$HOME/.rvm/scripts/rvm&quot;</span> <span class="c"># Load RVM into a shell session *as a function*</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/usr/local/bin:/usr/local/sbin:~/bin:$PATH&quot;</span>
</span><span class='line'><span class="o">[[</span> -s <span class="s2">&quot;$HOME/.rvm/scripts/rvm&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> . <span class="s2">&quot;$HOME/.rvm/scripts/rvm&quot;</span> <span class="c"># Load RVM function</span>
</span><span class='line'>
</span><span class='line'><span class="nb">cd</span> ../panda-auth   <span class="o">&amp;&amp;</span> bundle <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>rake db:migrate
</span><span class='line'><span class="nb">cd</span> ../panda-api    <span class="o">&amp;&amp;</span> bundle <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>rake db:migrate
</span><span class='line'><span class="nb">cd</span> ../panda-client <span class="o">&amp;&amp;</span> bundle <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>rake db:migrate
</span></code></pre></td></tr></table></div></figure>


<p>Now the projects are all updated and ready to go, and we want to begin developing some features. We could write another script to go start <code>rails server</code> in each of our directories, but there is a better way.</p>

<h2>Call In The Foreman</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/166/asset.gif" /></p>

<p>The <a href="https://github.com/ddollar/foreman">foreman gem</a> is my favorite way to manage multiple applications: it runs them all in a single terminal session. It&rsquo;s pretty simple to get set up, and saves you having to run a lot of shell sessions (and a lot of headaches).</p>

<p>First, we&rsquo;ll need to <code>gem install foreman</code>, to make sure we have the global executable available. Then, we&rsquo;ll set up a <code>Procfile</code> to tell it which processes we want it to run. We&rsquo;ll create ours in the <code>processes</code> directory, since that&rsquo;s where we&rsquo;re keeping things that pertain to all of the projects in our SOA app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#Procfile</span>
</span><span class='line'>
</span><span class='line'>auth:     sh -c <span class="s1">&#39;cd ../panda-auth   &amp;&amp; bundle exec rails s -p 3000&#39;</span>
</span><span class='line'>api:       sh -c <span class="s1">&#39;cd ../panda-api    &amp;&amp; bundle exec rails s -p 3001&#39;</span>
</span><span class='line'>client:   sh -c <span class="s1">&#39;cd ../panda-client &amp;&amp; bundle exec rails s -p 3002&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will work great as long as all of your apps are running on the same gemset. If not, you will need to check out the <a href="https://github.com/pitluga/subcontractor">subcontractor gem</a>.</p>

<p>From the <code>processes</code> folder, run <code>foreman start</code>. Sweet. Now everything is all set up. Just open up your browser and navigate to <code>http://localhost:3000</code>. Oh, and pop open two more tabs for <code>http://localhost:3001</code> and <code>http://localhost:3002</code> in them.</p>

<p>Man, wouldn&rsquo;t it be nice if we could just run everything under a single host name?</p>

<h2>NGINX, NGINX #9</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/167/asset.gif" /></p>

<p>To get around the problem of having three different localhosts, we can use <a href="http://nginx.com/">NGINX</a>. If you&rsquo;re not familiar with NGINX, it&rsquo;s an Apache alternative that acts as &ldquo;a web server, a reverse proxy server and an application load balancer&rdquo; (from the official site). We can use it to serve up all three of our apps from the same host, and make things a whole lot easier on ourselves.</p>

<p>To install NGINX, I recommend using <a href="http://brew.sh/">Homebrew</a>. If you have Homebrew, installation is as simple as <code>brew install nginx</code>. If you don&rsquo;t, you can try one of these <a href="http://wiki.nginx.org/Install">alternatives</a>.</p>

<p>Once NGINX is installed, we&rsquo;ll want to locate our <code>nginx.conf</code>. If you installed using Homebrew, it will be located at <code>/usr/local/etc/nginx/nginx.conf</code>. Otherwise, you&rsquo;ll want to use <a href="http://quickleft.com/blog/looking-for-a-needle-in-a-haystack-or-using-ack-to-improve-your-development-workflow">ack</a>, <code>mdfind</code>, or another search tool to locate it.</p>

<p>Once you&rsquo;ve located it, open it in your text editor and locate the <code>server</code> section. Find the block that starts with <code>location /</code> (line 43 for me) and replace it with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#nginx.conf</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>  ...
</span><span class='line'>
</span><span class='line'>  server <span class="o">{</span>
</span><span class='line'>    listen       8080<span class="p">;</span>
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'>    <span class="c"># Client</span>
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>      proxy_pass        http://127.0.0.1:3002<span class="p">;</span>
</span><span class='line'>      proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Auth</span>
</span><span class='line'>    location /auth <span class="o">{</span>
</span><span class='line'>      proxy_pass        http://127.0.0.1:3000<span class="p">;</span>
</span><span class='line'>      proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># API</span>
</span><span class='line'>    location /api <span class="o">{</span>
</span><span class='line'>      proxy_pass        http://127.0.0.1:3001<span class="p">;</span>
</span><span class='line'>      proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  ...
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  ...
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now start NGINX with the <code>nginx</code> command. With these <code>proxy_pass</code> settings in place, we should be able to visit see all of our apps from <code>http://localhost:8080</code>:</p>

<ul>
<li><code>/</code> takes us to the client app</li>
<li><code>/auth</code> takes us to the auth app</li>
<li><code>api</code> takes us to the API app</li>
</ul>


<h2>Dealing With Redirects</h2>

<p>One last tricky part of developing SOA apps is figuring out how to deal with url redirects between our apps. Let&rsquo;s say that you want the client app to redirect users to the auth app if they haven&rsquo;t logged in yet.</p>

<p>You would probably want to start with something like this in the client app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/controllers/application_controller.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:check_user</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">check_user</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="s1">&#39;/auth&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looks good, and it should work locally.</p>

<p> But it could be a problem if some of your apps are served from subdomains in production. Fortunately, there&rsquo;s an easy way to get around this.</p>

<p>Create a <code>config/service_urls.yml</code> file in each project. Inside of it, define the url for each app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/service_urls.yml</span>
</span><span class='line'>
</span><span class='line'><span class="ss">defaults</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">defaults</span>
</span><span class='line'>  <span class="n">service</span><span class="o">-</span><span class="ss">urls</span><span class="p">:</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">api</span><span class="p">:</span> <span class="s1">&#39;localhost:8080/api&#39;</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">auth</span><span class="p">:</span> <span class="s1">&#39;localhost:8080/auth&#39;</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">client</span><span class="p">:</span> <span class="s1">&#39;localhost:8080&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">defaults</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">defaults</span>
</span><span class='line'>
</span><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'>  <span class="n">service</span><span class="o">-</span><span class="ss">urls</span><span class="p">:</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">api</span><span class="p">:</span> <span class="s1">&#39;TBD&#39;</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">auth</span><span class="p">:</span> <span class="s1">&#39;TBD&#39;</span>
</span><span class='line'>    <span class="n">panda</span><span class="o">-</span><span class="ss">client</span><span class="p">:</span> <span class="s1">&#39;TBD&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need to register this configuration file in <code>config/application.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">PandaClient</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="c1"># In Rails 4.2, you can use:</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="n">config_for</span><span class="p">(</span><span class="ss">:service_urls</span><span class="p">)</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># For older Rails versions, use:</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;service_urls.yml&#39;</span><span class="p">))</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this configuration in place, we can now update the url redirect to look like the following, and it will work in all environments.</p>

<p>That will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/controllers/application_controller.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">check_user</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">auth_url</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">auth_url</span>
</span><span class='line'>    <span class="vi">@auth_url</span> <span class="o">||=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">urls</span><span class="o">[</span><span class="s1">&#39;service-urls&#39;</span><span class="o">][</span><span class="s1">&#39;panda-auth&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With these changes in place, our applications will now redirect to the appropriate url in all environments.</p>

<h2>All Your App Are Belong To Us</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/169/asset.jpg" /></p>

<p>By now, you sould have a better idea of what it takes to develop an application using SOA principals. We’ve taken a look at using shell scripts to keep our files in sync, foreman to run several servers at once, and NGINX to pull everything together into a single host address that makes it easier to work with all our services in the browser.</p>

<p>Juggling several services can be pretty confusing, but if you start with the right set up, it makes things a lot easier. All your apps will be under control if you manage them from a central place, and using the strategies discussed in this article should help make the process less painful. Good luck!</p>

<p>P.S. What tricks do you use when you’re developing SOA apps? Did I leave anything out? If you think so, tweet at me @fluxusfrequency.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Getting Started With Active Job]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/10/15/getting-started-with-active-job/"/>
    
    <updated>2014-10-15T06:40:09-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/10/15/getting-started-with-active-job</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/getting-started-with-active-job">Engine Yard</a>.
It was also a featured article in <a href="http://rubyweekly.com/issues/215">Ruby Weekly</a>.</p>

<p>With the <a href="http://edgeguides.rubyonrails.org/4_2_release_notes.html">announcement of Rails 4.2</a> came some exciting <a href="news:">news:</a> Rails now has built-in support for executing jobs in the background using <a href="https://github.com/rails/rails/tree/master/activejob">Active Job</a>. The ability to schedule newsletters, follow-up emails, and database housekeeping tasks is vital to almost any production application. In the past, developers had to hand-roll this functionality, and configuration varied between different queueing services. With the release of Rails 4.2, setting up jobs to be executed by workers at a later time is standardized. In this article, we&rsquo;ll take a look at how to set up Active Job and use it to send a follow-up email to a new user.</p>

<h2>Updating Rails</h2>

<p>You&rsquo;ll need Rails 4.2.0beta1 or greater if you want to Active Job available by default (in older versions of Rails, you can require it as a gem). This tutorial is based on Rails 4.2.0beta2 (edge Rails). If you want to use edge Rails, use <code>gem 'rails', github: 'rails/rails'</code> in your <code>Gemfile</code>, and run <code>bundle update</code>.</p>

<h2>Setting Up Resque</h2>

<p>In order to send emails outside of our main application process, we&rsquo;ll need to make use of a queueing system. There are many choices of technology for setting up background workers available, and Active Job abstracts the differences between them. Today we&rsquo;ll use Resque, as it&rsquo;s widely-used and stable.</p>

<p>To use Resque, you&rsquo;ll need to make sure you have <a href="http://redis.io/">Redis</a> installed. If you don&rsquo;t, I recommend getting it with <a href="http://brew.sh/">Homebrew</a>. Otherwise, you can follow the <a href="http://redis.io/download">instructions for download</a> from the official site. Once it&rsquo;s set up, make sure <code>redis-server</code> is running.</p>

<p>The next step is to install and configure the Resque gem. We&rsquo;ll also need <code>resque-scheduler</code> to use ActiveJob. Add them the <code>Gemfile</code> with <code>gem 'resque'</code> and <code>gem 'resque-scheduler'</code> and <code>bundle install</code>. We&rsquo;ll also need to create a Resque configuration file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/initializers/resque.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">Resque</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:url</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://localhost:6379&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Resque</span><span class="o">.</span><span class="n">after_fork</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also require the Resque and Resque Scheduler rake tasks, so we can start our workers and scheduler with rake:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/tasks/resque.rake</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;resque/tasks&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;resque/scheduler/tasks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:resque</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:setup</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque-scheduler&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now start a worker with <code>QUEUE=* rake environment resque:work</code>. If everything&rsquo;s working right, we should be able to see it in the Resque console. Run <code>resque-web</code> and visit <code>http://0.0.0.0:5678/overview</code>. If you see &ldquo;0 of 1 Workers Working&rdquo;, all&rsquo;s well. We&rsquo;ll also need to boot up the scheduler in a separate process with <code>rake environment resque:scheduler</code>.</p>

<h2>Creating the Mailer</h2>

<p>Now that we have a worker, we need it an email to send. Let&rsquo;s imagine that we want to send a follow up email to a user that recently registered for our site. We&rsquo;ll create a <code>UserMailer</code>, with a <code>follow_up_email</code> method that takes an email address.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/mailers/user_mailer.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s1">&#39;noreturn@example.com&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">follow_up_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mail</span><span class="p">(</span>
</span><span class='line'>      <span class="ss">to</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">subject</span><span class="p">:</span> <span class="s1">&#39;We hope you are enjoying our app&#39;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need to write a follow-up email template.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/views/user_mailer/follow_up_email.text</span>
</span><span class='line'>
</span><span class='line'><span class="no">Hey</span><span class="p">,</span> <span class="n">we</span> <span class="n">saw</span> <span class="n">that</span> <span class="n">you</span> <span class="n">recently</span> <span class="n">signed</span> <span class="n">up</span> <span class="k">for</span> <span class="n">our</span> <span class="n">app</span><span class="o">.</span>
</span><span class='line'><span class="no">We</span> <span class="n">hope</span> <span class="n">you</span><span class="err">&#39;</span><span class="n">re</span> <span class="n">enjoying</span> <span class="n">it!</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Job</h2>

<p>Now that we have a working mailer, we can set up Active Job. All we really need to do is configure it to use the Resque adapter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/initializers/active_job.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">queue_adapter</span> <span class="o">=</span> <span class="ss">:resque</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we&rsquo;ll create a job that tells the background worker to send the email. The conventions for a <code>job</code> include: giving it a <code>queue_as</code>, and defining a <code>perform</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/jobs/follow_up_email_job.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FollowUpEmailJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">queue_as</span> <span class="ss">:email</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">follow_up_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when a user signs up, we can have the <code>UsersController</code> enqueue the job for execution at a later time. Although you would probably delay the job a few days in a real application, we&rsquo;ll just wait 10 seconds for easier testing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/controllers/users_controller.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span><span class='line'>    <span class="no">FollowUpEmailJob</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="ss">wait</span><span class="p">:</span> <span class="mi">10</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># redirect somewhere</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make this work, we&rsquo;ll need some routes and a view template:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/routes.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">#app/views/users/new.html.erb</span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setting Up Mailcatcher</h2>

<p>Before we try our job, we&rsquo;ll want to make sure we can intercept the emails we&rsquo;re expecting the mailer to send. To achieve this, we&rsquo;ll use the <code>mailcatcher</code> gem. Do a global install with <code>gem install mailcatcher</code>, and run <code>mailcatcher</code>. Once we configure Action Mailer to send the emails to <code>localhost:1025</code> via smtp, we&rsquo;ll be able to view intercepted emails at <code>http://127.0.0.1:1080</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/environments/development.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:address</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">1025</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Trying It Out</h2>

<p>Now everything is set up. To try it out, we&rsquo;ll sign up as a new user and watch the job get enqueued in the queue, then catch the mail in Mailcatcher. At this point, we have four processes running:</p>

<ul>
<li><code>mailcatcher</code></li>
<li><code>QUEUE=* rake environment resque:work</code></li>
<li><code>rake environment resque:scheduler</code></li>
<li><code>rails server</code></li>
</ul>


<p>In your browser, view the Resque dashboard at <code>http:/http://0.0.0.0:5678</code>. In another tab, visit <code>http://127.0.0.1:1080</code> to see the Mailcatcher dashboard.</p>

<p>Now, for the moment of truth. Visit <code>localhost:3000/users/new</code> and sign up as a new user. Ten seconds later, a new job will appear in the <code>emails</code> queue of the Resque dashboard. Just afterward, the email will appear in Mailcatcher.</p>

<h2>Using Acive Job with Action Mailer</h2>

<p>The pattern we&rsquo;ve written here woks for scheduling any job. But, since ActiveJob is now baked into ActionMailer, we can also schedule the job directly with the <code>UserMailer</code> in the <code>UsersController</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/controllers/users_controller.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">follow_up_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_later!</span><span class="p">(</span><span class="ss">wait</span><span class="p">:</span> <span class="mi">10</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Active Job makes scheduling background jobs easier. It&rsquo;s also a great way to set up your job infrastructure without knowing too much about what queueing system you&rsquo;re using. If you needed to switch to <a href="https://github.com/mperham/sidekiq">Sidekiq</a> or <a href="https://github.com/collectiveidea/delayed_job">Delayed Job</a> in the future, it would be as simple as setting ActiveJob to the appropriate adapter.</p>

<p>It can be a little bit tricky to get Active Job set up correctly. Hopefully, this tutorial made the process a little more transparent for you.</p>

<p>Until next time,</p>

<p>Happy hacking!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Wrapping Your API In A Custom Ruby Gem]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/10/02/wrapping-your-api-in-a-custom-ruby-gem/"/>
    
    <updated>2014-10-02T07:03:19-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/10/02/wrapping-your-api-in-a-custom-ruby-gem</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/wrapping-your-api-in-a-ruby-gem">Engine Yard</a>.</p>

<h2>Introduction</h2>

<p>In the modern web, API-based projects are becoming the norm. Why? For one thing, APIs are necessary to serve Single Page Applications, which are all the rage right now. From a business standpoint, APIs give companies a new way to charge others for access to their data. If you are part of a company that offers such a service, a great way to generate interest in your API is to offer a Ruby gem that makes fetching and consuming your data easy for Ruby developers.</p>

<p>Today, we&rsquo;ll take a look at how to wrap an imaginary API in a new Ruby gem and share it with the world. If you want to follow along at home, you can <a href="https://github.com/fluxusfrequency/benzinator">clone the project from my GitHub account</a>.</p>

<h2>Our API</h2>

<p>Let&rsquo;s pretend we have an application called Ben&rsquo;s Benzes that serves data about cars for sale. We&rsquo;re exposing a RESTful API so that developers from other companies can serve our car data on their websites. For our first iteration, here are the routes we&rsquo;ve set up:</p>

<p>Get info about a certain car currently for sale:
<code>GET http://www.bensbenzes.com/api/v1/cars/active/:id</code></p>

<p>Get all the cars that are currently for sale:
<code>GET http://www.bensbenzes.com/api/v1/cars/active</code></p>

<h2>Setting Up the Gem</h2>

<p>We&rsquo;ll be using <a href="http://bundler.io/">bundler</a>, so begin by making sure you have that installed (you probably do). We&rsquo;ll create the gem by running <code>bundle gem &lt;gem-name&gt;</code> from the command line. I&rsquo;m going to use <code>benzinator</code> as the name of my gem. That name is now taken, so you&rsquo;ll have to come up with your own. Open up the project directory and you should see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── Gemfile
</span><span class='line'>├── LICENSE.txt
</span><span class='line'>├── README.md
</span><span class='line'>├── Rakefile
</span><span class='line'>├── benzinator.gemspec
</span><span class='line'>└── lib
</span><span class='line'>    ├── benzinator
</span><span class='line'>    │   └── version.rb
</span><span class='line'>    └── benzinator.rb</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s open up <code>benzinator.gemspec</code> and do a little configuration. Update the following lines with your name, email and a summary and description of the gem.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Ben Lewis&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">email</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;blewis@example.com&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">summary</span>       <span class="o">=</span> <span class="sx">%q{Gem to wrap BensBenzes.com API}</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">description</span>   <span class="o">=</span> <span class="sx">%q{Gem to wrap BensBenzes.com API}</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>While we&rsquo;re in here, let&rsquo;s add the dependencies we&rsquo;ll be using, right after <code>bundler</code> and <code>rake</code>. We&rsquo;ll add testing tools as development dependencies, as well as hard dependencies on <a href="https://github.com/lostisland/faraday">Faraday</a> and <a href="http://www.ruby-doc.org/stdlib-2.1.2/libdoc/json/rdoc/JSON.html">json</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;minitest&quot;</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;vcr&quot;</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;webmock&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s2">&quot;faraday&quot;</span>
</span><span class='line'><span class="n">spec</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s2">&quot;json&quot;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Writing a Test</h2>

<p>We&rsquo;ll need to make a <code>test</code> folder, and put a <code>test_helper.rb</code> into it. We&rsquo;ll use the helper to pull in our gem and testing dependencies. We&rsquo;ll also configure <a href="https://github.com/vcr/vcr">VCR</a> and <a href="https://github.com/bblimke/webmock">Webmock</a>, which we&rsquo;re using to stub out our server responses so that our gem isn&rsquo;t dependent on access to the API for testing. See the VCR documentation for more about how this works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#test/test_helper.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./lib/benzinator&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;webmock/minitest&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;vcr&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">VCR</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">cassette_library_dir</span> <span class="o">=</span> <span class="s2">&quot;test/fixtures&quot;</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">hook_into</span> <span class="ss">:webmock</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don&rsquo;t forget to create the <code>test/fixtures</code> folder so VCR has somewhere to put the fixtures. With that done, we&rsquo;ll write the first test for our gem. Our goal is to create an object called Benzinator::Car that exposes <code>#all</code> and <code>#find</code> methods to wrap calls to our API. Let&rsquo;s start by making sure that object exists:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#test/car/car_test.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./test/test_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BenzinatorCarTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_exists</span>
</span><span class='line'>    <span class="n">assert</span> <span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating The Wrapper Model</h2>

<p>If we now run <code>ruby test/car/car_test.rb</code>, we get this error: <code>uninitialized constant Benzinator::Car</code>. Looks like it&rsquo;s time to write some code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/benzinator/car.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Benzinator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need to require it in <code>lib/benzinator.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">require_relative</span> <span class="s2">&quot;benzinator/version&quot;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s2">&quot;benzinator/car&quot;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if we run the test, it passes. Let&rsquo;s write another one to make sure that our <code>Benzinator::Car</code> model can give back the data for a car. Let&rsquo;s imagine that an API call to <code>http://www.bensbenzes.com/api/v1/cars/active/68</code> returns this JSON object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;{</span>
</span><span class='line'><span class="s2">  \&quot;id\&quot;: 68,</span>
</span><span class='line'><span class="s2">  \&quot;make\&quot;: \&quot;Honda\&quot;,</span>
</span><span class='line'><span class="s2">  \&quot;model\&quot;: \&quot;Civic\&quot;,</span>
</span><span class='line'><span class="s2">  \&quot;year\&quot;: \&quot;1996\&quot;,</span>
</span><span class='line'><span class="s2">  \&quot;color\&quot;: \&quot;Blue\&quot;,</span>
</span><span class='line'><span class="s2">  \&quot;vin\&quot;: \&quot;XXXXXXXXXXXXXX\&quot;,</span>
</span><span class='line'><span class="s2">  \&quot;dealer_id\&quot;: 34</span>
</span><span class='line'><span class="s2">}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll want to make sure that our Benzinator::Car object has getter convenience methods all of the fields shown for each car.
Given these API results, we could write a test like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#test/car/car_test.rb</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_gives_back_a_single_car</span>
</span><span class='line'>    <span class="no">VCR</span><span class="o">.</span><span class="n">use_cassette</span><span class="p">(</span><span class="s1">&#39;one_car&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">car</span> <span class="o">=</span> <span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">68</span><span class="p">)</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Check that the fields are accessible by our model</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="mi">68</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="s2">&quot;Honda&quot;</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">make</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="s2">&quot;Civic&quot;</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">model</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="s2">&quot;1996&quot;</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">year</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="s2">&quot;Blue&quot;</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">color</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="s2">&quot;XXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">vin</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="mi">34</span><span class="p">,</span> <span class="n">car</span><span class="o">.</span><span class="n">dealer_id</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this test, we get <code>undefined method 'find' for Benzinator::Car:Class</code>. Let&rsquo;s go define it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/benzinator/car.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;faraday&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">API_URL</span> <span class="o">=</span> <span class="s2">&quot;http://www.bensbenzes.com/api/v1/cars/active&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Benzinator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="no">Faraday</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">API_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">attributes</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the test says we forgot to make it a Benzinator::Car model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Expected</span><span class="p">:</span> <span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span>
</span><span class='line'><span class="ss">Actual</span><span class="p">:</span> <span class="no">Hash</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can fix that, and make the attributes into getters at the same time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/benzinator/car.rb</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Benzinator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:make</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">:color</span><span class="p">,</span> <span class="ss">:vin</span><span class="p">,</span> <span class="ss">:dealer_id</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@id</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@make</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;make&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@model</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;model&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@year</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;year&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@color</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;color&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@vin</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;vin&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@dealer_id</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;dealer_id&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="kp">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That should take care of it. Now to test the <code>#all</code> method.</p>

<p>Let&rsquo;s imagine that a call to <code>http://www.bensbenzes.com/api/v1/cars/active</code> responds with an array of 64 cars, with this Honda being the first one. We can rely on the API call giving back 64 cars today, but we hope there will be 6000 listed tomorrow. This is why we&rsquo;re using VCR to save the result of the call as a fixture.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#test/car/car_test.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">BenzinatorCarTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_gives_back_all_the_cars</span>
</span><span class='line'>    <span class="no">VCR</span><span class="o">.</span><span class="n">use_cassette</span><span class="p">(</span><span class="s1">&#39;all_cars&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Make sure we got all the cars</span>
</span><span class='line'>      <span class="n">assert_equal</span> <span class="mi">64</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Make sure that the JSON was parsed</span>
</span><span class='line'>      <span class="n">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span>
</span><span class='line'>      <span class="n">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Benzinator</span><span class="o">::</span><span class="no">Car</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this, we get <code>undefined method 'all' for Benzinator::Car:Class</code>. Let&rsquo;s define it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/benzinator/car.rb</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Benzinator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="no">Faraday</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">API_URL</span><span class="p">)</span>
</span><span class='line'>      <span class="n">cars</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>      <span class="n">cars</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span> <span class="kp">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sweet success! The tests pass!</p>

<h2>Publishing and Using Our Gem</h2>

<p>Now that our gem works, we can publish it to <a href="https://rubygems.org">RubyGems</a>. This is a pretty easy process. First, we&rsquo;ll bump the version to 1.0:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/benzinator/version.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Benzinator</span>
</span><span class='line'>  <span class="no">VERSION</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can bundle it up by running <code>gem build benzinator.gemspec</code>. This will create a <code>benzinator-0.1.0.gem</code> file in our project directory. To publish it , all we have to do is run <code>gem push benzinator-0.1.0.gem</code>. You&rsquo;ll be prompted for your RubyGems username and password, which you&rsquo;ll need to <a href="https://rubygems.org/sign_up">create</a> if you don&rsquo;t have an account yet. After you enter your credentials, your gem is live!</p>

<p>Now anyone can use our gem in their Ruby projects. All they have to do is add it to their Gemfile with <code>gem 'benzinator'</code>, and run bundle.</p>

<h2>Conclusion</h2>

<p>Winning! Now the whole wide world can access the Ben&rsquo;s Benzes API from their Ruby project, with convenience methods to make things easier to work with.</p>

<p>For our next iteration, we could get a lot more in depth. We might want to add the ability to create, edit or destroy cars. If we decided to that, we might first build sort of authentication process into the gem. Once users have gotten a taste of our data and rely on it, our API might get so popular that we need to limit the number of API calls a user can make per day. We could then write subscription service to allow users greater access to your data at a cost.</p>

<p>One last note: you might want to use this technique to wrap someone else&rsquo;s API, too! If you&rsquo;re using a service that doesn&rsquo;t offer a gem for its API, you can always write one and release it as open source!</p>

<p>Happy hacking!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Using Services to Keep Your Rails Controllers Clean and DRY]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/09/25/using-services-to-keep-your-rails-controllers-clean-and-dry/"/>
    
    <updated>2014-09-25T07:02:57-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/09/25/using-services-to-keep-your-rails-controllers-clean-and-dry</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on <a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">Engine Yard</a>.</p>

<p>It also appeared in <a href="http://rubyweekly.com/issues/214">Ruby Weekly</a>.</p>

<h1>Using Services to Keep Your Rails Controllers Clean and DRY</h1>

<p>We&rsquo;ve heard it again and again, like a nagging schoolmaster: keep your Rails controllers skinny. Yeah, yeah, we know. But easier said than done, sometimes. Things get complex. We need to talk to some other parts of our codebase or to external APIs to get the job done. Mailers. Stripe. External APIs. All that code starts to add up.</p>

<h2>Ah Tss Push It&hellip;Push It Down the Stack</h2>

<p>If we ask: &ldquo;where, pray tell, should this code live?&rdquo;, the answer comes like a resounding chorus: &ldquo;push it down to the model layer!&rdquo;</p>

<p>But what if we want to keep our models simple? They should actually reflect the business objects related to our app, according to <a href="http://quickleft.com/blog/engineering-lunch-series-building-complex-domains-in-rails">Domain Driven Design</a> and other approaches.</p>

<p>Time to get custom!</p>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/158/asset.gif"/></p>

<p>Crack open the old <code>app</code> folder. What do you see? The usual fare? Guess what?  Just because Rails comes with six folders doesn&rsquo;t mean we&rsquo;re restricted to six types of object. Let&rsquo;s make some new folders!</p>

<h2>At Your Service</h2>

<p>I like to create various kinds of service objects in my Rails app. Tom Pewiński&rsquo;s <a href="https://netguru.co/blog/service-objects-in-rails-will-help">recent article</a> in <a href="http://rubyweekly.com/">Ruby Weekly</a> does a great job of covering how to write service objects that help complete an action, like <code>create_invoice</code> or <code>register_user</code>. While he puts all of his service objects into a single <code>services</code> folder, I like to get a little more granular. I&rsquo;ll typically create an <code>actions</code> folder for things like <code>create_invoice</code>, and folders for other service objects such as <code>decorators</code>, <code>policies</code>, and <code>support</code>. I also use a <code>services</code> folder, but I reserve it for service objects that talk to <em>external</em> entities, like Stripe, AWS, or geolocation services.</p>

<p>Here&rsquo;s how the app folder might look with all of these subfolders in it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app
</span><span class='line'>|- actions
</span><span class='line'>|- assets
</span><span class='line'>|- controllers
</span><span class='line'>|- decorators
</span><span class='line'>|- models
</span><span class='line'>|- policies
</span><span class='line'>|- services
</span><span class='line'>|- support
</span><span class='line'>|- views
</span></code></pre></td></tr></table></div></figure>


<h2>Earning Our Stripes</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/159/asset.jpg"/></p>

<p>Let&rsquo;s give it a try, right now! We&rsquo;ll make a credit card service that uses the <a href="https://stripe.com/">Stripe</a> gem.</p>

<p>We&rsquo;ll create an <code>app/services</code> folder and touch a <code>credit_card_service.rb</code> inside of it. It&rsquo;s going to be a Plain Old Ruby Object™ (PORO).</p>

<p>It&rsquo;s probably a good idea to wrap the calls to the Stripe gem in local methods like <code>external_customer_service</code> and <code>external_charge_service</code>, in case we ever want to switch over to Braintree or something else. On object initialization, we&rsquo;ll use dependency injection to accept charge amounts, card tokens, and emails. Our service will expose <code>charge!</code> and <code>create_customer!</code> methods to hook our controllers into.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/services/credit_card_service.rb</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;stripe&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CreditCardService</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@card</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:card</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@amount</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:amount</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@email</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">charge</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="c1"># This will return a Stripe::Charge object</span>
</span><span class='line'>      <span class="n">external_charge_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">charge_attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_customer</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="c1"># This will return a Stripe::Customer object</span>
</span><span class='line'>      <span class="n">external_customer_service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:card</span><span class="p">,</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">:email</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">external_charge_service</span>
</span><span class='line'>    <span class="no">Stripe</span><span class="o">::</span><span class="no">Charge</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">external_customer_service</span>
</span><span class='line'>    <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">charge_attributes</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="ss">amount</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">card</span><span class="p">:</span> <span class="n">card</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">customer_attributes</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">card</span><span class="p">:</span> <span class="n">card</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hook it Up</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/160/asset.jpg"></p>

<p>Now we can write some clean, easily maintainable controller code. We keep the registration logic private, and if we ever want to change it, the controller doesn&rsquo;t have to know anything about it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/controllers/users_controller.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">registration</span> <span class="o">=</span> <span class="n">register_with_credit_card_service</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">registration</span>
</span><span class='line'>      <span class="c1"># Save the id from the Stripe::Customer object</span>
</span><span class='line'>      <span class="n">add_customer_id_to_user</span><span class="p">(</span><span class="n">registration</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">register_with_credit_card_service</span>
</span><span class='line'>    <span class="no">CreditCardService</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
</span><span class='line'>      <span class="ss">card</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:stripe_token</span><span class="o">]</span>
</span><span class='line'>      <span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>    <span class="p">})</span><span class="o">.</span><span class="n">create_customer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_customer_id_to_user</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">external_customer_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test It Out</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/161/asset.jpg"></p>

<p>Since we&rsquo;re just using a PORO, this should be nice and easy to test. Let&rsquo;s make a <code>test/services</code> folder. If you want to add its contents to your rake tasks, <a href="http://stackoverflow.com/questions/18894060/rails-and-minitest-add-additional-folder">try this</a>. Let&rsquo;s assume that we already have a <code>test_helper.rb</code> that includes the Rails helpers in ActiveSupport::TestCase and <a href="https://github.com/freerange/mocha">mocha</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># test/services/credit_card_service_test.rb</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CreditCardServiceTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>  <span class="nb">test</span> <span class="s1">&#39;it creates charges&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">amount</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">card</span><span class="p">:</span> <span class="s1">&#39;TOKEN&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="no">Stripe</span><span class="o">::</span><span class="no">Charge</span><span class="o">.</span><span class="n">expects</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># This will return false if it fails</span>
</span><span class='line'>    <span class="n">charge</span> <span class="o">=</span> <span class="no">CreditCardService</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">charge</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">charge</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">test</span> <span class="s1">&#39;it creates customers&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;test@example.card&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">card</span><span class="p">:</span> <span class="s1">&#39;TOKEN&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span><span class="o">.</span><span class="n">expects</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># This will return false if it fails</span>
</span><span class='line'>    <span class="n">customer</span> <span class="o">=</span> <span class="no">CreditCardService</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">create_customer</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">customer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Keep It Clean</h2>

<p>The last thing you want in your Rails app is a bunch of complicated controllers that are hard to change. Though it may sound pedantic, those voices chanting &ldquo;Skinny Controller, Fat Model&rdquo; are right. It&rsquo;s easy to get caught in the trap of answering &ldquo;where should I put this code&rdquo; with &ldquo;let&rsquo;s open the <code>app</code> folder and see what cubbies I was given&rdquo;. Don&rsquo;t be afraid to take your Rails project by the horns! You can create your own actions, decorators, support objects, and services. Start including these patterns in your Rails app, and your code will come out clean and DRY: so fresh, so clean!</p>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/162/asset.gif"></p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Looking For A Needle In A Haystack! (or Using Ack To Improve Your Development Workflow)]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/09/04/looking-for-a-needle-in-a-haystack-with-ack/"/>
    
    <updated>2014-09-04T06:19:42-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/09/04/looking-for-a-needle-in-a-haystack-with-ack</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on the <a href="http://quickleft.com/blog/looking-for-a-needle-in-a-haystack-or-using-ack-to-improve-your-development-workflow">Quick Left Blog</a>.</p>

<h2>or Using Ack to Improve Your Development Workflow</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/120/asset.jpg" style="margin:0 auto;display:block;"></p>

<h2>Introduction</h2>

<p>Every day when I&rsquo;m programming, I invariably come to a point where I&rsquo;m looking for a certain line of code in
my project. Usually, there&rsquo;s a pattern that I saw and want to reuse, and I can&rsquo;t
find it. I could just use my editor&rsquo;s &ldquo;find in files&rdquo; feature and look for it, but sometimes I need more fine
grained control. What if I want to find all the lines of code that <em>don&rsquo;t</em>
contain a certain phrase? What if I want to search on a Regular
Expression? What if I want to easily save the search results to a file?</p>

<p>When I need more control in finding something, I turn my favorite command line search tool:
<a href="http://beyondgrep.com/">ack</a>.</p>

<h2>Why Ack?</h2>

<p>Why should you use <code>ack</code>, when your unix distribution comes with <code>find</code>, <code>mdfind</code>, and
<code>grep</code>? Well, because it has these advantages:</p>

<ul>
<li>It only searches the stuff you care about. It excludes Git,
Subversion, binary files, and other irrelevant file types.</li>
<li>It can search all the files in a certain language, regardless of file
extension.</li>
<li>It is a lot easier to remember the command flags to scope your search
than with other tools.</li>
</ul>


<h2>Installing Ack</h2>

<p>To install Ack, I would suggest using <a href="http://brew.sh/">homebrew</a>. If you
have it installed, just type <code>brew install ack</code>.</p>

<p>You can also use <code>package</code> on many other Unix distributions, as well as
Macports, OpenBSD and FreeBSD, or just download it with this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl http://beyondgrep.com/ack-2.12-single-file &gt; ~/bin/ack && chmod 0755 !#:3</span></code></pre></td></tr></table></div></figure>


<h2>Basic Seach</h2>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/118/asset.gif" style="margin:0 auto;display:block;"></p>

<p>To do a basic search for a string in a file with ack, the syntax
is as simple as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<p>This will recursively search for the pattern in specified directory.
I usually just use a simple text search. For example, if you were to do
this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir tmp && cd tmp
</span><span class='line'>echo "Hello, world" &gt; hello.txt
</span><span class='line'>echo "Goodbye, world" &gt; goodbye.txt
</span><span class='line'>echo "Hello, squirrel" &gt; hi.txt
</span><span class='line'>echo "Goodbye, squirrel" &gt; bye.txt</span></code></pre></td></tr></table></div></figure>


<p>Then you could search for the files containing <code>hello</code> with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack hello .</span></code></pre></td></tr></table></div></figure>


<p>The <code>.</code> here means search the current directory. This is a recursive
search by default. To turn off recursion, pass the <code>-n</code> flag, like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir child-directory
</span><span class='line'>mv hello.txt child-directory
</span><span class='line'>ack -n hello .</span></code></pre></td></tr></table></div></figure>


<p>Now you&rsquo;ll only see one result, <code>hi.txt</code>, because it&rsquo;s the only file
with &lsquo;hello&rsquo; in it that lives in the current directory.</p>

<h2>Sorting</h2>

<p>Sometimes it would be nice to sort your search results. Easy enough!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --sort-files -l</span></code></pre></td></tr></table></div></figure>


<h2>Inverse Search</h2>

<p>One of my flags is <code>-v</code>, which lets you do a search for all the files
that <em>don&rsquo;t</em> match a given pattern. It comes in pretty handy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -v &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<p>Careful, though, because that could be a lot of output. You might want to shovel
it into a file like we did before, or at least pipe it to <code>less</code>.</p>

<h2>Searching By File Type</h2>

<p>One of my favoritate uses for <code>ack</code> is to searching for all the files in a certain language. Ack supports
Ruby, Python, JavaScript, Shell, Clojure, HTML, and a bunch of other
file types. To see a full listing, do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --help-types</span></code></pre></td></tr></table></div></figure>


<p>If you want to, you can add new types, change the ones that are already
there, or delete them, with <code>--type-add</code>, <code>--type-set</code>, and <code>--type-del</code>,
respectively.</p>

<p>Assuming you&rsquo;re good with the default types, let&rsquo;s take it for a spin. Want a list of
&ldquo;all the things&rdquo; Ruby? Open a Rails project and run this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -f --ruby &gt; all-ruby-files.txt</span></code></pre></td></tr></table></div></figure>


<p>Want to find all the Ruby files that call <code>puts</code>?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --ruby puts .</span></code></pre></td></tr></table></div></figure>


<p>Want to find all the files that say <code>hello</code>, but <em>aren&rsquo;t</em> Ruby files?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --type=noruby hello .</span></code></pre></td></tr></table></div></figure>


<h2>Using an <code>.ackrc</code> file</h2>

<p>If you do a lot of <code>ack</code>ing, and you want to set up some ack options
systemwide, or for your specific project, you can define an <code>.ackrc</code>
file. To have ack generate one for you, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --create-ackrc &gt; .ackrc</span></code></pre></td></tr></table></div></figure>


<p>Then, if you run a search in the current directory, the settings in the
<code>.ackrc</code> will be used.</p>

<p>You can also put your ack options into an <code>ACK_OPTIONS</code> environment
variable like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export ACK_OPTIONS="--nocolor"</span></code></pre></td></tr></table></div></figure>


<p>If you defined some ack options in an <code>.ackrc</code> or an environment variable and want to run a search without those options, you can also turn them off with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --noenv &lt;search&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Advanced Searches</h2>

<p>If you&rsquo;re diggin&#8217; it, here are some other fun things you can do with Ack.</p>

<h3>Case Insenstivite Search</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -i &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Match Whole Words Only</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -w &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Only Output the Filenames, Without Highlighted Text</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -l &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -L &lt;search-pattern&gt; &lt;directory&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Just One Result (AKA &ldquo;I&rsquo;m Feeling Lucky&rdquo;)</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack -1 &lt;search-pattern&gt; &lt;directory&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Vim Integration (AckVim)</h2>

<p>If you&rsquo;re a vim user, you might want to check out the <a href="https://github.com/mileszs/ack.vim">AckVim Plugin</a>.
It lets you run ack inside of vim and see the results in a split window.</p>

<p>Once you&rsquo;ve added it with Git or Vundle, it&rsquo;s as easy as typing:</p>

<p><code>:Ack [options] {pattern} [{directories}]</code></p>

<p>It&rsquo;s pretty nice to have around!</p>

<h2>Ack the Cat, Cathy and Bar</h2>

<p>Well, you&rsquo;ve made it this far, so here&rsquo;s some candy for you. Run these:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ack --thpppt
</span><span class='line'>ack --cathy
</span><span class='line'>ack --bar</span></code></pre></td></tr></table></div></figure>


<h2>Goodbye!</h2>

<p>Sometimes it can be like looking for a needle in
a haystack trying to find what you need in your project.</p>

<p><img src="//quickleft-production.s3.amazonaws.com/uploads/asset/attachment/119/asset.gif" style="margin:0 auto;display:block;"></p>

<p>Seriously, though, I hope this little tour of the small command line
tool <code>ack</code> improves your programming experience. Cheers!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[AngularJS Unit Testing, For Real Though]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/07/24/angular-js-unit-testing-for-real-though/"/>
    
    <updated>2014-07-24T06:20:37-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/07/24/angular-js-unit-testing-for-real-though</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on the <a href="http://quickleft.com/blog/angularjs-unit-testing-for-real-though">Quick Left Blog</a>.</p>

<p>It also appeared as a featured article in <a href="http://javascriptweekly.com/issues/192">JavaScript Weekly</a>.</p>

<h2>Introduction</h2>

<p>When it comes to contemporary web development, AngularJS is the new hotness. Its unique approach to HTML compilation and two-way data binding make it
an effective tool for efficiently building client-side web apps. When
I found out that Quick Left would be using it to build a production application for one of our clients, I was excited to learn as much about it as
I could. I scoured the interwebs for every tutorial and walkthrough
to be found on the Google Machine. They were really helpful in understanding directives, template compilation, and the event loop, but when it came to testing, I found that the topic was often hand-waved.</p>

<p>I was trained to practice Test-Driven Development, and I feel like
something&rsquo;s out of place whenever I&rsquo;m out of the &ldquo;Red-Green-Refactor&rdquo; flow.
Since we were still learning the ropes for effective testing in Angular, the team sometimes had to rely on &lsquo;test-after&rsquo; development. This started to make me feel itchy, so I decided to focus on figuring out testing. I sprinted on it for a week, and we soon went from about 40% test coverage
to 86% (By the way, if you haven&rsquo;t tried it yet, check out <a href="http://gotwarlost.github.io/istanbul/">Istabul</a>
for checking out your test coverage in JS apps).</p>

<p>Today I&rsquo;d like to share some things I learned along the way.
As good as the <a href="https://docs.angularjs.org/api">Angular docs</a> are, testing a production app is rarely as
simple as the examples you&rsquo;ll find there. There are a lot of gotchas that pop
up along the way, and I had to struggle my way through figuring out how
to make things work. I found several workarounds that came in handy time
and time again. In this article, we&rsquo;re going to look at some of them:</p>

<ol>
<li>Reusable End-to-End (e2e) pages</li>
<li>Dealing with functions that return a promise</li>
<li>Mocking controller and directive dependencies</li>
<li>Accessing child and isolate scopes</li>
</ol>


<p>This article is written for intermediate to advanced developers using
AngularJS to build production applications, who would like to reduce some
of the pain of testing. It is my hope that feeling secure in testing workflow
will enable the reader to practice a TDD workflow and build a more solid app.</p>

<h2>Test Tools</h2>

<p>There are many test frameworks and tools available to the Angular
developer, and you may already have preferences around tooling. Here&rsquo;s
the setup that we chose, and we&rsquo;ll be using for the rest of this article:</p>

<ul>
<li><p><a href="http://karma-runner.github.io/0.12/index.html"><em>Karma</em></a>: The official AngularJS team test runner. We&rsquo;ll use it to launch
Chrome, Firefox, and PhantomJS.</p></li>
<li><p><a href="https://docs.angularjs.org/api/ngMock/object/angular.mock"><em>AngularMocks</em></a>: Provides support for injecting and mocking Angular services in
unit tests.</p></li>
<li><p><a href="https://github.com/angular/protractor"><em>Protractor</em></a>: The feature testing tool for AngularJS, which launches
your app in a browser and interacts with it via Selenium.</p></li>
<li><p><a href="http://visionmedia.github.io/mocha/"><em>Mocha</em></a>: A node.js based test framework. Gives us the ability to write <code>describe</code> blocks and make assertions.</p></li>
<li><p><a href="http://chaijs.com/"><em>Chai</em></a>: Assertion library that hooks into Mocha, and gives us access to Behavior-Driven Development assertions like <code>expect</code>, <code>should</code>, and <code>assert</code>. In this example, we&rsquo;ll be using <code>expect</code>.</p></li>
<li><p><a href="http://chaijs.com/plugins/chai-as-promised"><em>Chai-as-promised</em></a>: This Chai plugin is really helpful for dealing with function calls that return a promise. It gives us the ability to say things like: <code>expect(foo).to.be.fulfilled</code>, or <code>expect(foo).to.eventually.equal(bar)</code>.</p></li>
<li><p><a href="http://sinonjs.org/"><em>Sinon</em></a>: Stubbing and mocking library. We&rsquo;ll use it to mock out directive and controller dependencies in unit tests, and to check that functions are being called with the correct arguments.</p></li>
<li><p><a href="http://browserify.org/"><em>Browserify</em></a>: Allows us to easily require modules of code between files in the project.</p></li>
<li><p><a href="https://www.npmjs.org/package/partialify"><em>Partialify</em></a>: Allows us to require HTML templates inline in our AngularJS directives.</p></li>
<li><p><a href="http://lodash.com/"><em>Lodash</em></a>: Utilities used to extend JavaScript and make it easier to work with.</p></li>
</ul>


<h2>Setting Up A Test Helper</h2>

<p>We&rsquo;ll start by creating a test helper that will load in the necessary
dependencies. Here, I&rsquo;m pulling in Angular Mocks, Chai,
Chai-as-promised, and Sinon.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test/test-helper.js</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Load in our actual project</span>
</span><span class='line'><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;widgetProject&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dependencies</span>
</span><span class='line'><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular-mocks&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">chai</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chai&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">chai</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;sinon-chai&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">chai</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;chai-as-promised&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">sinon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sinon&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Create a new sandbox before each test</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">sinon</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">sandbox</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Cleanup the sandbox to remove all the stubs</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">rootUrl</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9000&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">expect</span><span class="o">:</span> <span class="nx">chai</span><span class="p">.</span><span class="nx">expect</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Getting Started: Top-Down Testing</h2>

<p>I&rsquo;m a big proponent of a top-down testing style. Starting with a feature
that I know I want to build, I like to write a pseudo-gherkin scenario
describing the desired behavior and translate it into a feature test. I run
that test and let it fail. Then I can begin building all the parts of the system
that I need to make the feature work, using unit tests to guide me along the way.</p>

<p>For these demos, I&rsquo;ll building an imaginary application called &ldquo;Widgets&rdquo;, that can display a list of widgets, create new widgets, and edit existing widgets. The code you&rsquo;ll see here is not enough to build the complete application, just enough to help the test examples make sense. We&rsquo;ll start by writing an e2e test describing the workflow for creating a new widget.</p>

<p>To start things off, I&rsquo;ll describe a pattern we found useful in e2e testing: creating a reusable &ldquo;page&rdquo; file. For this example, we&rsquo;ll imagine that we&rsquo;re working on a form to create a new widget.</p>

<h2>Reusable e2e Test Pages</h2>

<p>When working on a one-page app, it makes sense to DRY up the feature tests by
writing a reusable &ldquo;page&rdquo; that you can reference from within multiple e2e tests.</p>

<p>There are many ways to structure the tests in an Angular project. Today,
we&rsquo;ll go with this setup:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">widgets</span><span class="o">-</span><span class="nx">project</span>
</span><span class='line'><span class="o">|-</span><span class="nx">test</span>
</span><span class='line'><span class="o">|</span>  <span class="o">|</span>
</span><span class='line'><span class="o">|</span>  <span class="o">|-</span><span class="nx">e2e</span>
</span><span class='line'><span class="o">|</span>  <span class="o">|</span>  <span class="o">|-</span><span class="nx">pages</span>
</span><span class='line'><span class="o">|</span>  <span class="o">|</span>
</span><span class='line'><span class="o">|</span>  <span class="o">|-</span><span class="nx">unit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside of the <code>pages</code> folder, we&rsquo;ll create a <code>WidgetsPage</code> function that
we can require into our e2e tests. It has five references:</p>

<ul>
<li><code>widgetRepeater</code>: a list of widgets contained in an <code>ng-repeat</code></li>
<li><code>firstWidget</code>: the first widget in the repeater</li>
<li><code>widgetCreateForm</code>: the form used to create a widget</li>
<li><code>widgetCreateNameField</code>: form field to enter the widget&rsquo;s name</li>
<li><code>widgetCreateSubmit</code>: form submit button</li>
</ul>


<p>In the end, it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test/e2e/pages/widgets-page.js</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../test-helper&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">WidgetsPage</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">rootUrl</span> <span class="o">+</span> <span class="s1">&#39;/widgets&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">widgetRepeater</span> <span class="o">=</span> <span class="nx">by</span><span class="p">.</span><span class="nx">repeater</span><span class="p">(</span><span class="s1">&#39;widget in widgets&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">firstWidget</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">widgetRepeater</span><span class="p">.</span><span class="nx">row</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">widgetCreateForm</span> <span class="o">=</span> <span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;.widget-create-form&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">widgetCreateNameField</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">widgetCreateForm</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;widget.name&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">widgetCreateSubmit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">widgetCreateForm</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="nx">by</span><span class="p">.</span><span class="nx">buttonText</span><span class="p">(</span><span class="s1">&#39;Create&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">WidgetsPage</span>
</span></code></pre></td></tr></table></div></figure>


<p>From within my e2e tests, I can now load up this page and interact with
the elements on it. Here&rsquo;s how I would use the test page in a test for the widget
create form:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// e2e/widgets_test.js</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../test-helper&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">expect</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">WidgetsPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./pages/widgets-page&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;creating widgets&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">page</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WidgetsPage</span><span class="p">();</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should create a new widget&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">firstWidget</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">undefined</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">widgetCreateForm</span><span class="p">.</span><span class="nx">isDisplayed</span><span class="p">()).</span><span class="nx">to</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">widgetCreateNameField</span><span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s1">&#39;New Widget&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">widgetCreateSubmit</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">firstWidget</span><span class="p">.</span><span class="nx">getText</span><span class="p">()).</span><span class="nx">to</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Name: New Widget&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s step through what&rsquo;s happening here. First, we load up the test
helpers and get <code>expect</code> and the reusable <code>WidgetsPage</code> from them.
In the <code>beforeEach</code>, we load up the page in the browser.
Then, in the example, we use the page elements we defined in the
<code>WidgetsPage</code> to interact with the page. We check that there
are no widgets, then fill out the form to create one named &ldquo;New Widget&rdquo;,
and check that it is displayed on the page.</p>

<p>By splitting the logic for the form out into a reusable &ldquo;page&rdquo;, we can
now reuse it to test form validations or custom form directives later on.</p>

<h2>Dealing With Functions That Return a Promise</h2>

<p>The assertions we get from Protractor in the test above return promises, so we use
Chai-as-promised to check that functions like <code>isDisplayed</code> and <code>getText</code> return what we expect <em>after</em> they&rsquo;re resolved.</p>

<p>We can also deal with promises inside of unit tests. Take a look at this
example, in which we test a modal that can be used to edit an existing widget.
It makes use of the UI Bootstrap <code>$modal</code> service. When a user opens the
modal, this service returns a promise. When she saves or cancels the modal,
the promise is resolved or rejected. Here, we&rsquo;ll test that the <code>save</code> and <code>cancel</code> methods are properly hooked up, again using Chai-as-promised.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// widget-editor-service.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetProject.widgetEditor&#39;</span><span class="p">).</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;widgetEditor&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$modal&#39;</span><span class="p">,</span> <span class="s1">&#39;$q&#39;</span><span class="p">,</span> <span class="s1">&#39;$templateCache&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">$modal</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">$q</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">$templateCache</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widgetObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">templateId</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s1">&#39;widgetEditorTemplate&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$templateCache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">templateId</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./widget-editor-template.html&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$modal</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">template</span><span class="o">:</span> <span class="nx">templateId</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dialog</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="nx">widgetObject</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dialog</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Do some saving things</span>
</span><span class='line'>      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">dialog</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dialog</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">cancel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">dialog</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This service loads the widget editor template into the template cache,
loads a widget into it, and and sets up a deferred object that will be
resolved or rejected depending on whether the user saves or cancels from
the editor. It returns a promise from the deferred.</p>

<p>Here&rsquo;s how you might test something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test/unit/widget-editor-directive_test.js</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../test_helper&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">expect</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;widget storage service&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">modal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="o">:</span> <span class="p">{},</span>
</span><span class='line'>        <span class="nx">destroy</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">()</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetProject.widgetEditor&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">$modal</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">modal</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should persist changes when the user saves&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">inject</span><span class="p">([</span><span class="s1">&#39;widgetModal&#39;</span><span class="p">,</span> <span class="s1">&#39;$rootScope&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widgetModal</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Widget&#39;</span> <span class="p">};</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">widgetModal</span><span class="p">(</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">modal</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Somehow test that the widget was saved</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">modal</span><span class="p">.</span><span class="nx">destroy</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">been</span><span class="p">.</span><span class="nx">called</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">promise</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">fulfilled</span><span class="p">.</span><span class="nx">and</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
</span><span class='line'><span class="nx">st</span>
</span><span class='line'>      <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}]);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should not save when the user cancels&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">inject</span><span class="p">([</span><span class="s1">&#39;widgetModal&#39;</span><span class="p">,</span> <span class="s1">&#39;$rootScope&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widgetModal</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Widget&#39;</span> <span class="p">};</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">widgetModal</span><span class="p">(</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">modal</span><span class="p">.</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">modal</span><span class="p">.</span><span class="nx">destroy</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">been</span><span class="p">.</span><span class="nx">called</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">expect</span><span class="p">(</span><span class="nx">promise</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejected</span><span class="p">.</span><span class="nx">and</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}]);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>To deal with the complexity of the promise that the modal returns in the widget editor test, we have to do a few things. First, we build a mock <code>$modal</code> service in the <code>beforeEach</code> function, replacing it with a function that returns <code>$scope</code> as an empty object, and stubs <code>destroy</code>. In <code>angular.mock.module</code>, we pass this modal double
into the options to get Angular Mocks to use it instead of the real
<code>$modal</code> service. This pattern is extremely useful in stubbing out
dependencies, as we&rsquo;ll discover shortly.</p>

<p>There are two examples here, and each has to wait for the promise
returned by the widget editor to be resolved before it can be completed.
Because of this, we have to pass <code>done</code> as parameter to the example
itself, and <code>notify(done)</code> when the test is complete.</p>

<p>Within the tests, we use Angular Mocks again to inject the widget modal
and the AngularJS <code>$rootScope</code> service into the test. Having <code>$rootScope</code> gives
us the ability to trigger a <code>$digest</code> loop. In each of the tests, we load up
the modal, cancel or reject it, and use Chai-as-expected to test whether the
promise returned was <code>rejected</code> or <code>resolved</code>. To trigger the actual promise
resolution and call <code>destroy</code>, we have to have a <code>$digest</code> loop, so we
do that at the end of each assertion as well.</p>

<p>We&rsquo;ve now looked at how to deal with promises in both e2e and unit
tests, using these assertions:</p>

<ul>
<li><code>expect(foo).to.eventually.equal(bar)</code></li>
<li><code>expect(foo).to.be.fulfilled</code></li>
<li><code>expect(foo).to.be.rejected</code></li>
</ul>


<h2>Mocking Controller and Directive Dependencies</h2>

<p>In the previous example, we had a service that relied on the <code>$modal</code>
service, which we mocked out so that we could ensure that <code>destroy</code> was
being called. The pattern we used to get that hooked up is very useful in
getting unit tests to work properly in Angular.</p>

<p>The pattern is as follows:</p>

<ul>
<li>Set <code>var self = this</code> in the beforeEach block.</li>
<li>Build a double and stub its methods, then make it a property of the <code>self</code> object:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">self</span><span class="p">.</span><span class="nx">dependency</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">dependencyMethod</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>`
- Pass your doubles into the module under test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;mymodule&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">dependency</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dependecy</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">otherDependency</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">otherDependency</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Check that the mocked methods within your test examples. You can use
 <code>expect(foo).to.have.been.called.withArgs</code>, passing in the arguments
 you expect, for more precise coverage.</li>
</ul>


<p>Sometimes directives or controllers depend on many external and internal
dependencies, and you need to mock them out. Here&rsquo;s a more complicated example,
in which directive watches a <code>widgetStorage</code> service and updates the
widgets in its scope whenever the collection changes. There&rsquo;s also
an <code>edit</code> method that opens the <code>widgetEditor</code> we created above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// widget-viewer-directive.js</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetProject.widgetViewer&#39;</span><span class="p">).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;widgetViewer&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;widgetStorage&#39;</span><span class="p">,</span> <span class="s1">&#39;widgetEditor&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span>
</span><span class='line'>  <span class="nx">widgetStorage</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">widgetEditor</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">template</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./widget-viewer-template.html&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">,</span> <span class="nx">$attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">widgetStorage</span><span class="p">.</span><span class="nx">notify</span><span class="p">;</span>
</span><span class='line'>      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widgets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">widgets</span> <span class="o">=</span> <span class="nx">widgets</span><span class="p">;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">edit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">widgetEditor</span><span class="p">(</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s how we might test something like this, mocking out the
dependencies on <code>widgetStorage</code> and the <code>widgetEditor</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test/unit/widget-viewer-directive_test.js</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../test_helper&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">expect</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;widget viewer directive&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">widgetStorage</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">notify</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">()</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">widgetEditor</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetProject.widgetViewer&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">widgetStorage</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">widgetStorage</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">widgetEditor</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">widgetEditor</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The rest of the test...</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Accessing Child and Isolate Scopes</h2>

<p>Sometimes you need to write a directive that has an isolate or child
scope inside of it. For example, when using the <a href="http://mgcrea.github.io/angular-strap/">Angular Strap</a> <code>$dropdown</code>
service, an isolate scope is created. It can be a pain to try to access these from within your tests. Knowing about <code>self.element.isolateScope()</code> is the key to solving this problem. Here&rsquo;s an example using <code>$dropdown</code>, which creates an isolate scope:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// nested-widget-directive.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetSidebar.nestedWidget&#39;</span><span class="p">).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;nestedSidebar&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;widgetStorage&#39;</span><span class="p">,</span> <span class="s1">&#39;widgetEditor&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span>
</span><span class='line'>  <span class="nx">$dropdown</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">widgetStorage</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">widgetEditor</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">template</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./widget-sidebar-template.html&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">scope</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">widget</span><span class="o">:</span> <span class="s1">&#39;=&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">,</span> <span class="nx">$attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">actions</span> <span class="o">=</span> <span class="p">[{</span>
</span><span class='line'>        <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">click</span><span class="o">:</span> <span class="s1">&#39;edit()&#39;</span>
</span><span class='line'>      <span class="p">},</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">click</span><span class="o">:</span> <span class="s1">&#39;delete()&#39;</span>
</span><span class='line'>      <span class="p">}]</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">edit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">widgetEditor</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="k">delete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">widgetStorage</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assuming this directive inherits the widget from a parent directive that
has a collection of widgets, it can be tough to get ahold of the child scope
to test its properties are being updated as expected. But it can be done. Here&rsquo;s how:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test/unit/nested-widget-directive_test.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">angular</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;angular&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../test_helper&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">expect</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;nested widget directive&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">widgetStorage</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">destroy</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">()</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">widgetEditor</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;widgetProject.widgetViewer&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">widgetStorage</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">widgetStorage</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">widgetEditor</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">widgetEditor</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">angular</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">inject</span><span class="p">([</span><span class="s1">&#39;$rootScope&#39;</span><span class="p">,</span> <span class="s1">&#39;$compile&#39;</span><span class="p">,</span> <span class="s1">&#39;$controller&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$compile</span><span class="p">,</span> <span class="nx">$controller</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">parentScope</span> <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="k">new</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">childScope</span> <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="k">new</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">self</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">childScope</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;widget1&#39;</span> <span class="p">};</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">parentElement</span>
</span><span class='line'>        <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="s1">&#39;&lt;widget-organizer&gt;&lt;/widget-organizer&gt;&#39;</span><span class="p">)(</span><span class="nx">self</span><span class="p">.</span><span class="nx">parentScope</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">parentScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">childElement</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="s1">&#39;&lt;nested-widget</span>
</span><span class='line'><span class="s1">        widget=&quot;widget&quot;&gt;&lt;/nested-widget&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">childElement</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">childElement</span><span class="p">)(</span><span class="nx">self</span><span class="p">.</span><span class="nx">childScope</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">self</span><span class="p">.</span><span class="nx">childScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}]);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">compile</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">isolateScope</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">isolateScope</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;edits the widget&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">isolateScope</span><span class="p">.</span><span class="nx">edit</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">self</span><span class="p">.</span><span class="nx">rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">expect</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">widgetEditor</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">been</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">childScope</span><span class="p">.</span><span class="nx">widget</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Craziness, right? First we mock out the <code>widgetStorage</code> and <code>widgetEditor</code> again, then we proceed to create a <code>compile</code> function. This function will instantiate two scopes, a <code>parentScope</code> and a <code>childScope</code>, stub out a widget, and put it on the child scope. Then <code>compile</code> goes on to do some complicated template and scope setup: first, compiling a parent element called <code>widget-organizer</code>, which gets the parent scope passed into it.  Once that&rsquo;s all set up, we add a <code>nested-widget</code> child element to it, pass it the child scope, and trigger the <code>$digest</code> loop.</p>

<p>Finally, we get to the magic: we call the <code>compile</code> function, then hook
into the compiled template&rsquo;s isolate scope (which is the <code>$dropdown</code>
scope), with <code>self.element.isolateScope()</code>. When we actually get to the
assertion at the end, we can hook into the isolate scope to call <code>edit</code>,
and finally check that the stubbed out <code>widgetEditor</code> was called with
the stubbed widget.</p>

<h2>Conclusion</h2>

<p>Testing can get painful. I know that there were several times in our
project where the pain of figuring out what to do was so great that it
was tempting to just move on, writing code and falling back to the &ldquo;click test&rdquo; to
make sure everything was working. Unfortunately, once you get out of that flow, the feeling of uncertainty begins to grow and grow.</p>

<p>After we took the time to figure out how to deal with these difficult
cases, it became a lot easier to know what to do when similar
complicated cases presented themselves. Armed with the patterns
described in this article, we were able to get into a TDD workflow
and move forward with confidence.</p>

<p>I hope that the testing patterns we&rsquo;ve looked at today prove useful in
your own development practice. AngularJS is still a young, growing framework.
What other patterns have you found to make it easier to test? Please
tweet at me @fluxusfrequency!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Five Capybara Hacks To Make Your Testing Experience Less Painful]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/05/20/five-capybara-hacks-to-make-your-testing-experience-less-painful/"/>
    
    <updated>2014-05-20T06:20:08-06:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/05/20/five-capybara-hacks-to-make-your-testing-experience-less-painful</id>
    
    <content type="html"><![CDATA[<p>This post originally appeared on the <a href="http://quickleft.com/blog/five-capybara-hacks-to-make-your-testing-experience-less-painful">Quick Left Blog</a>.</p>

<h2>Testing, Testing&hellip;</h2>

<p>Everyone knows it&rsquo;s important to test your code. But sometimes, the experience
can be a little bit painful. Ok, sometimes it&rsquo;s very painful.</p>

<p><img src="http://quickleft-production.s3.amazonaws.com/uploads/asset/attachment/58/asset.jpg" alt="Painful Testing" /></p>

<p>What to do? Abandon the tests? Never! Smokey, this is not &lsquo;Nam. This is coding. There are rules.</p>

<p>Today I want to share a few of the things I&rsquo;ve learned that help mitigate that
pain when testing Rails with Capybara. Ladies and gentlemen, I give you&hellip;</p>

<h2>The Hacks</h2>

<h3>1) Execute Script</h3>

<p>In one project I was working on, I wanted to use a fake password input field so
I could display a text field instead of a password field. I wanted to do
that so I could give it placeholder text that wouldn&rsquo;t appear as dots.
When the fake field received focus, it was replaced with the real password
field using jQuery.</p>

<p>This solution passed the click test, but it was a headache when testing.
My Capybara spec couldn&rsquo;t find the password field, because it was hidden.
Since pretty much every integration test I had needed to log in before it could
do anything, I was stuck.</p>

<p>In order to overcome the difficulty, I had the test execute a script to show the
field I was looking for.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">page</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s2">&quot;$(&#39;#new_password&#39;).show()&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could then fill out the form normally and access the rest of the app.</p>

<p>This trick also comes in useful when using Bootstrap for responsive design.
Sometimes, the mobile menu dropdown can cause conflicts with other elements on
the page, and Capybara can&rsquo;t click on them.</p>

<h3>2) Tail the Test Log File</h3>

<p>I&rsquo;ve gotten so used to being able to read the Rails server stack trace when
troubleshooting in development, that I sometimes I don&rsquo;t know what to do to when
I want to find my errors in while testing. The test stack trace and pry will only
take you so far. When things get really hairy, you can get a similar output
as you would see in development by running <code>tail -f log/test.log</code> in a separate
terminal tab before running the specs.</p>

<h3>3) Find the Port Address and Pause the Test</h3>

<p>Sometimes I just want to see what&rsquo;s going on in the browser. Although
<code>save_and_open_page</code> gives you some idea of what&rsquo;s going on, you can&rsquo;t
really click around, because the page it gives you is static and lacking assets.
To dig into what&rsquo;s going on, I like to use a trick I learned from my mentor,
Mike Pack.</p>

<p>Just above the broken line in your test, add these two lines of code.
Note that you have to have pry installed in your current gemset or
specified in the Gemfile for this to work.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="n">current_url</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;pry&#39;</span><span class="p">;</span> <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the specs, and when they pause, copy the url and port number from the test
output. Open your browser and paste the address into the window. Voila!
You&rsquo;re now browsing your site in test mode!</p>

<h3>4) Make Sure DatabaseCleaner Plays Nice with PhantomJS</h3>

<p>It can get really tricky to test JavaScript in Rails.
Arguably, using some Jasmine tests may be the best thing if you have
a lot of JS code. That may work for unit tests, but if you want to test
a feature from end to end, it usually makes sense to use Capybara. To drive the
JavaScript, you need an engine like <a href="https://github.com/teampoltergeist/poltergeist">Poltergeist</a>, which relies on <a href="http://phantomjs.org/">PhantomJS</a>.</p>

<p>Meanwhile, you also need to take care of cleaning the database between specs to
make sure that they are independent. In my apps, I usually take care of this
with the <a href="https://github.com/bmabey/database_cleaner">DatabaseCleaner</a> gem.</p>

<p>Unfortunately, PhantomJS runs the JavaScript code in a separate thread from the
application code, which means that JS transactions don&rsquo;t always get
committed to the database before DatabaseCleaner attempts to clean them.</p>

<p>The answer is to make sure that you set it to use the <code>:truncation</code>
strategy for JavaScript tests. See Avdi Grimm&rsquo;s
<a href="http://devblog.avdi.org/2012/08/31/configuring-database_cleaner-with-rails-rspec-capybara-and-selenium/">blog post</a> on the subject for more details.</p>

<p>Here&rsquo;s how to set it up in your <code>spec_helper</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before</span> <span class="ss">:suite</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="ss">:transaction</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">,</span> <span class="ss">:js</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5) Split VCR/Webmock Specs Into a Separate Rake Task From Your JavaScript Tests</h3>

<p>Sometimes I have service objects that interact with an external API. The easiest
way to test them without relying on actual HTTP requests is to use the
<a href="https://github.com/vcr/vcr">VCR</a> gem. With VCR, you can also hook into
<a href="https://github.com/bblimke/webmock">Webmock</a>, which keeps your computer from
making any external HTTP requests during the test cycle. This is all well and good
until you are making requests against a local API with JavaScript as well.
In that case, Webmock will block the requests. Over the line!</p>

<p>I&rsquo;ve played around with various ways of setting a condition in my test
helper and before blocks to only run Webmock for a certain test, but I&rsquo;ve come
up with another solution that I prefer. Instead of running <code>rspec</code>, I split the
tests into a <code>:services</code> group, and a <code>:local</code> group. Then, I write a rake task
in lib/tasks called <code>spec.rake</code> that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:spec</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;run all local specs&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:local</span>  <span class="k">do</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/models&#39;</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/features&#39;</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/controllers&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;run all service specs&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:services</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/services&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:all</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/models&#39;</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/features&#39;</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/controllers&#39;</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s1">&#39;rspec spec/services&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This way, you only have to type one command to run all of your specs, just as
you would if you had typed <code>rspec</code>. It&rsquo;s also easy to hook it into your Travis CI
configuration like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">language</span><span class="p">:</span> <span class="n">ruby</span>
</span><span class='line'><span class="ss">rvm</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="s2">&quot;2.0.0-p353&quot;</span>
</span><span class='line'><span class="ss">script</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">create</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span> <span class="no">RAILS_ENV</span><span class="o">=</span><span class="nb">test</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">spec</span><span class="p">:</span><span class="n">local</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">spec</span><span class="p">:</span><span class="n">services</span>
</span></code></pre></td></tr></table></div></figure>


<p>Boom! Local and external APIs all tested, JavaScript tested, and Travis
build passing.</p>

<h2>Conclusion</h2>

<p>If you&rsquo;re using a lot of JavaScript (and who isn&rsquo;t these days?) in your Rails app, it can sometimes hurt to write your feature tests. I hope these five hacks will make your life a little easier when you are testing, so you can get back to writing the code that makes your app go. Until then, &lsquo;the Dude abides&rsquo;.</p>

<p><img src="http://quickleft-production.s3.amazonaws.com/uploads/asset/attachment/59/asset.gif" alt="The Dude Abides" /></p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Service Oriented Architecture]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/02/14/service-oriented-architecture/"/>
    
    <updated>2014-02-14T06:40:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/02/14/service-oriented-architecture</id>
    
    <content type="html"><![CDATA[<p>We just finished up our penultimate project at gSchool, an application built using a Service Oriented Architecture (SOA). The project ideas were generated in small groups, and focused a the theme of health and wellness. Once the ideas were decided, our teacher Jeff Casimir generated a randomized list of the students, and we drafted projects.</p>

<p>I went first, and selected an idea that was close to my heart: an app to help home vegetable gardeners plan out their beds for the season. Having spent several years as an organic farm worker, garden company owner, and home garden hobbyist, I was excited to use this app. Every spring, before the ground warms up, my partner and I sit down with a pencel and graph paper to plan out the different beds in my garden: what will go where, how it will be spaced, when it will be harvested, and what we&rsquo;ll plant there afterwards.</p>

<p>I had big hopes for our project, dubbed <a href="http://plantingseason.tk">Planting Season</a> (<a href="https://github.com/VirginSoil">code</a>). A user would have several gardens, each with many beds. The app would keep track of her plans from month to month, and she would be able to click on a month to see what she&rsquo;d planned to plant there, which spots were empty, and which plants were ready for harvest. It would find her USDA Hardiness Zone and suggest plants well-suited to grow there. If there was impending frost, or a bed needed water, it would send her a text message, email, or a Google voice message.</p>

<p>Ah, the dreams of the young and inexperienced&hellip;</p>

<h2>Planting Season&rsquo;s Structure</h2>

<p>Two of my group members had just completed <a href="https://github.com/foofoberry">FooFoBerry</a>, an SOA app that exposed and consumed APIs from various project management tools, such as GitHub, Travis, and Code Climate. With their experience setting up services, I figured that getting the project up and running would be a breeze. In practice, it was more challenging than I expected.</p>

<p>I&rsquo;m a big fan of a &ldquo;lean startup&rdquo; / &ldquo;minimum viable product&rdquo; approach in my projects. I like to get a simple product up as fast as possible, then expand on it, adding value. Given that we had three weeks, we planned three iterations for Planting Season:</p>

<p>Week 1 - Put up a landing page where users could enter their email to be notified when the app was ready.</p>

<p>Week 2 - Change the landing page to allow users to sign up or sign in, then send them to a dashboard page, where they could add and remove plants from a single garden.</p>

<p>Week 3 - Add functionality for multiple beds, text and email weather notifications, and a timeline for the garden through the year.</p>

<p>With this functionality in mind, we decided to build the following services:</p>

<ol>
<li>Landing Page App</li>
<li>User Authentication App</li>
<li>Client-Facing Dashboard (&ldquo;Coordinator&rdquo;) App</li>
<li>RESTful JSON API with Bed and Plant data</li>
<li>A gem to facilitate communication between the Dashboard and the API</li>
<li>External Services - Weather and Geolocation APIs</li>
</ol>


<p>Here&rsquo;s how the project ended up looking in the end:</p>

<p><br /></p>

<p><img class="center" src="http://s5.postimg.org/w893s8cuf/planting_season_graph.png" title="Planting Season Project Structure" alt="A web application diagram"></p>

<h2>Project Management &amp; Workflow</h2>

<p>Over the course of gSchool, I&rsquo;ve been learning a lot about the social aspect programming. I worked solo in my ealiest projects, then graduated to pairing, and later went on to work in groups of three or four. In the beginning, I was just doing my own thing, but as I started getting into the larger groups, project management became a key skill. I&rsquo;ve found myself in the role of Project Manager in many successive projects. The first couple of times were messy: I didn&rsquo;t make enough space for people to express how they were <em>feeling</em> at our standups, our iteration planning was nonexistent, and I didn&rsquo;t understand how to use Pivotal Tracker at all. As I learned from these experiences, I began to firmly value things like daily standups with technical <em>and</em> emotional checkins, persona and wireframing UX design, iteration planning, proper use of Pivotal Tracker, consistent version control practices, and continuous integration.</p>

<p>We started Planting Season with the best of intentions, but this time around, it proved harder to practice these strategies than I hoped. At our checkins, it was clear that we were all feeling unfocused and pulled in different directions by job applications and interviews, burnout, and Jeff&rsquo;s absence after his wife gave birth to their latest addition to the family. We planned our iterations, but we didn&rsquo;t meet the first one because a couple of us were out of town or at interviews. Soon we fell behind. On top of that, Pivotal Tracker stopped letting us edit our stories, because our free trial was expired. The Travis CI specs wouldn&rsquo;t pass, because the specs couldn&rsquo;t talk to the API (more on this in a minute). Of all the agile practices we hoped to use, only the UX planning went well.</p>

<h2>Nginx, Passenger, and VPS Woes</h2>

<p>Our troubles were compounded by the difficulty of getting our services to talk to each other. Our plan was to run Foreman locally, booting our apps onto different ports on localhost, then use Nginx to route everything through different namespaced routes on port 8080. Getting Foreman up and running was easy enough, but Nginx was a bear to configure. Meanwhile, getting Phusion Passenger and Nginx to play nicely on our VPS was also a struggle. It turns out that you have to install Passenger first, then add Nginx as an extension to it. If you install Nginx first, you end up with two conflicting versions. Additionally, one of our team mates was having RVM issues, and had to reinstall Ruby and all of his gems twice.</p>

<p>In the second week, we lost two solid days of of development time to the fight with the Nginx config file, Passenger, and RVM.</p>

<p>For posterity&rsquo;s sake, here&rsquo;s a snapshot of the <code>nginx.conf</code> file that finally worked for local production:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>worker_processes  1<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>error_log  logs/error.log<span class="p">;</span>
</span><span class='line'><span class="c">#pid        logs/nginx.pid;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections  1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    include       mime.types<span class="p">;</span>
</span><span class='line'>    default_type  application/octet-stream<span class="p">;</span>
</span><span class='line'>    <span class="c">#passenger_root /usr/local/opt/passenger/libexec/lib/phusion_passenger/locations.ini;</span>
</span><span class='line'>    <span class="c">#passenger_ruby /usr/bin/ruby;</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen       8080<span class="p">;</span>
</span><span class='line'>        server_name  localhost<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># PLANTING SEASON</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Landing Page</span>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3000<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Auth</span>
</span><span class='line'>        location /auth <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3001<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Coordinator</span>
</span><span class='line'>        location /dashboard <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3002<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># API</span>
</span><span class='line'>        location /api <span class="o">{</span>
</span><span class='line'>          proxy_pass        http://127.0.0.1:3003<span class="p">;</span>
</span><span class='line'>          proxy_set_header  X-Real-IP  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Troubles</h2>

<p>Once we had the services running on a single port, we figured everything would be gravy. We added the VCR gem to save the results of our API calls, and began testing. We covered the landing page, auth app, and our gem.</p>

<p>Then I started to dig in on some Capybara tests for the coordinator app, and had some major headaches. In order to view the dashboard, I needed to set a signed cookie to simulate the authorization app. Easy enough. All you have to do is use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">set_cookie</span> <span class="s1">&#39;user_id=1&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is, unless you&rsquo;re using Poltergeist for a JS driver. Then, you clearly use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now, I had a different problem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failure/Error: within <span class="s1">&#39;#bed-functions&#39;</span> <span class="k">do</span>
</span><span class='line'>     Capybara::ElementNotFound:
</span><span class='line'>       Unable to find css <span class="s2">&quot;#bed-functions&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the launchy gem and <code>save_and_open_page</code>, <code>#bed-functions</code> was there, all right. I could feel another configuration battle coming on as we headed into the third week.</p>

<h2>Getting Back on the Horse</h2>

<p>On Monday morning of the week the project was due, we had little to show for our two weeks of work. There were services, but they couldn&rsquo;t talk to each other on the server. There were mock-ups, but the CSS wasn&rsquo;t in the views yet. The tests were thin. We had a meeting with Jeff, and told him we planned to bolster the test coverage and solidify what we already had. His advice: &ldquo;that would be  a good idea if you had a thing, but right now you don&rsquo;t. You might want to make a thing first.&rdquo;</p>

<p>So we saddled up, and the cowboy coding began.</p>

<h2>jQuery Sparkle</h2>

<p>The next two days were actually pretty fun, if a little painful (coding without tests makes me uncomfortable). We got the CSS hooked up, integrated with the weather service, and added a healthy dose of JavaScript to the dashboard. Although we would have liked to explore Ember.js, we decided to stick to plain old jQuery in the interest of time. We quickly coded 275 lines of jQuery sparkle, and we had a thing! If you&rsquo;re interested, go <a href="http://plantingseason.tk/">check out</a> what we made!</p>

<p>My favorite part was adding the ability to click and drag on the garden bed squares for multi-selection. Here&rsquo;s what that looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">).</span><span class="nx">mousedown</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">thisClass</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">toggleSquare</span><span class="p">(</span><span class="nx">thisClass</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">).</span><span class="nx">mouseenter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">thisClass</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">toggleSquare</span><span class="p">(</span><span class="nx">thisClass</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">mouseup</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">isMouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to see more of what we did with the JS, you can check out the <a href="https://github.com/VirginSoil/planting_season_coordinator/tree/master/app/assets/javascripts">code on GitHub</a>.</p>

<h2>Conclusion</h2>

<p>From the beginning of gSchool, the SOA project was one of the things I was looking forward to the most. Although Jeff said he thought that it was probably &ldquo;not a reasonable thing&rdquo; to start a project from the beginning with SOA, I set out with the highest of expectations. But the problems along the way were numerous.</p>

<p>The job search was a distraction. But more troubling to me was the difficulty of testing. I&rsquo;ve gotten really comfortable with using Travis CI, and driving my development with Pivotal Tracker user stories translated into Capybara feature tests. It was really hard to do with services. Between setting up Passenger and Nginx and the testing troubles, we lost a <em>lot</em> of time on configuration.</p>

<p>Reflecting on the experience, I&rsquo;d say that SOA is probably a practice better left until it is needed. If I were in charge building a new app for a startup, I would still start by iterate on delivering business value with successive MVPs. When I began to feel the pain of scaling, then I would think about splitting off services.</p>

<p>However, it&rsquo;s possible that I&rsquo;ve only come to this conclusion because the process was so painful. There&rsquo;s another way of looking at this.</p>

<p>Here&rsquo;s a lesson that I&rsquo;ve learned about programming again and again over the last six months:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">The</span> <span class="nx">first</span> <span class="nx">time</span> <span class="nx">you</span> <span class="k">do</span> <span class="nx">something</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">hard</span> <span class="nx">and</span> <span class="nx">doesn</span><span class="err">&#39;</span><span class="nx">t</span> <span class="nx">make</span> <span class="nx">any</span> <span class="nx">sense</span><span class="p">.</span>
</span><span class='line'><span class="nx">The</span> <span class="nx">second</span> <span class="nx">time</span> <span class="nx">you</span> <span class="k">do</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">seems</span> <span class="nx">vaguely</span> <span class="nx">familiar</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">makes</span> <span class="nx">a</span> <span class="nx">little</span> <span class="nx">bit</span> <span class="nx">of</span> <span class="nx">sense</span><span class="p">.</span>
</span><span class='line'><span class="nx">From</span> <span class="nx">then</span> <span class="nx">on</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">makes</span> <span class="nx">sense</span> <span class="nx">and</span> <span class="nx">feels</span> <span class="nx">natural</span> <span class="nx">to</span> <span class="k">do</span> <span class="nx">it</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>If this is true (which it seems to be for me), then it might actually make sense to build apps using services from the get go, if you expect them to have to scale down the road. I&rsquo;d love to nail down a workflow for getting Passenger, Foreman, and Nginx set up in less than 30 minutes. I&rsquo;d also like to learn how to better test services and get them set up with continuous integration. I think that if I understood these things, SOA would be a tool I&rsquo;d be a lot more likely to reach for.</p>

<p>If you have any tips about these two aspects of services, let&rsquo;s talk! Tweet at me: @fluxusfrequency.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Building a Binary Search]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/31/building-a-binary-search/"/>
    
    <updated>2014-01-31T10:34:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/31/building-a-binary-search</id>
    
    <content type="html"><![CDATA[<p>A couple of days ago I had an interview with a big startup in Boulder. I was really excited about the possibility of working there, because they solve some <em>really</em> hard problems on a daily basis, and because I&rsquo;ve heard great things about their office culture.</p>

<p>It was just supposed to be a quick interview, but it ended up taking a few hours. First, I met up with the CTO. It all started off innocent enough. We went to a restaurant on Pearl Street for lunch. He asked me about my background and skills, and I asked him about the company. We shared personal stories about the flood last summer. After hearing about the way he treats his workers (like adults), and some of the technical details of what they were working on, I was even more excited about the company. We headed went to a coffee shop for a drink, then went back to the office.</p>

<p>When we got there, he introduced me to the head of the team that the best fit for me if I worked there. The team lead, one of his coworkers and I headed back to the coffee shop. We chatted about Rails, <a href="http://www.exercism.io">Exercism</a>, TDD, and Ember.js, and life at their company. Pretty soon, the CTO came in again. Seeing that we were still talking, he asked the team lead to take me back and &ldquo;dig in technically&rdquo; a little bit.</p>

<p>We went back to the office again, and found a conference room. He asked me to solve <a href="http://en.wikipedia.org/wiki/Fizz_buzz">FizzBuzz</a> in JavaScript. I fired up Jasmine-Node and built it with tests the whole way. That went fairly well, I thought. Then he asked me a couple of CSS questions. I answered them, and he said that I answered them better than many of the people he interviews.</p>

<p>Finally, we came to some algorithm questions. Although I&rsquo;ve learned a lot at gSchool in the last five months, algorithms are something that I haven&rsquo;t spent as much time on, yet. I&rsquo;ve only had enough programming context to begin understanding them for the last two of those months. I&rsquo;ve played around with them as much as I could, solving Linked List, the Luhn Algorithm, Nth Prime Factor, Sum of Squares, and Binary Search Tree. I&rsquo;ve also had a go at writing the MD5 algorithm. But compared to someone with a four year CS degree, I haven&rsquo;t had much time to get comfortable with them.</p>

<p>My interviewer drew an array on the board, and asked me how I would find a given element&rsquo;s position within 2-3 queries. I thought about it, made a guess that it had to do with bit operators, and finally conceded that I had no idea. My heart sunk. Things were going so well. When I asked for the solution, he told me that it was to use a Binary Search. I got excited, because I <em>had</em> done a Binary Search Tree. But no, this was just plain old Binary Search.</p>

<p>Bitten that I didn&rsquo;t know how to do Binary Search, I set out to build it on my own. This rest of this post is a walkthrough of how I solved it.</p>

<h2>Research</h2>

<p>First, I visited Wikipedia and read up on <a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">Binary Search</a>. It was pretty easy to follow. So easy, in fact, I decided to lift some of the text verbatim and translate it into a set of tests to drive my implementation. Here&rsquo;s what I found:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Searching a sorted collection is a common task. A dictionary is a sorted list of
</span><span class='line'> word definitions. Given a word, one can find its definition. A telephone book
</span><span class='line'> is a sorted list of people's names, addresses, and telephone numbers. Knowing
</span><span class='line'> someone's name allows one to quickly find their telephone number and address.
</span><span class='line'>
</span><span class='line'>If the list to be searched contains more than a few items (a dozen, say) a
</span><span class='line'>binary search will require far fewer comparisons than a linear search, but it
</span><span class='line'>imposes the requirement that the list be sorted.
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>In computer science, a binary search or half-interval search algorithm finds
</span><span class='line'>the position of a specified input value (the search "key") within an array
</span><span class='line'>sorted by key value.
</span><span class='line'>
</span><span class='line'>In each step, the algorithm compares the search key value with the key value of
</span><span class='line'>the middle element of the array.
</span><span class='line'>
</span><span class='line'>If the keys match, then a matching element has been found and its index, or
</span><span class='line'>position, is returned.
</span><span class='line'>
</span><span class='line'>Otherwise, if the search key is less than the middle element's key, then the
</span><span class='line'>algorithm repeats its action on the sub-array to the left of the middle element
</span><span class='line'>or, if the search key is greater, on the sub-array to the right.
</span><span class='line'>
</span><span class='line'>If the remaining array to be searched is empty, then the key cannot be found in
</span><span class='line'>the array and a special "not found" indication is returned.
</span><span class='line'>
</span><span class='line'>A binary search halves the number of items to check with each iteration, so
</span><span class='line'>locating an item (or determining its absence) takes logarithmic time. A binary
</span><span class='line'>search is a dichotomic divide and conquer search algorithm.</span></code></pre></td></tr></table></div></figure>


<p>I decided to take this step-by-step description and turn each step into a test.</p>

<h2>Setting Up the Binary Search Test &amp; Class</h2>

<p>The first step was to create an object that knew about &ldquo;an array sorted by key value&rdquo;, or as I like to call it, a list. I wrote a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearchTest</span> <span class="o">&lt;</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_has_list_data</span>
</span><span class='line'>    <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">list</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And a class to make it pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@list</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That was easy! Next, it needed to be able to check whether the list was actually sorted, so I wrote a test to make sure it would throw an error if it wasn&rsquo;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_raises_error_for_unsorted_list</span>
</span><span class='line'>  <span class="n">assert_raises</span> <span class="no">ArgumentError</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make it pass, I implemented the following check: compare the input with itself in sorted form. Not that elegant, but it worked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ArgumentError</span> <span class="k">unless</span> <span class="n">data</span><span class="o">.</span><span class="n">sort</span> <span class="o">==</span> <span class="n">data</span>
</span><span class='line'>    <span class="vi">@list</span> <span class="o">=</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>According to the Wikipedia article, the algorithm was going to have to find &ldquo;the key value of the middle element of the array&rdquo;. So I wrote a test to make sure that it knew where the middle of its list was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_of_middle_item</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">3</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">middle</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was fairly trivial to solve:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BinarySearch</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:list</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">middle</span>
</span><span class='line'>    <span class="n">list</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the class all set up, I turned my attention to the actual search algorithm itself.</p>

<h2>Building the Search Algorithm</h2>

<p>The goal was to search for the index of a specific element, so I wrote a test for a method that did that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_of_search_data</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">5</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next came the hard part. I took the text from Wikipedia and broke it down into pseudo-code:</p>

<ul>
<li>Get the search value</li>
<li>Find the middle element in the list</li>
<li>Check if they are equal</li>
<li>If they are equal, return the position of the middle element in the list</li>
<li>If they are not equal, branch:</li>
</ul>


<p>If the search key is less than the middle index:</p>

<ul>
<li>Cut the list we&rsquo;re searching in half</li>
<li>Instantiate a new BinarySearch</li>
<li>Pass the first half of the list into it</li>
<li>Call the search method on the new object, with the same search key</li>
<li>Repeat until the keys are equal</li>
<li>If they&rsquo;re never equal, raise &ldquo;Not Found&rdquo;</li>
</ul>


<p>If the search key is more than the middle index:</p>

<ul>
<li>Cut the list we&rsquo;re searching in half</li>
<li>Instantiate a new BinarySearch</li>
<li>Pass the second half of the list into it</li>
<li>Call the search method on the new object, with the same search key</li>
<li>Repeat until the keys are equal</li>
<li>If they&rsquo;re never equal, raise &ldquo;Not Found&rdquo;</li>
</ul>


<p>With this plan in place, I started to build the method. First, I created the method and passed in the search key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I checked it against the middle element in the list, returning the index if they were equal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next thing on my to do list was to branch for the other two conditions: whether the key was less than or greater than the middle value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># ???</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># ???</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I filled in the branches some more of my pseudo-code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the second half of the list into it</span>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I filled them in with real code, one step at a time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">search</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># Cut the list we&#39;re searching in half</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Instantiate a new BinarySearch</span>
</span><span class='line'>    <span class="c1"># Pass the first half of the list into it</span>
</span><span class='line'>    <span class="n">search</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Call the search on the new object, with the same search key</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">search</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Seeing some duplication here, I went ahead and refactored:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to run the tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Expected: 5
</span><span class='line'>  Actual: 2
</span></code></pre></td></tr></table></div></figure>


<p>Fail.</p>

<p>Why? I did some <code>pry</code> action and discovered that I was getting back the index of the <em>new</em> list&rsquo;s middle element, not the <em>original</em> list&rsquo;s middle element. To fix this, I added the current list&rsquo;s middle to the recursive call. That meant undoing my refactor. I guess I refactored too soon.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">middle</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The tests were now passing. Good. Time to try with another example. This time looking for keys on both sides of the middle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_in_a_larger_list</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whoops! <code>stack level too deep</code>! I forgot to change value of the search on line 3. I was getting an infinite loop when I searched for a bad value. I skipped this test and wrote one for the bad search condition, instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_raises_error_for_data_not_in_list</span>
</span><span class='line'>  <span class="n">assert_raises</span> <span class="no">RuntimeError</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make this pass, I had to validate that the search wasn&rsquo;t stuck looking through the same sublist over and over:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">middle</span> <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">==</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.middle</span><span class="o">]</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Not Found&quot;</span> <span class="k">if</span> <span class="n">sublist</span> <span class="o">==</span> <span class="n">list</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">sublist</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">middle</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">raise</span> <span class="s2">&quot;Not Found&quot;</span> <span class="k">if</span> <span class="n">sublist</span> <span class="o">==</span> <span class="n">list</span>
</span><span class='line'>    <span class="k">return</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">middle</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It passed! I went back and rewrote the other test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_position_in_a_larger_list</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">7</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Passed again! How about one more for good measure? I also wanted to check if the middle was still coming out right when I passed in a list with an even number of elements. All the others had been of an odd length.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_it_finds_correct_position_in_a_list_with_an_even_number_of_elements</span>
</span><span class='line'>  <span class="n">binary</span> <span class="o">=</span> <span class="no">BinarySearch</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">377</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">5</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">6</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok! Green!</p>

<h2>Conclusion</h2>

<p>Even if I didn&rsquo;t know my stuff in the conference room at that moment, I&rsquo;m glad that my interviewer asked me about Binary Search. It was fun to learn, and it turned out to be a little easier than I expected. I always expect algorithms to be really hard to grasp, but maybe now that I&rsquo;ve done a few algorithms that use recursion, it&rsquo;s not such a jump for me to understand it.</p>

<p>At any rate, it&rsquo;s pretty cool to be able to find an element in a list with so few queries. Lately, I&rsquo;ve really been enjoying pure math programming problems like this one. I&rsquo;m going to try to find a few more like this to do in the near future.</p>

<h2>Footnote</h2>

<p>Since I had already done all of the work, I went ahead and submitted this as a new exercise for <a href="http://www.exercism.io">Exercism.io</a>. So, if you use Exercism, and you enjoy doing algorithms, I&rsquo;d suggest giving Binary Search a go yourself. If you get stuck, you know where to find the answer!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Refactoring 4: Remove Middle Man]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/27/refactoring-4-remove-middle-man/"/>
    
    <updated>2014-01-27T19:34:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/27/refactoring-4-remove-middle-man</id>
    
    <content type="html"><![CDATA[<p>Today, in my latest journey on the <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactor</a> Tractor, I&rsquo;ll be taking a look at a strategy called Move Method.</p>

<p>Move Method is used to help remove duplication. Sometimes, in the interest of encapsulation, it&rsquo;s a good idea to make an object as unaware of another object as possible. If the first needs to access the second, though, it may have to &ldquo;reach through&rdquo; a third object. If this reaching is minimal, it can sometimes be a worthwhile trade off. But when it becomes an ongoing pattern, you can end up with a lot of duplication. And a lot of what my teacher Franklin Webber calls &ldquo;bad touching&rdquo;. The Refactoring book points out that &ldquo;it&rsquo;s hard to figure out what the right amount of hiding is&rdquo;,  but it&rsquo;s easy to change your mind with refactoring. Using a combination of this strategy and Hide Delegate, you can always change it again later.</p>

<p>Today I&rsquo;ll be practicing Remove Middle Man on another example from the <a href="https://github.com/fluxusfrequency/mancala">Mancala</a> app I was refactoring in my recent post: <a href="fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/">Refactoring 2 - Replace Method With Method Object</a>.</p>

<p>Here are the steps to Remove Middle Man:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Create an accessor for the delegate.
</span><span class='line'>
</span><span class='line'>2. For each client use of a delegate method, remove the method from the server and replace the call in the client to call the method on the delegate.
</span><span class='line'>
</span><span class='line'>3. Test after each method.
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s fairly cryptic. I think it means: just pass a reference to the distant object into the first object, and access it directly (instead of through object two).</p>

<h2>Mancala Game View</h2>

<p>There are many poorly-built parts to Mancala. That&rsquo;s probably because I didn&rsquo;t test it at all as I was writing it. At the time, I thought I was taking a shortcut. In reality, I was making a big mess that was difficult to understand and deal with. I didn&rsquo;t realize it at the time, but <a href="http://blog.testdouble.com/posts/2014-01-25-the-failures-of-intro-to-tdd.html">&ldquo;TDD&rsquo;s primary benefit is to improve the design of our code&rdquo;</a>.</p>

<p>One of my poorly designed classes is called the MancalaGameView. Its job is to draw the beads in their respective pits, and print the winner to the screen, using <a href="https://github.com/jashkenas/ruby-processing">Ruby Processing</a>. Here&rsquo;s the problem with my design: I pass in the &lsquo;app&rsquo; object, then call through it to get information about the &lsquo;rules&rsquo; and &lsquo;model&rsquo; objects. Here&rsquo;s what it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">fill</span> <span class="mi">225</span>
</span><span class='line'>    <span class="n">n</span> <span class="o">=</span> <span class="n">pit</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">9</span>
</span><span class='line'>      <span class="n">draw_x_beads</span><span class="p">(</span><span class="n">pit</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">draw_many_beads</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fill_a_random_color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">store</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">draw_beads_in_player_one_store</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">store</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span>
</span><span class='line'>      <span class="n">draw_beads_in_player_two_store</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">475</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Player two is the winner!&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">250</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">475</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The calls to <code>app.fill</code> and <code>app.text</code> are built into Ruby Processing. Outside of that, I&rsquo;m not going to get into the details of what some of these methods, like <code>draw_x_beads</code> and <code>draw_beads_in_player_one_store</code>. Because the coupling in this app is so high, it would require pulling in too many methods.</p>

<h2>Setting Up the Test</h2>

<p>I&rsquo;m going to stub out a few things, so that we can build a test without having to drag in the rest of the app and the Ruby Processing Gem.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Player one is the winner!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Player two is the winner!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;Tie Game!&quot;</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">all_pits</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">all_stores</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Ruler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">winner</span>
</span><span class='line'>    <span class="n">winners</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:player_1</span><span class="p">,</span> <span class="ss">:player_2</span><span class="p">,</span> <span class="ss">:tie</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@winner</span> <span class="o">||=</span> <span class="n">winners</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">game_over?</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now, to build a test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="no">Model</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="no">Ruler</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@model</span><span class="p">,</span> <span class="vi">@ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_draw_all_beads_succeeds</span>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span> <span class="s2">&quot;Player two is the winner!&quot;</span><span class="p">,</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="vi">@view</span><span class="o">.</span><span class="n">draw_all_beads</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">expected</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>This test is green. I don&rsquo;t like to start from green. It&rsquo;s supposed to be: &ldquo;red, green, refactor&rdquo;! I could comment out some code or change <code>game_over?</code> to false, but that wouldn&rsquo;t prove anything about the code. Since this is an instance of Test After, and the code is already understood, I&rsquo;m feel comfortable going forward from green here.</p>

<h2>Applying the Strategy</h2>

<p>Now, to begin removing the middle man object, <code>app</code>. There are two classes I&rsquo;m accessing through <code>app</code>: <code>Model</code> and <code>Ruler</code>. I&rsquo;ll extract them one at a time, beginning with <code>Model</code>. The first step is to &ldquo;create an accessor for the delegate&rdquo;. I could just do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">model</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">model</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But I would rather pass the model into the MancalaGameView directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step two is to change &ldquo;client&rdquo; calls so that they use the new accessor instead of calling through the &ldquo;server&rdquo; (which is <code>app</code> in this case). Step three is to test after each method. So here we go:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def draw_all_beads</span>
</span><span class='line'><span class="c1">#   app.model.all_pits.each do |pit|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_pit(pit)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   app.model.all_stores.each do |store|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_store(store)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   print_winner if app.ruler.game_over?</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s30.postimg.org/va1jflych/red_pattern.jpg" title="Red Tests" alt="The color red"></p>

<p>The test fails with: <code>wrong number of arguments (1 for 2)</code>. The problem lies in the test setup. I now need to pass in the model when I create the <code>MancalaGameView</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="c1"># Code omitted</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>Ahh, that&rsquo;s better. Now to repeat the process with the <code>ruler</code>. Step one: create the accessor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Steps two and three: replace the method calls to use the accessor instead of reaching through <code>app</code>. Test after each step.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="c1"># Code omitted</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s30.postimg.org/va1jflych/red_pattern.jpg" title="Red Tests" alt="The color red"></p>

<p>It fails, because I&rsquo;m not passing <code>ruler</code> into the test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GameViewTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="c1"># Code omitted</span>
</span><span class='line'>    <span class="vi">@view</span> <span class="o">=</span> <span class="no">MancalaGameView</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="vi">@app</span><span class="o">.</span><span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>That gets me back to green. Now to refactor the <code>print_winner</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def print_winner</span>
</span><span class='line'><span class="c1">#   return &quot;Player one is the winner!&quot; if app.ruler.winner == :player_1</span>
</span><span class='line'><span class="c1">#   return &quot;Player two is the winner!&quot; if app.ruler.winner == :player_2</span>
</span><span class='line'><span class="c1">#   return &quot;Tie Game!&quot; if app.ruler.winner == :tie</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Player one is the winner!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_1</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Player two is the winner!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:player_2</span>
</span><span class='line'>  <span class="k">return</span> <span class="s2">&quot;Tie Game!&quot;</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">winner</span> <span class="o">==</span> <span class="ss">:tie</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s15.postimg.org/uh17pf8ij/Green_Pattern.jpg" title="All Green" alt="The color green"></p>

<p>Success! That was pretty easy.</p>

<h2>Further Refactoring</h2>

<p>Now that I&rsquo;ve cleaned up the MancalaGameView somewhat, I&rsquo;m going to refactor a few other things. Along the way, I noticed that <code>print_winner</code> is pretty ugly, so I changed it to use a hash lookup instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def print_winner</span>
</span><span class='line'><span class="c1">#   return &quot;Player one is the winner!&quot; if ruler.winner == :player_1</span>
</span><span class='line'><span class="c1">#   return &quot;Player two is the winner!&quot; if ruler.winner == :player_2</span>
</span><span class='line'><span class="c1">#   return &quot;Tie Game!&quot; if ruler.winner == :tie</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>  <span class="n">win_messages</span><span class="o">[</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">win_messages</span>
</span><span class='line'>  <span class="p">{</span> <span class="ss">:player_1</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:player_2</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:tie</span>      <span class="o">=&gt;</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also decided to use extract method on the loops in <code>draw_all_beads</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># OLD VERSION</span>
</span><span class='line'><span class="c1"># def draw_all_beads</span>
</span><span class='line'><span class="c1">#   model.all_pits.each do |pit|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_pit(pit)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   model.all_stores.each do |store|</span>
</span><span class='line'><span class="c1">#     draw_beads_in_store(store)</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1">#   print_winner if ruler.game_over?</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>  <span class="n">draw_pits</span>
</span><span class='line'>  <span class="n">draw_stores</span>
</span><span class='line'>  <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_pits</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_stores</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>    <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s much better. Here&rsquo;s the final result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaGameView</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:ruler</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ruler</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
</span><span class='line'>    <span class="vi">@ruler</span> <span class="o">=</span> <span class="n">ruler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_all_beads</span>
</span><span class='line'>    <span class="n">draw_pits</span>
</span><span class='line'>    <span class="n">draw_stores</span>
</span><span class='line'>    <span class="n">print_winner</span> <span class="k">if</span> <span class="n">ruler</span><span class="o">.</span><span class="n">game_over?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_winner</span>
</span><span class='line'>    <span class="n">win_messages</span><span class="o">[</span><span class="n">ruler</span><span class="o">.</span><span class="n">winner</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_pits</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">all_pits</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pit</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_pit</span><span class="p">(</span><span class="n">pit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw_stores</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">all_stores</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">store</span><span class="o">|</span>
</span><span class='line'>      <span class="n">draw_beads_in_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">win_messages</span>
</span><span class='line'>    <span class="p">{</span> <span class="ss">:player_1</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:player_2</span> <span class="o">=&gt;</span> <span class="s2">&quot;Player one is the winner!&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:tie</span>      <span class="o">=&gt;</span> <span class="s2">&quot;Tie Game!&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Remove Middle Man was really easy to use. Maybe it&rsquo;s because I&rsquo;ve heard Franklin harp on the evils of &ldquo;bad touching&rdquo; so much, or maybe it&rsquo;s just that I&rsquo;m violating the Law of Demeter, but I start to feel pretty nervous when I see two dots in my method calls. This was a quick and easy refactor that I&rsquo;m sure I&rsquo;ll use regularly. Since it sets you up for <a href="http://codeulate.com/2013/01/a-criticism-of-dhhs-post-on-dependency-injection/">Dependency Injection</a>, it also opens up the class&rsquo;s possibilities for <a href="http://en.wikipedia.org/wiki/Duck_typing">Duck Typing</a> and easy mocking.</p>

<p>As I continue to code and refactor, Remove Middle Man will be a vital tool in my tool kit.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Refactoring 3 - Introduce Named Parameter / Introduce Class Annotation]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/18/refactoring-3-introduce-named-parameter-and-introduce-class-annotation/"/>
    
    <updated>2014-01-18T13:22:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/18/refactoring-3-introduce-named-parameter-and-introduce-class-annotation</id>
    
    <content type="html"><![CDATA[<p>I&rsquo;ve been trying to get better at refactoring lately. To do that, I&rsquo;m digging into my old code from the first months of gSchool and applying strategies from <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactoring Ruby</a> by Jay Fields, Shane Harvie, Martin Folwer, and Kent Beck.</p>

<p>Just a couple of days ago I posted about trying out <a href="http://fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/">Replace Method with Method Object</a>. Almost immediately afterwards, I read about two more strategies that seemed like they would fit well with the same refactoring example, so I thought I&rsquo;d give them a try: Introduce Named Parameter and Introduce Class Annotation.</p>

<h2>Introduce Named Parameter</h2>

<p>According to the book, naming your parameters is a good thing to do if you want to improve the readability of a method. Using it prevents the work of having to go searching through dependency objects to figure out what&rsquo;s going on. It works easily with the new <code>BeadDistributor</code> class I created in my last article. Here&rsquo;s that code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compute</span>
</span><span class='line'>    <span class="n">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="n">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">distribute_beads</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads</span>
</span><span class='line'>    <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="n">rules</span><span class="o">.</span><span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">add_bead_to_model</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">next_pit_id</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">find_next_pit_in_model</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="k">if</span> <span class="n">landed_on_players_own_empty_pit?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_players_own_empty_pit?</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">check_if_pit_belongs_to_player</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landing_spot</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">||=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The most important parts here will be the <code>attr_reader</code>s and the <code>initialize</code> method.</p>

<p>Here are the steps for Introduce Named Parameter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Choose the parameters that you want to name. If you are not naming all of the parameters, move the parameters that you want to name to the end of the parameter list.
</span><span class='line'>
</span><span class='line'>2. Test
</span><span class='line'>
</span><span class='line'>3. Replace the parameters in the calling code with name/value pairs.
</span><span class='line'>
</span><span class='line'>4. Replace the parameters with a Hash object in the receiving method. Modify the receiving method to use the new Hash.
</span><span class='line'>
</span><span class='line'>5. Test.
</span></code></pre></td></tr></table></div></figure>


<p>As always, I started with the tests. They were still passing after my last refactoring adventure:</p>

<p><img src="http://s5.postimg.org/iav0trapz/All_green_start.png" title="All Green to Start" alt="A set of passing Ruby tests"></p>

<p>For the purposes of this example, I wanted to make all of the parameters required, so I skipped steps 1 and 2.</p>

<p>Here are the relevant parts of the code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Replace the params in the calling method with key/value pairs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
</span><span class='line'>      <span class="ss">:rules</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:app</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:first_pit_id</span> <span class="o">=&gt;</span> <span class="n">first_pit_id</span><span class="p">,</span>
</span><span class='line'>      <span class="n">player</span> <span class="o">=&gt;</span> <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="n">count</span><span class="p">})</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 4: Modify the params taken into the receiving object to take a hash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:rules</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:first_pit_id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 5: Test.</p>

<p><img src="http://s5.postimg.org/ypoy6bsp3/Failing_after_first_refactor.png" title="Failing After First Refactor" alt="A set of passing Ruby tests"></p>

<p>The test is failing, because I haven&rsquo;t modified it to send a hash instead of the individual params. After fixing this, it passes again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributorTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_compute_returns_the_correct_count</span>
</span><span class='line'>    <span class="n">rules</span> <span class="o">=</span> <span class="no">MancalaKalahRules</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">player</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">distributor</span> <span class="o">=</span> <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
</span><span class='line'>      <span class="ss">:rules</span> <span class="o">=&gt;</span> <span class="n">rules</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:app</span> <span class="o">=&gt;</span> <span class="n">app</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:player</span> <span class="o">=&gt;</span> <span class="n">player</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="n">count</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="mi">9</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">distributor</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://s5.postimg.org/6e7zn0y6f/Passing_after_test_fix.png" title="Passing After Test Fix" alt="A set of passing Ruby tests"></p>

<p>At this point, everything&rsquo;s working. But why did I do it? If anything, it just added duplication to what was already there. Here&rsquo;s why: you can combine it with the Introduce Class Annotation strategy to DRY up object initialization.</p>

<h2>Introduce Class Annotation</h2>

<p>Although I&rsquo;ve heard from many developers more experienced than I am that metaprogramming is generally a bad idea, I also get the impression that many of them consider doing it anyway a guilty pleasure, particularly in non-production code.</p>

<p>However you feel about it, gird yourself, because we&rsquo;re heading into a little bit of <code>define_method</code> territory.</p>

<p>I&rsquo;m going to use the same annotation the book gives as an example. It&rsquo;s a way of defining a helper along the lines of <code>attr_reader</code>, <code>attr_writer</code>, and <code>attr_successor</code>. In it, you wrap all of the object initialization code into a neat new method called <code>hash_initializer</code>.</p>

<p>Here are the steps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Decide on the signature of your class annotation. Declare it in the appropriate class.
</span><span class='line'>
</span><span class='line'>2. Convert the original method to a class method. Make the apppropriate changes so that the method works at the class scope.
</span><span class='line'>
</span><span class='line'>3. Test.
</span><span class='line'>
</span><span class='line'>4. Consider using Extract Module on the class method to make the annotation more prominent in your class definition.
</span></code></pre></td></tr></table></div></figure>


<p>Here we go.</p>

<p>Step 1: Declare the new class annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:rules</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:first_pit_id</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:player</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:count</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 2: Convert the method to a class method. I also called the <code>hash_initializer</code> at the top of the <code>BeadDistributor</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hash_initializer</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Test.</p>

<p>All green!</p>

<p><img src="http://s5.postimg.org/lqrqh1xc7/Passing_after_metaprogramming.png" title="Passing After Metaprogramming" alt="A set of passing Ruby tests"></p>

<p>Step 4: Extract the class annotation into a module.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomInitializers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hash_initializer</span><span class="p">(</span><span class="o">*</span><span class="n">attribute_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span><span class="p">(</span><span class="ss">:initialize</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">attribute_names</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute_name</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">CustomInitializers</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hash_initializer</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity.</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To me, the module you get at the end is like the gift that keeps on giving. Now I have a cool utility modult that I can use in other objects that take a hash of parameters. Right away, I can think of a program where I can use it in at least six classes.</p>

<p>Running the tests once more, everything is still cool.</p>

<p><img src="http://s5.postimg.org/i8fqknwg7/Everything_is_still_cool.png" title="Everything is Still Cool" alt="A set of passing Ruby tests"></p>

<h2>Conclusion</h2>

<p>As I got toward the end of the fifth chapter, Refactoring got pretty deep into some <code>method_missing</code> and <code>define_method</code> metaprogramming madness. While I can&rsquo;t say I&rsquo;m very excited to use these things in my day-to-day refactoring, it&rsquo;s nice to have them there as a reference in case I ever need them. If nothing else, tricks like the ones I tried out here help me think about the relationships between classes in new ways. Next week, I&rsquo;ll try some strategies from the next chapter: &ldquo;Moving Features Between Objects&rdquo;.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Refactoring 2: Replace Method with Method Object]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/"/>
    
    <updated>2014-01-17T09:06:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object</id>
    
    <content type="html"><![CDATA[<p>As I mentioned last week, I&rsquo;m doing a series of posts on refactoring. As gSchool wraps up, I&rsquo;m working on my refactoring skills, so that I&rsquo;ll be a better developer when I get my first job. I&rsquo;m trying some of the strategies outlined in the book <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactoring Ruby</a>.</p>

<p>Today I&rsquo;ll be trying out a strategy called Replace Method with Method Object. This is a good approach to take when you have a long method with many variables in it, and using <a href="http://fluxusfrequency.github.io/blog/2014/01/10/refactoring-1-extract-method/">Extract Method</a> wouldn&rsquo;t be practical. Essentially, it consists of removing the method from its class and turning it into a class of its own. From there, you can more easily refactor using Extract Method and other simple strategies.</p>

<p>Here are the steps as outlined in the book:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Create a new class, name it after the method.
</span><span class='line'>
</span><span class='line'>2. Give the new class an attribute for the object that hosted the original method (the source object) and an attribute for each temporary vairable and each parameter in the method.
</span><span class='line'>
</span><span class='line'>3. Give the new class a constructor that takes the source object and each parameter.
</span><span class='line'>
</span><span class='line'>4. Give the new class a method named "compute".
</span><span class='line'>
</span><span class='line'>5. Copy the body of the original method into "compute". Use the source object instance variable for any invocations of methods on the original subject.
</span><span class='line'>
</span><span class='line'>6. Test.
</span><span class='line'>
</span><span class='line'>7. Replace the old method with one that creates the new method and call "compute".
</span></code></pre></td></tr></table></div></figure>


<h2>Mancala</h2>

<p>I took a look around my Github repositories, and found this little wonder from a <a href="https://github.com/fluxusfrequency/mancala">Mancala</a> app I wrote in Ruby Processing during the first month of gSchool.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">while</span> <span class="vi">@i</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="k">break</span> <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_bead_to_pit</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What a mess.</p>

<h2>Setting Up Tests</h2>

<p>To begin the refactoring process, I had to make sure the tests were in place first. This was fairly difficult, as this method is highly coupled to other methods throughout the app. For testing purposes, I added a couple of stubbed methods to <code>KalahRules</code>, and created dummy <code>App</code> and <code>Model</code> classes with stubbed methods of their own. Also, <code>distribute_beads_for_player</code> did not return anything meaningful, so I changed it to do return the value of <code>@i</code>.</p>

<p>In the end, here&rsquo;s the code I used to make the test pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/pride&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./kalah_rules&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">KalahRulesTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_distribute_beads_for_player_returns_the_correct_count</span>
</span><span class='line'>    <span class="n">rules</span> <span class="o">=</span> <span class="no">MancalaKalahRules</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">player</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="mi">9</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">while</span> <span class="vi">@i</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="k">break</span> <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_bead_to_pit</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">execute_store_logic</span><span class="p">(</span><span class="n">pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_sides</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_empty?</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">model</span>
</span><span class='line'>    <span class="no">Model</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_next_pit_by_id</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="mi">3</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_bead_to_pit</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>All green! Time to start refactoring!</p>

<p><img src="http://s5.postimg.org/540zghpmv/All_green_before_refactor.png" title="All Green Before Refactor" alt="A set of passing Ruby tests"></p>

<h2>Applying the Strategy</h2>

<p>Step 1: Create a new class named after the method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 2: Give the new class an attribute of the source object and its parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Give the new class a constructor that takes the new attributes. I chose to add attr_readers as well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 4: Give the new class a <em>compute</em> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 5: Copy the original method into <em>compute</em>. I also copied in the stubbed methods for testing purposes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Code omitted for brevity</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compute</span>
</span><span class='line'>    <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">while</span> <span class="vi">@i</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="k">break</span> <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_bead_to_pit</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">next_pit_id</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@i</span> <span class="o">==</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">execute_store_logic</span><span class="p">(</span><span class="n">pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_sides</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_empty?</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 6: Test. I tested the newly created <code>BeadDistributor</code> class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributorTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_compute_returns_the_correct_count</span>
</span><span class='line'>    <span class="n">rules</span> <span class="o">=</span> <span class="no">MancalaKalahRules</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">player</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">distributor</span> <span class="o">=</span> <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expected</span> <span class="o">=</span> <span class="mi">9</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">distributor</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>All green!</p>

<p><img src="http://s5.postimg.org/s81g92sxz/All_green_after_refactor.png" title="All Green After Refactor" alt="A set of passing Ruby tests"></p>

<p>Step 7: Replace the old method by instantiating the new object, passing the old object into it, and calling <em>compute</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, I ran the test2 again. The original one passed! Yay!</p>

<p><img src="http://s5.postimg.org/f55tpt2pz/Still_green.png" title="Still Green" alt="Another set of passing Ruby tests"></p>

<p>After completing the object extraction, I was free to refactor the new BeadDistributor using more common strategies. Here&rsquo;s what I ended up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BeadDistributor</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:rules</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:app</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:first_pit_id</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:player</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@rules</span> <span class="o">=</span> <span class="n">rules</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="vi">@first_pit_id</span> <span class="o">=</span> <span class="n">first_pit_id</span>
</span><span class='line'>    <span class="vi">@player</span> <span class="o">=</span> <span class="n">player</span>
</span><span class='line'>    <span class="vi">@count</span> <span class="o">=</span> <span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compute</span>
</span><span class='line'>    <span class="n">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="n">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">distribute_beads</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads</span>
</span><span class='line'>    <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="n">rules</span><span class="o">.</span><span class="n">execute_store_logic</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="n">app</span><span class="o">.</span><span class="n">add_bead_to_model</span><span class="p">(</span><span class="n">next_pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">next_pit_id</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">find_next_pit_in_model</span><span class="p">(</span><span class="n">first_pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_if_own_empty</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">take_both_sides</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="k">if</span> <span class="n">landed_on_players_own_empty_pit?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_players_own_empty_pit?</span>
</span><span class='line'>    <span class="n">rules</span><span class="o">.</span><span class="n">landed_on_empty?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="n">check_if_pit_belongs_to_player</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landing_spot</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">||=</span> <span class="n">next_pit_id</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fix_landing_on_spot_12</span>
</span><span class='line'>    <span class="vi">@landing_spot</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">landing_spot</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MancalaKalahRules</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">distribute_beads_for_player</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="no">BeadDistributor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">first_pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">execute_store_logic</span><span class="p">(</span><span class="n">pit_id</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">take_both_sides</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">landed_on_empty?</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
</span><span class='line'>    <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">model</span>
</span><span class='line'>    <span class="no">Model</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_bead_to_model</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">add_bead_to_pit</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_next_pit_in_model</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">find_next_pit_by_id</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">check_if_pit_belongs_to_player</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>    <span class="n">model</span><span class="o">.</span><span class="n">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">landing_spot</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Model</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_next_pit_by_id</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>    <span class="mi">3</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_bead_to_pit</span><span class="p">(</span><span class="n">pit_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_all_pit_ids_on_players_side</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the tests one more time, I saw that everything was still green. Although I could have gone on to refactor some of the other methods in the original class that <code>distribute_beads_for_player</code> was coupled to, I decided to call it a day.</p>

<p><img src="http://s5.postimg.org/8fza9shdz/Final_green.png" title="Final Green" alt="Another set of passing Ruby tests"></p>

<h2>Conclusion</h2>

<p>I enjoyed the Replace Method with Method Object strategy. It&rsquo;s a pretty cool way to think about the microcosm/macrocosm relationship between methods and objects. Although it&rsquo;s not probably useful for every refactoring case, I imagine it would come in really handy when cleaning up a hairy method like <code>distribute_beads_for_player</code>. I&rsquo;m learning a lot from Refactoring Ruby, and I&rsquo;m looking forward to seeing what other strategies it offers.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Refactoring 1: Extract Method]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/10/refactoring-1-extract-method/"/>
    
    <updated>2014-01-10T09:07:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/10/refactoring-1-extract-method</id>
    
    <content type="html"><![CDATA[<p>I&rsquo;m reading <a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactoring Ruby</a> by Jay Fields, Sean Harvie, Martin Fowler and Kent Beck. As I&rsquo;m heading into the last couple of months at gSchool, I want to clean up some of the code I wrote, and practice my refactoring skills. I&rsquo;ll be doing a series of articles detailing the strategies I learn. This is the first.</p>

<p>Today I&rsquo;ll be talking about the &ldquo;Extract Method&rdquo; strategy. Here&rsquo;s how the book describes it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>1. Create a new method, and name it after the intention of the method (name it by what it does, not by how it does it).
</span><span class='line'>If the code you want to extract is very simple, such as a single message or function call, you should extract it if the name of the new method reveals the intention of the code in a better way. If you can’t come up with a more meaningful name, don’t extract the code.
</span><span class='line'>
</span><span class='line'>2. Copy the extracted code from the source method into the new target method.
</span><span class='line'>
</span><span class='line'>3. Scan the extracted code for references to any variables that are local in scope to the source method. These are local variables and parameters to the method.
</span><span class='line'>
</span><span class='line'>4. See whether any temporary variables are used only within this extracted code. If so, declare them in the target method as temporary variables.
</span><span class='line'>
</span><span class='line'>5. Look to see whether any of these local-scope variables are modified by the extracted code. If one variable is modified, see whether you can treat the extracted code as a query and assign the result to the variable con- cerned. If this is awkward, or if there is more than one such variable, you can’t extract the method as it stands. You may need to use Split Tempo- rary Variable and try again. You can eliminate temporary variables with Replace Temp with Query (see the discussion in the examples).
</span><span class='line'>
</span><span class='line'>6. Pass into the target method as parameters local-scope variables that are read from the extracted code.
</span><span class='line'>
</span><span class='line'>7. Replace the extracted code in the source method with a call to the target method.
</span><span class='line'>If you moved any temporary variables over to the target method, look to see whether they were declared outside the extracted code. If so, you can now remove the declaration.
</span><span class='line'>
</span><span class='line'>8. Test.
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s some code from a Sinatra app I wrote early on in gSchool, called <a href="http://ideabox-flux.herokuapp.com">IdeaBox</a>. For this project, we couldn&rsquo;t use ActiveRecord or DataMapper, but had to hand build an ORM.</p>

<p> I selected these methods from my Finders module. They work together to search through a YAML file for records that match a search string. The <code>find_raw</code> method looked really long and complex, so I thought this would be a good place to do some refactoring.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Finders</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_raw</span><span class="p">({</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_raw</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">query_hash</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>        <span class="n">query_string</span> <span class="o">=</span> <span class="n">query_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>        <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>            <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>        <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="o">[]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>My first step was to check the tests for the method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SearchingTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_it_can_search_for_ideas_with_title_description_or_tags</span>
</span><span class='line'>    <span class="no">IdeaStore</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Recreation&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bicycles In The Park&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bike&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="no">IdeaStore</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sundays&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;In the park with George&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;gerschwin&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;park&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">assert_kind_of</span> <span class="no">Idea</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;Gerschwin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To be thorough, I added a a couple of assertions, one to test the title field search, one for cases where there&rsquo;s nothing in the database, and one for a nil search.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">test_search_for_can_find_ideas_by_title_description_or_tags</span>
</span><span class='line'>    <span class="no">IdeaStore</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Recreation&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bicycles In The Park&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bike&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="no">IdeaStore</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
</span><span class='line'>      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sundays&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;In the park with George&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;gerschwin&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;Recreation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;park&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>    <span class="n">assert_kind_of</span> <span class="no">Idea</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;Gerschwin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_search_for_doesnt_blow_up_on_nil</span>
</span><span class='line'>    <span class="no">IdeaStore</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[]</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="s2">&quot;anything&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[]</span><span class="p">,</span> <span class="no">IdeaStore</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This last test broke on <code>undefined method</code>downcase&#8217; for nil`, so I updated the search_for method to protect against nil, and also return empty searched don&rsquo;t yield any results.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_raw</span><span class="p">({</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With tests in place to make sure that I wouldn&rsquo;t break any of the existing functionality, I began to make changes. My first step was to rename the find_raw method to find_yaml_data, reflecting its real intention. I then had to change the method call in <code>search_for</code>.</p>

<p>Beginning the extraction, I created a new method called find_in_database_for_mutliple_queries (step 1) and pulled the code from find_yaml_data into it (step 2).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_yaml_data</span><span class="p">({</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>        <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="o">[]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">query_hash</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>      <span class="n">query_string</span> <span class="o">=</span> <span class="n">query_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">found</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In step 3, I looked at the original method and found that the result of the code now living in <code>find_multiple_queries_in_database</code> was being used on the next line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>    <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, I didn&rsquo;t see any variables used only in the new code that needed to be moved over (step 4), because I&rsquo;d already moved <code>found = []</code>. I could therefore safely skip step 5, which helps deal with any such variables.</p>

<p>Turning my attention to the new method, I identified the <code>query_hash</code> variable as a problem, because the new method didn&rsquo;t know about it. Step 6 has you turn local variables like these into parameters to the new method. Here, I decided to rename it from <code>query_hash</code> to <code>queries</code>, because the fact that it&rsquo;s a hash is an implementation detail.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">queries</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>      <span class="n">query_string</span> <span class="o">=</span> <span class="n">query_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">found</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, in step 7, I made a call to the new method from the body of the old, and assigned it to the local variable needed to pass it to the next line.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>      <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>        <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="o">[]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, I went ahead and ran the tests (step 8). They were failing, but I couldn&rsquo;t tell why because of the begin/end block. I decided to remove it. I wrote it when I was still pretty new to programming, and was afraid of nil.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the tests again, I could now see the error: <code>undefined local variable or method</code>query_hash&#8217;<code>. I saw that I had forgotten to rename the variable in the new method from</code>query_hash<code>to</code>queries`, so I fixed it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">queries</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>      <span class="n">query_string</span> <span class="o">=</span> <span class="n">queries</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">found</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>All of the tests now passed. Looking at my code, I now had:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_yaml_data</span><span class="p">({</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">queries</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>      <span class="n">query_string</span> <span class="o">=</span> <span class="n">queries</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">found</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I still wasn&rsquo;t happy with the complexity, so I decided to extract some more methods. I went after this bit in <code>find_yaml_data</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>    <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I extracted it, following the same process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Step 1: Create a new method</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 2: Copy over the code</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span>
</span><span class='line'>    <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 3: Look for local variables in the source method</span>
</span><span class='line'>  <span class="c1"># Here, there&#39;s one called &#39;found&#39;</span>
</span><span class='line'>  <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>    <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 4: Look for temporary variables in the extracted code.</span>
</span><span class='line'>  <span class="c1"># There aren&#39;t any.</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 5: If any temps are modified, replace them with queries.</span>
</span><span class='line'>  <span class="c1"># Again, there aren&#39;t any.</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 6: Pass locals into the new method as parameters.</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="n">build_idea_from_data</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Step 7: Replace extracted code with a call to</span>
</span><span class='line'>  <span class="c1"># the new method in the source method.</span>
</span><span class='line'>  <span class="c1"># I also renamed the temp from &#39;found&#39; to &#39;ideas&#39; for clarity.</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 8 is to test. All green! Taking another look at the whole thing, I now had this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>     <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>     <span class="n">find_yaml_data</span><span class="p">({</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="n">query</span><span class="p">})</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>     <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">query_hash</span><span class="p">)</span>
</span><span class='line'>     <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>     <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="n">build_idea_from_data</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span><span class='line'>     <span class="n">found</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>     <span class="n">queries</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>       <span class="n">query_string</span> <span class="o">=</span> <span class="n">queries</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>       <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>         <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>           <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>         <span class="k">end</span>
</span><span class='line'>         <span class="n">found</span> <span class="o">&lt;&lt;</span> <span class="n">result</span>
</span><span class='line'>       <span class="k">end</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>     <span class="n">found</span>
</span><span class='line'>   <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>My next thought was to clean up <code>find_multiple_queries_in_database</code>. I started by replacing the #each call with a #map instead. This let me remove all references to the <code>found</code> local variable, and cleaned the whole thing up considerably.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
</span><span class='line'>    <span class="n">queries</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>      <span class="n">query_string</span> <span class="o">=</span> <span class="n">queries</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reflecting further, I saw that the hash I was creating in the <code>search_for</code> method was unneccesary, as all of the values were the same. I moved the keys out into an array, and adjusted the <code>find_yaml_data</code> method to accept a string rather than a hash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_yaml_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fields_to_search</span>
</span><span class='line'>    <span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">find_multiple_queries_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the tests, this wasn&rsquo;t working, as the <code>find_multiple_queries_in_database</code> method still expected a hash. I changed it as well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">find_mutliple_queries_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields_to_search</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I didn&rsquo;t like the name anymore, so I changed it to search_fields_for_query. This last refactoring was a sweeping change, and removing the hash cleaned up a lot of things. All of the tests were still green. The code now looked like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>    <span class="n">find_yaml_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fields_to_search</span>
</span><span class='line'>    <span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_yaml_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields_to_search</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>          <span class="n">idea</span><span class="o">[</span><span class="n">field</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could see that <code>search_fields_for_query</code> still had another candidate for extraction, so I went ahead with it, following the same steps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields_to_search</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>    <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>      <span class="n">idea</span><span class="o">[</span><span class="n">field</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I then realized that I could push the #downcase call from <code>search_for</code> fown into the database query. This cleaned up the former nicely:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">find_yaml_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>    <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>      <span class="n">idea</span><span class="o">[</span><span class="n">field</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since search_for was now just delegating to <code>find_yaml_data</code>, I deleted the latter and pulled its code into <code>search_for</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a finishing touch, I pulled the transformation of raw data into an object out of <code>build_ideas_from_raw_data</code> and into a new method. This increased the lines of code, but I thought it was clearer, and the new method could potentially be reused elsewhere.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Before</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>   <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>     <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># After</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="n">build_idea_from_data</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_idea_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>All tests still green. Here&rsquo;s the final result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">found</span> <span class="o">=</span> <span class="n">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ideas</span> <span class="o">=</span> <span class="n">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>    <span class="n">select_current_portfolio_only</span><span class="p">(</span><span class="n">ideas</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">search_fields_for_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fields_to_search</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
</span><span class='line'>      <span class="n">database</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">fields_to_search</span>
</span><span class='line'>    <span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_query_in_database</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span class='line'>    <span class="n">database</span><span class="o">[</span><span class="s1">&#39;ideas&#39;</span><span class="o">].</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">idea</span><span class="o">|</span>
</span><span class='line'>      <span class="n">idea</span><span class="o">[</span><span class="n">field</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_ideas_from_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">raw</span><span class="o">|</span>
</span><span class='line'>      <span class="n">build_idea_from_data</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_idea_from_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Idea</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahh, much better. Thanks, Extract Method strategy!</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Looking Ahead to the Last Two Months of gSchool]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2014/01/03/looking-ahead-to-the-last-two-months-of-gschool/"/>
    
    <updated>2014-01-03T09:01:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2014/01/03/looking-ahead-to-the-last-two-months-of-gschool</id>
    
    <content type="html"><![CDATA[<p>We&rsquo;re coming into the home stretch at gSchool. With only 56 days left, I&rsquo;m reflecting on what I&rsquo;ve learned so far, and trying to sort out what I want to make of the time I have left.</p>

<h2>Goals - Where I&rsquo;ve Been</h2>

<p>My biggest goals for gSchool have been to become a great developer, and to build a solid foundation for continued learning.</p>

<p>I&rsquo;ve worked hard to get good at pure Ruby, focusing on writing clean, DRY, test-driven code. I&rsquo;ve prioritized learning how to do Rails &ldquo;the right way&rdquo;, and to understand its intricacies. I&rsquo;ve also prioritized JavaScript as a second area of expertise, learning to use it in the DOM, in the context of client-side frameworks, and dabbled in a little bit of Node.js.</p>

<p>So far, I&rsquo;ve been meeting all of these goals. I really enjoy working with these technologies, and am feeling more comfortable with them every day.</p>

<h2>Goals - Where I&rsquo;m Going</h2>

<p>During January and February, I want to continue to hone my skills with Ruby and JavaScript. Now that I understand the basis of these languages, I&rsquo;m working on using the best idioms and designs for each.</p>

<p>I&rsquo;ll keep doing a lot of reading. I&rsquo;ve just completed <a href="http://pragprog.com/book/jvrails2/crafting-rails-4-applications">Crafting Rails 4 Applications</a>, and I&rsquo;m still reading <a href="https://leanpub.com/multi-tenancy-rails">Multitenancy With Rails</a>, and I&rsquo;m excited about starting <a href="http://designpatternsinruby.com/">Design Patterns in Ruby</a> this weekend.</p>

<p>Pure computer science topics have started to interest me lately. I&rsquo;m hoping that Ruby Design Patterns will help me understand patterns like Factories, Facades, and Observers. I&rsquo;ll also continue to look at algorithms. One of my current projects is implementing a linked list in JavaScript. In the future, I&rsquo;ll explore Binary Trees, the A* algorithm, and perhaps the MD5 algorithm.</p>

<h2>Milestones</h2>

<p>For me, the easiest way to break up the coming time is to think of it in terms of the projects we&rsquo;ll complete. We&rsquo;re just starting Feed Engine. After that, it&rsquo;s the Service Oriented Architecture project, then the personal mastery project. Every project in gSchool thus far has built on the last. I&rsquo;m looking forward to growing through each of these remaining experiences.</p>

<h2>How I Will Succeed</h2>

<p>There is little blocking me from succeess, in my mind. As long as I can keep my energy level up, I&rsquo;ll be able to grok everything left on the docket: what it takes to build killer Rails apps, consuming APIs, feeds, and SOAs. Hopefully, I&rsquo;ll pick up a few other tricks along the way. Given the good rest I got over the holidays, I feel refreshed and ready to keep working hard for the last two months, so I feel confident.</p>

<p>The parts of my personality that will best serve me are my stubbornness/tenacity, curiousity and resourcefulness. I find it hard to give up on problems, so I follow through on them. I&rsquo;m always finding new things to learn about, and I&rsquo;m good at finding ways to learn more about the things I&rsquo;m interested in.</p>

<p>Finally, I&rsquo;ve been really interested in productivity lately. Some of my strategies to &ldquo;work smarter, not harder&rdquo; are:</p>

<ul>
<li>Avoid distractions</li>
<li>Use a todo list</li>
<li>Clarify my goals at the start of each day</li>
<li>Stay true to the pomodore timer</li>
</ul>


<p>With the combination of my love for learning and my productivity, I know I&rsquo;ll succeed in the last couple of months as a gSchool student, and will also continue to be a valuable programmer and a life-long learner.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[What I've Been Reading]]></title>
    <link href="http://fluxusfrequency.github.io/blog/2013/12/30/what-ive-been-reading/"/>
    
    <updated>2013-12-30T15:44:00-07:00</updated>
    <id>http://fluxusfrequency.github.io/blog/2013/12/30/what-ive-been-reading</id>
    
    <content type="html"><![CDATA[<p>This post is a list of the books I&rsquo;ve read and am currently reading.</p>

<h2>Currently Reading</h2>

<ul>
<li><a href="http://www.amazon.com/Introduction-Algorithms-Thomas-H-Cormen/dp/0262033844">Introduction to Algorithms</a>, Charles E. Leiserson, Ronald Rivest, Thomas H. Cormen, and Clifford Stein</li>
</ul>


<h2>Previous Titles</h2>

<h3>JavaScript</h3>

<ul>
<li><a href="http://addyosmani.github.io/backbone-fundamentals/">Developing Backbone.js Applications</a>, Addy Osmani</li>
<li><a href="http://eloquentjavascript.net/">Eloquent JavaScript</a>, Marijn Haverbeke</li>
<li><a href="http://www.javascriptenlightenment.com/">JavaScript Enlightenment</a>, Cody Lindley</li>
<li><a href="http://shop.oreilly.com/product/9780596806767.do">JavaScript Patterns</a>, Stoyan Stefanov</li>
<li><a href="http://shop.oreilly.com/product/9780596517748.do">JavaScript: The Good Parts</a>, Douglas Crockford</li>
<li><a href="http://arcturo.github.io/library/coffeescript/">The Little Book on CoffeeScript</a>, Alex MacCaw</li>
<li><a href="http://shop.oreilly.com/product/0636920021506.do">What is Node.js?</a>, Brett McLaughlin</li>
</ul>


<h3>Ruby</h3>

<ul>
<li><a href="http://pragprog.com/book/jvrails2/crafting-rails-4-applications">Crafting Rails 4 Applications</a>, José Valim</li>
<li><a href="http://designpatternsinruby.com/">Design Patterns in Ruby</a>, Russ Olsen</li>
<li><a href="http://eloquentruby.com/">Eloquent Ruby</a>, Russ Olsen</li>
<li><a href="http://www.sitepoint.com/store/jump-start-sinatra/">Jump Start Sinatra</a>, Darren Jones</li>
</ul>


<!-- Multitenancy With Rails](https://leanpub.com/multi-tenancy-rails), Ryan Bigg -->


<ul>
<li><a href="http://www.poodr.com/">Practical Object-Oriented Design in Ruby</a>, Sandi Metz</li>
<li><a href="http://martinfowler.com/books/refactoringRubyEd.html">Refactoring Ruby</a>, Jay Fields, Sean Harvie, Martin Fowler and Kent Beck</li>
<li><a href="http://guides.rubyonrails.org/">The Rails Guides</a>, Open Source</li>
<li><a href="http://www.therailsview.com/">The Rails View</a>, Bruce Williams and John Athayde</li>
<li><a href="http://shop.oreilly.com/product/0636920019664.do">Sinatra: Up and Running</a>, Alan Harris and Konstantin Haase</li>
</ul>


<h3>Design</h3>

<ul>
<li><a href="http://abovethefoldbook.com/">Above the Fold</a>, Brian Miller</li>
<li><a href="http://www.abookapart.com/products/designing-for-emotion">Designing For Emotion</a>, Aaron Walter</li>
<li><a href="http://www.htmlandcssbook.com/">HTML and CSS</a>, Jon Duckett</li>
<li><a href="http://www.amazon.com/The-Non-Designers-Design-Book-Edition/dp/0321534042">The Non-Designer&rsquo;s Design Book</a>, Robin Williams</li>
<li><a href="http://www.amazon.com/The-Principles-Beautiful-Web-Design/dp/098057689X/ref=sr_1_2?ie=UTF8&amp;qid=1385902814&amp;sr=8-2&amp;keywords=sitepoint+web+design">The Principles of Beautiful Web Design</a>, Jason Beaird</li>
</ul>


<h3>Other</h3>

<ul>
<li><a href="http://www.danpink.com/books/drive/">Drive: The Surprising Truth About What Motivates Us</a>, Daniel H. Pink</li>
<li><a href="http://www.amazon.com/How-Count-Programming-Mere-Mortals-ebook/dp/B005DPIKPE/ref=sr_1_1?ie=UTF8&amp;qid=1385903319&amp;sr=8-1&amp;keywords=how+to+count+programming+for+mere+mortals">How to Count (Programming for Mere Mortals)</a>, Steven Frank</li>
<li><a href="http://shop.oreilly.com/product/9780596003425.do">Learning Unix for OS X: Going Deep With the Terminal and Shell</a>, Dave Taylor</li>
<li><a href="http://chadfowler.com/passionate-programmer/">The Passionate Programmer</a>, Chad Fowler</li>
<li><a href="http://37signals.com/rework/">ReWork</a>, Jason Fried and David Heinemeier Hansson</li>
<li><a href="http://www.amazon.com/Test-Driven-Development-By-Example/dp/0321146530">Test Driven Development by Example</a>, Kent Beck</li>
</ul>

]]></content>
    
  </entry>
  
</feed>