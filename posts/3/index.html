
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fluxus Frequency</title>
  <meta name="author" content="Ben Lewis">

  
  <meta name="description" content="This post originally appeared on Engine Yard. Introduction For many of us web developers, we work on the highest levels of abstraction when we &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fluxusfrequency.github.io/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Fluxus Frequency" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
	<div class="header-title"><a href="/">Fluxus Frequency</a></div>


	<br><div class="header-subtitle">How I Hacked The Mainframe</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fluxusfrequency.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/03/26/understanding-rack-apps-and-middleware/">Understanding Rack Apps and Middleware</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-03-26T06:29:45-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/understanding-rack-apps-and-middleware">Engine Yard</a>.</p>

<h2>Introduction</h2>

<p>For many of us web developers, we work on the highest levels of abstraction when we program. Sometimes it&rsquo;s easy to take things for granted. Especially when we&rsquo;re using Rails.</p>

<p>Have you ever dug into the internals of how the request/response cycle works in Rails? I recently realized that I knew almost nothing about how Rack or middlewares work, so I spent a little time finding out. In this post, I&rsquo;ll share what I learned.</p>

<h2>What&rsquo;s Rack?</h2>

<p>Did you know that Rails is a <a href="http://rack.github.io/">Rack</a> app? Sinatra too. What is Rack? I&rsquo;m glad you asked. Rack is a Ruby package that provides an easy-to-use interface to the Ruby <a href="http://ruby-doc.org/stdlib-2.2.0/libdoc/net/http/rdoc/Net/HTTP.html">Net::HTTP</a> library.</p>

<p>It&rsquo;s possible to quickly build simple web applications using just Rack.</p>

<p>To get started, all you need is an object that responds to a <code>call</code> method, taking in an environment hash and returning an Array with the HTTP response code, headers, and response body. Once you&rsquo;ve written the server code, all you have to do is boot it up with a Ruby server like <code>Rack::Handler::WEBrick</code>, or put it into a <code>config.ru</code> file and run it from the command line with <code>rackup config.ru</code>.</p>

<p>Ok, cool. So what does Rack actually <em>do</em>?</p>

<h2>How Rack Works</h2>

<p>Rack is really just a way for a developer to create a server application while avoiding the boilerplate code that would be required to do so using <code>Net::HTTP</code>. If you&rsquo;ve written some code that meets the Rack specifications, you can load it up in a Ruby server like <code>WEBrick</code>, <code>Mongrel</code>, or <code>Thin</code>, and you&rsquo;re ready to accept requests and respond to them.</p>

<p>There are a few methods you should know about that are provided for you. You can call these directly from within your <code>config.ru</code> file.</p>

<p><strong><em><code>run</code></em></strong>
Takes an application (the object that responds to <code>call</code>) as an argument. The following code from the Rack website demonstrates how this looks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>run Proc.new { |env| ['200', {'Content-Type' =&gt; 'text/html'}, ['get rack\'d']] }</span></code></pre></td></tr></table></div></figure>


<p><strong><em><code>map</code></em></strong>
Takes a string specifying the path to be handled, and a block containing the Rack application code to be run when a request with that path is received. Here&rsquo;s an example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>map '/posts' do
</span><span class='line'>  run Proc.new { |env| ['200', {'Content-Type' =&gt; 'text/html'}, ['first_post', 'second_post', 'third_post']] }
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><strong><em><code>use</code></em></strong>
Tells Rack to use certain middleware.</p>

<p>So what else do you need to know? Let&rsquo;s take a closer look at the environment hash and the response Array.</p>

<h3>The Environment Hash</h3>

<p>Your Rack server object takes in an environment hash. What&rsquo;s contained in that hash? Here are a few of the more interesting parts:</p>

<ul>
<li><code>REQUEST_METHOD</code>: The HTTP verb of the request. This is required.</li>
<li><code>PATH_INFO</code>: The request URL path, relative to the root of the application.</li>
<li><code>QUERY_STRING</code>: Anything that followed <code>?</code> in the request URL string.</li>
<li><code>SERVER_NAME</code> and <code>SERVER_PORT</code>: The server&rsquo;s address and port.</li>
<li><code>rack.version</code>: The rack version in use.</li>
<li><code>rack.url_scheme</code>: is it <code>http</code> or <code>https</code>?</li>
<li><code>rack.input</code>: an IO-like object that contains the raw HTTP POST data.</li>
<li><code>rack.errors</code>: an object that response to <code>puts</code>, <code>write</code>, and <code>flush</code>.</li>
<li><code>rack.session</code>: A key value store for storing request session data.</li>
<li><code>rack.logger</code>: An object that can log interfaces. It should implement <code>info</code>, <code>debug</code>, <code>warn</code>, <code>error</code>, and <code>fatal</code> methods.</li>
</ul>


<p>A lot of frameworks built on Rack wrap the <code>env</code> hash in a <code>Rack::Request</code> object. This object provides a lot of convenience methods. For example, <code>request_method</code>, <code>query_string</code>, <code>session</code>, and <code>logger</code> return the values from the keys described above. It also lets you check out things like the <code>params</code>, HTTP <code>scheme</code>, or whether you&rsquo;re using <code>ssl?</code>. For a complete listing of methods, I would suggest digging through <a href="https://github.com/rack/rack/blob/master/lib/rack/request.rb">the source</a>.</p>

<h3>The Response</h3>

<p>When your Rack server object returns a response, it must contain three parts: the status, headers, and body. As there was for the request, there is a <a href="https://github.com/rack/rack/blob/master/lib/rack/response.rb">Rack::Response</a> object that gives you convenience methods like <code>write</code>, <code>set_cookie</code>, <code>finish</code>, and more. Alternately, you can just return an array containing the three components.</p>

<h4>Status</h4>

<p>An <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP status</a>, like 200 or 404.</p>

<h4>Headers</h4>

<p>Something that responds to each, and yields key-value pairs. The keys have to be strings and conform to the <a href="https://tools.ietf.org/html/rfc7230">RFC7230 token specification</a>. Here&rsquo;s where you can set <code>Content-Type</code> and <code>Content-Length</code> if it&rsquo;s appropriate for your response.</p>

<h4>Body</h4>

<p>The body is the data that the server sends back to the requester. It has to respond to <code>each</code>, and yield string values.</p>

<h3>All Racked Up!</h3>

<p>Now that we&rsquo;ve created a Rack app, how can we customize it to make it actually useful? The first step is to consider adding some middleware.</p>

<h2>What is Middleware?</h2>

<p>One of the things that makes Rack so great is how easy it is to add a chain middleware components between the webserver and the app to customize the way your request/response behaves. But what <em>is</em> a middleware component?</p>

<p>A middleware component sits between the client and the server, processing inbound requests and outbound responses. Why would you want to do that? There are tons of <a href="https://github.com/rack/rack/wiki/List-of-Middleware">middleware components available for Rack</a> that take the guesswork out of problems like enabling caching, authentication, trapping spam, and many other problems.</p>

<h2>Using Middleware in a Rack App</h2>

<p>To add middleware to a Rack application, all you have to do is tell Rack to use it. You can use multiple middleware components, and they will change the request or response before passing it on to the next component. This series of components is called the <em>middleware stack</em>.</p>

<h3>Warden</h3>

<p>We&rsquo;re going to take a look at how you would add <a href="https://github.com/hassox/warden">Warden</a> to a project. Warden has to come <em>after</em> some kind of session middleware in the stack, so we&rsquo;ll use <code>Rack::Session::Cookie</code> as well.</p>

<p>First, add it to your project <code>Gemfile</code> with <code>gem "warden"</code> and install it with <code>bundle install</code>.</p>

<p>Now add it to your <code>config.ru</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require "warden"
</span><span class='line'>
</span><span class='line'>use Rack::Session::Cookie, secret: "MY_SECRET"
</span><span class='line'>
</span><span class='line'>failure_app = Proc.new { |env| ['401', {'Content-Type' =&gt; 'text/html'}, ["UNAUTHORIZED"]] }
</span><span class='line'>
</span><span class='line'>use Warden::Manager do |manager|
</span><span class='line'>  manager.default_strategies :password, :basic
</span><span class='line'>  manager.failure_app = failure_app
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>run Proc.new { |env| ['200', {'Content-Type' =&gt; 'text/html'}, ['get rack\'d']] }</span></code></pre></td></tr></table></div></figure>


<p>Finally, run the server with <code>rackup</code>. It will find <code>config.ru</code> and boot up on port 9292.</p>

<p>Note that there is more setup involved in getting Warden to actually do authentication with your app. This is just an example of how to get it loaded into the middleware stack. To see a more fleshed-out example of integrating Warden, check out <a href="https://gist.github.com/lukesutton/107966">this gist</a>.</p>

<p>By the way, there&rsquo;s another way to define the middleware stack. Instead of calling <code>use</code> directly in <code>config.ru</code>, you can use <code>Rack::Builder</code> to wrap several middlewares and app(s) in one big application. For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>failure_app = Proc.new { |env| ['401', {'Content-Type' =&gt; 'text/html'}, ["UNAUTHORIZED"]] }
</span><span class='line'>
</span><span class='line'>app = Rack::Builder.new do
</span><span class='line'>  use Rack::Session::Cookie, secret: "MY_SECRET"
</span><span class='line'>
</span><span class='line'>  use Warden::Manager do |manager|
</span><span class='line'>    manager.default_strategies :password, :basic
</span><span class='line'>    manager.failure_app = failure_app
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>run app</span></code></pre></td></tr></table></div></figure>


<h3>Rack Basic Auth</h3>

<p>One really useful piece of middleware is <code>Rack::Auth::Basic</code>, which you can use to protect any Rack app with <a href="http://tools.ietf.org/html/rfc2617">HTTP basic authentication</a>. It is really lightweight and comes in handy for protecting little bits of an application. For example, Ryan Bates uses it to protect a Resque server in a Rails app in <a href="http://railscasts.com/episodes/271-resque?view=asciicast">this episode of Railscasts</a>.</p>

<p>Here&rsquo;s how to set it up:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>use Rack::Auth::Basic, "Restricted Area" do |username, password|
</span><span class='line'>  [username, password] == ['admin', 'abc123']
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>That was easy!</p>

<h2>Using Middleware in Rails</h2>

<p>Now, so what? Rack is pretty cool, and we know that Rails is built on it. But just because we understand what it is, doesn&rsquo;t make it actually useful in working with a production app.</p>

<h3>How Rails Uses Rack</h3>

<p>Did you ever notice that there&rsquo;s a <code>config.ru</code> file in the root of every generated Rails project. Have you ever taken a look inside? Here&rsquo;s what it contains:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># This file is used by Rack-based servers to start the application.
</span><span class='line'>
</span><span class='line'>require ::File.expand_path('../config/environment', __FILE__)
</span><span class='line'>run Rails.application</span></code></pre></td></tr></table></div></figure>


<p>Pretty simple. It just loads up the <code>config/environment</code> file, then boots up <code>Rails.application</code>. Wait, what&rsquo;s that? Taking a look in <code>config/environment</code>, we can see that it&rsquo;s defined in <code>config/application.rb</code>. <code>config/environment</code> is just calling <code>initialize!</code> on it.</p>

<p>So what&rsquo;s in <code>config/application.rb</code>? If we take a look, we see that it loads in the bundled gems from <code>config/boot.rb</code>, requires <code>rails/all</code>, loads up the environment (test, development, production, etc.), and defines a namespaced version of our application. It looks something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module MyApplication
</span><span class='line'>  class Application &lt; Rails::Application
</span><span class='line'>    ...
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>So I guess that means that <code>Rails::Application</code> must be a Rack app? Sure enough! If we check out <a href="https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L161">the source code</a>, it responds to <code>call</code>!</p>

<p>So what middleware is it using? Well, I see that <a href="https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L182">it&rsquo;s autoloading</a> <code>rails/application/default_middleware_stack</code>. <a href="https://github.com/rails/rails/blob/master/railties/lib/rails/application/default_middleware_stack.rb#L13">Checking that out</a>, it looks like it&rsquo;s defined in <code>ActionDispatch</code>. Where does <code>ActionDispatch</code> come from? <code>ActionPack</code>.</p>

<h3>Action Dispatch</h3>

<p><a href="https://github.com/rails/rails/tree/master/actionpack">Action Pack</a> is Rails&rsquo;s framework for handling web requests and responses. Action Pack home to quite a few of the niceties you find in Rails, such as routing, the the abstract controllers that you inherit from, and view rendering.</p>

<p>The most relevant part of AP for our discussion here is <a href="https://github.com/rails/rails/tree/master/actionpack/lib/action_dispatch">Action Dispatch</a>. It provides several middleware components that deal with ssl, cookies, debugging, static files, and much more.</p>

<p>If you go take a look at each of the <a href="https://github.com/rails/rails/tree/master/actionpack/lib/action_dispatch/middleware">Action Dispatch middleware components</a>, you&rsquo;ll notice they&rsquo;re all following the Rack specification: they all respond to <code>call</code>, taking in an <code>app</code> and returning <code>status</code>, <code>headers</code>, and <code>body</code>. Many of them also make use of <code>Rack::Request</code> and <code>Rack::Response</code> objects.</p>

<p>For me, reading through the code in these components took a lot of the mystery out of what&rsquo;s going on behind the scenes when making requests to a Rails app. When I realized that it&rsquo;s just a bunch of Ruby objects that follow the Rack specification, passing the request and response to each other, it made this whole section of Rails a lot less mysterious.</p>

<p>Now that we understand a little bit of what&rsquo;s happening under the hood, let&rsquo;s take a look at how to actually include some custom middleware in a Rails app.</p>

<h3>Adding Your Own Middleware</h3>

<p>Imagine you are <a href="https://www.engineyard.com/trial">hosting an application on Engine Yard</a>. You have a Rails API running on one server, and a client-side JavaScript app running on another. The API has a url of <code>https://api.myawesomeapp.com</code>, and the client-side app lives at <code>https://app.myawesomeapp.com</code>.</p>

<p>You&rsquo;re going to run into a problem pretty quick: you can&rsquo;t access resources at <code>api.myawesomeapp.com</code> from your JS app, because of the <a href="http://en.wikipedia.org/wiki/Same-origin_policy">same-origin policy</a>. As you may know, the solution to this problem is to enable <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-origin resource sharing</a> (CORS). There are many ways to enable CORS on your server, but one of the easiest is to use the <a href="https://github.com/cyu/rack-cors">Rack::Cors middleware gem</a>.</p>

<p>Begin by requiring it in the <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;rack-cors&quot;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="s2">&quot;rack/cors&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with so many things, Rails provides a very easy way to get middleware loaded. Although we certainly <em>could</em> add it to a <code>Rack::Builder</code> block in <code>config.ru</code>, as we did above, the Rails convention is to place it in <code>config/application.rb</code>, using the following syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MyAwesomeApp</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Rack::Cors&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">allow</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">origins</span> <span class="s1">&#39;*&#39;</span>
</span><span class='line'>        <span class="n">resource</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="ss">:any</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:expose</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;X-User-Authentication-Token&#39;</span><span class="p">,</span> <span class="s1">&#39;X-User-Id&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:methods</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:options</span><span class="p">,</span> <span class="ss">:patch</span><span class="p">,</span> <span class="ss">:delete</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we&rsquo;re using <a href="http://guides.rubyonrails.org/rails_on_rack.html#configuring-middleware-stack">insert_before</a> here to ensure that <code>Rack::Cors</code> comes before the rest of the middleware included in the stack by ActionPack (and any other middleware you might be using).</p>

<p>Now if you reboot the server, you should be good to go! Your client-side app can access <code>api.myawesomeapp.com</code> without running into same-origin policy JS errors.</p>

<p>If you want to learn more about how HTTP requests are routed through Rack in Rails, I’d suggest taking a look at <a href="https://www.omniref.com/ruby/gems/railties/4.2.0/symbols/Rails::Application#annotation=4084035&amp;line=161">this tour</a> of the Rails source code that deals with handling requests.</p>

<h2>Conclusion</h2>

<p>In this post, we&rsquo;ve take an in-depth at the internals of Rack, and by extension, the request/response cycle for several Ruby web frameworks, including Ruby on Rails.</p>

<p>Hopefully, understanding what&rsquo;s going on when a request hits your server and your application sends back a response helps make things feel a little less <em>magical</em>. Because I don&rsquo;t know about you, but when things go wrong, I have a lot harder time troubleshooting when there&rsquo;s magic involved than when I understand what&rsquo;s going on. In that case, I can say &ldquo;oh, it&rsquo;s just a Rack response&rdquo;, and get down to fixing the bug.</p>

<p>If I&rsquo;ve done my job, reading this article will enable you to do the same thing.</p>

<p>P.S. Do you know of any use-cases where a simple Rack app was enough to meet your business needs? What other ways do you integrate Rack apps in your bigger applications? We want to hear your battle stories! Leave us a comment!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/03/12/deploying-and-customizing-applications-on-engine-yard/">Deploying and Customizing Applications on Engine Yard</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-03-12T06:29:30-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/deploying-and-customizing-applications">Engine Yard</a>.</p>

<h2>Introduction</h2>

<p>I&rsquo;ve tried a lot of different Platform as a Service (PaaS) providers for hosting my applications. Some of them make it super-easy to get everything running on the server, but the magic gets in the way when you need to customize things.</p>

<p>Some platforms give you full control, but it can be time-consuming to get all of your dependencies properly set up. It would be nice to have some of the boilerplate taken care of, while still retaining full control of my server environment.</p>

<p>If you haven’t deployed an application to Engine Yard (EY), you should give it a try. You’ll be pleasantly surprised to find that this is exactly the kind of service offered. It’s a breeze to get Redis, cron, and any other tools you need installed. You also get root access to your server and can SSH in just as you would with a bare server.</p>

<p>My favorite feature has always been the ability to push custom Chef recipes to my server, making it super-easy to tweak the server as needed without having to spend a lot of time downloading Ubuntu packages and managing user permissions.</p>

<p>There is a little bit of a learning curve though, so I decided to deploy and customise a new app on Engine Yard so that I could document the process and help first-timers get up and running with a minimum of fuss.</p>

<h2>Setting Up An Engine Yard Environment</h2>

<p>I started out with a production application in a Git repository that was ready to go. It just needed a server to run on.</p>

<p>I went to Engine Yard and signed up for <a href="https://www.engineyard.com/trial">a free trial account</a>.</p>

<p>Once I was done filling out my contact and billing information, I created my first &ldquo;application&rdquo; resource on Engine Yard Cloud. Here are the steps I followed to get it running from there.</p>

<p>First, I created a &ldquo;production&rdquo; environment for my application and configured it. I was given four choices of server beefiness: single instance, staging, production, or custom. I went with a production box, and added Phusion Passenger and PostgreSQL to the stack. Since I was deploying a Rails app, I also added Ruby 2.2.0 and set up my migration command. I was happy to see that EY would backup by my database and take a server snapshot on a recurring schedule. I opted in for that service.</p>

<p>While the server was being provisioned, there were a few access-related tasks I had to take care of as well. First, I <a href="https://support.cloud.engineyard.com/entries/21016533-Connect-to-Your-Instance-Using-SSH">added the SSH keys</a> from my development machine to my production environment. To do so, I visited the EY Cloud dashboard, then clicked on <em>Tools</em>, then <em>SSH Keys</em> and pasted my key into the text area, then hit the big <em>Apply</em> button on my app&rsquo;s &ldquo;production&rdquo; environment page.</p>

<p>I also had to add an SSH key EY provided to my GitHub account. This allowed EY to grab my code and push it to the server directly.</p>

<p>A few minutes later, the server and my credentials were all set up, and I was ready to deploy. Next, I pressed <em>Deploy</em>.  Unfortunately, there was a problem with my deploy, so I decided to dig into it from the command line&hellip;</p>

<h2>Using the <code>engineyard</code> Gem</h2>

<h3>Configuring and Deploying</h3>

<p>It turned out I’d forgotten to add a <code>config/ey.yml</code> file to my Rails project. This file is used to customize each of the Engine Yard environments the app is being deployed to. To add one, it’s easiest use the <a href="https://github.com/engineyard/engineyard">engineyard gem</a>.</p>

<p>To install the gem globally, I ran <code>gem install engineyard</code> on my local machine. Then I initialized an EY configuration file using <code>ey init</code>. I checked out the <code>config/ey.yml</code> file it generated. Everything looked good, so I committed and pushed it up to GitHub.</p>

<p>This time, I deployed using <code>ey deploy</code>, and it worked like a charm. Success!</p>

<h3>Logging In and Out</h3>

<ul>
<li><code>ey login</code></li>
<li><code>ey logout</code></li>
<li><code>ey whoami</code></li>
</ul>


<h3>Custom Deploys</h3>

<ul>
<li><code>ey status</code> shows the status of your most recent deploy</li>
<li><code>ey timeout-deploy</code> marks the current deploy as failed and begins a new deploy</li>
<li><code>ey rollback</code> revert to a previous deployment</li>
</ul>


<h3>Environments</h3>

<ul>
<li><code>ey environments</code> shows the environments for this app (pass <code>--all</code> to see all environments for all apps)</li>
<li><code>ey servers</code> shows all the servers for an environment (if you have multiple)</li>
<li><code>ey rebuild</code> reruns the configuration bootstrap process, useful for security patches and upgrades</li>
<li><code>ey restart</code> restarts the servers</li>
</ul>


<h3>Debugging</h3>

<ul>
<li><code>ey logs</code> shows the logs</li>
<li><code>ey web disable</code>/<code>enable</code> toggles a maintenance page</li>
<li><code>ey ssh</code> lets you SSH in</li>
<li><code>ey launch</code> launches app in a browser window</li>
</ul>


<h3>Customizing The Server Environment</h3>

<ul>
<li><code>ey recipes upload</code> adds Chef recipes from your dev machine and the remote server</li>
<li><code>ey recipes download</code> syncs Chef recipes from the remote server to your dev machine</li>
<li><code>ey recipes apply</code> trigger a Chef run</li>
</ul>


<p>These last few commands come in really handy when you want to customize your server setup. Let&rsquo;s take a deeper look at how to upload custom Chef recipes to an application environment.</p>

<h2>Chef Recipes</h2>

<p>Engine Yard uses Chef under the hood to make your deploys quick and easy. There&rsquo;s a default set of recipes that get run every time you deploy.</p>

<p>After the default recipes run, Engine Yard runs any custom recipes that you&rsquo;ve added to your environment. Since there are <a href="https://github.com/opscode-cookbooks">so many Chef recipes available</a>, getting dependencies set up is pretty straightforward.</p>

<p>Your Chef recipes will run whenever you create a new instance, add an instance to a cluster, run <code>ey recipes apply</code>, or trigger a Chef run with from the Cloud Dashboard with the <em>Upgrade</em> or <em>Apply</em> buttons.</p>

<h3>Getting Set Up</h3>

<p>To add recipes to your application, you&rsquo;ll need to fork the <a href="https://github.com/engineyard/ey-cloud-recipes">Engine Yard Cloud Recipes repo</a>. Then, clone your fork down to your development machine, in a different directory than your application.</p>

<h3>Default Recipes</h3>

<p>The Engine Yard Cloud Recipes repo comes with comes with cookbooks for most of the things you would ever need: Sidekiq, Redis, Solr, Elasticsearch, cron, PostgreSQL Extensions, and much more.</p>

<p>Here&rsquo;s what I did to add Redis to my project.</p>

<p>1) Opened <code>/cookbooks</code> and found the subdirectory I wanted (<code>/redis</code>)
2) Uncommented <code>include_recipe redis</code> in <code>cookbooks/main/recipes/default.rb</code>
3) Saved the file, committed it, and push to my forked repo
4) Uploaded the recipes to my app with <code>ey recipes upload -e production</code>
5) Applied the recipes to my app with <code>ey recipes apply -e production</code></p>

<p>I took a look at my Engine Yard dashboard, and a few short moments later, Redis was running on my server!</p>

<h3>Custom Recipes</h3>

<p>I wanted to add HTTP Basic Auth to my server, but it wasn&rsquo;t one of the recipes in the repo, so I wrote my own recipe for it.</p>

<p>Here&rsquo;s how I did it.</p>

<p>First, I opened up my <code>ey-cloud-recipes</code> fork repo and ran <code>rake new_cookbook COOKBOOK=httpauth</code>. This generated a bunch of files under <code>cookbooks/httpauth/</code>. Then I edited <code>cookbooks/httpauth/recipes/default.rb</code> like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sysadmins = search(:users, 'groups:sysadmin')
</span><span class='line'>
</span><span class='line'>template "/etc/nginx/htpasswd.users" do
</span><span class='line'>  source "nginx/htpasswd.users.erb"
</span><span class='line'>  owner node['staging']['nginx']['user']
</span><span class='line'>  group node['staging']['nginx']['user']
</span><span class='line'>  mode "0640"
</span><span class='line'>  variables(
</span><span class='line'>    :sysadmins =&gt; sysadmins
</span><span class='line'>  )
</span><span class='line'>  notifies :restart, "service[nginx]", :delayed
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>With the <code>httpauth</code> recipe written, I next created a <code>htpasswd.users.erb</code> under the `cookbooks/httpauth/templates/default/nginx directory, and put this code in it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% @sysadmins.each do |sa| -%&gt;
</span><span class='line'>  &lt;%= sa["id"] %&gt;:&lt;%= sa["htpasswd"] %&gt;
</span><span class='line'>&lt;% end -%&gt;</span></code></pre></td></tr></table></div></figure>


<p>With the template in place, I added the recipe to <code>cookbooks/main/recipes/default.rb</code> (my main cookbook) by adding this line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include_recipe "httpauth"</span></code></pre></td></tr></table></div></figure>


<p>Finally, I checked my syntax with <code>rake test</code> (all good), committed my changes, and pushed to my fork. With the recipe ready, all that was left was to upload and apply it to my application with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ey recipes upload -e production
</span><span class='line'>ey recipes apply -e production</span></code></pre></td></tr></table></div></figure>


<p>The recipe was successfully added to my server in the <code>/etc/chef-custom</code> directory. I know this because I logged in and took a look around.</p>

<p>How did I do that? I&rsquo;m glad you asked.</p>

<h2>Remote Access with SSH</h2>

<p>If you ever need to confirm that your Chef recipes are configuring the server the way you expected, or need to access your server directly with root access for any other reason, you can use SSH to get a remote terminal.</p>

<p>There are three ways to do this:</p>

<p>1) Run <code>ssh username@123.123.123.123</code>, the old-fashioned way (you can find your server&rsquo;s IP address in the Engine Yard dashboard).
2) Click on the SSH link in your application dashboard on EY instead
3) Run <code>ey ssh</code> from the application directory on your dev machine</p>

<p>When you login to your server, some helpful information about your app&rsquo;s server environment is displayed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Applications:
</span><span class='line'>myapplication:
</span><span class='line'>cd /data/myapplication/current # go to the application root folder
</span><span class='line'>tail -f /data/myapplication/current/log/production.log # production logs
</span><span class='line'>cat /data/nginx/servers/myapplication.conf # current nginx conf
</span><span class='line'>
</span><span class='line'>SQL database:
</span><span class='line'>cd /db # your attached DB volume
</span><span class='line'>
</span><span class='line'>PostgreSQL:
</span><span class='line'>tail -f /db/postgresql/$1.$2/data/pg_log/* # logs
</span><span class='line'>pg_top -dmyapplication
</span><span class='line'>
</span><span class='line'>Inspect node data passed to chef cookbooks:
</span><span class='line'>sudo gem install jazor
</span><span class='line'>sudo jazor /etc/chef/dna.json
</span><span class='line'>sudo jazor /etc/chef/dna.json 'applications.map {|app, data| [app, data.keys]}'</span></code></pre></td></tr></table></div></figure>


<p>Pretty cool. It&rsquo;s nice to have access like this if you need it, without being responsible for configuring (and re-configuring) the entire machine by hand.</p>

<h2>Conclusion</h2>

<p>If you&rsquo;re anything like me, you drag your feet about trying new things when it comes to sysops. Perhaps you&rsquo;ve felt the pain of trying to take a server from vanilla Ubuntu to a custom build with cron, Redis, Elasticsearch and a bunch of other packages—carefully balancing everything so that it doesn&rsquo;t fall apart. Many of us have also experienced getting stuck when using a full-service PaaS that isn&rsquo;t working the way we expect, and not being able to customise things. Experiences like this make it hard for me to get excited about setting up servers, so I typically avoid it when I can.</p>

<p>That said, Engine Yard makes this sort of work a breeze. Their balance between automation and control gives you the best of both worlds. Getting up and running takes a little bit of learning, but the <a href="https://support.cloud.engineyard.com/home">docs</a>  are super helpful and  the support team is very responsive if you ever have any questions or need a hand.</p>

<p>If you haven&rsquo;t given Engine Yard a try, why not give it a go?</p>

<p>P.S. What kind of custom Chef recipes are you using on your servers? I know that business requirements can lead to some pretty gnarly setups. Tell me about it via the comments.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/03/01/serving-custom-json-from-your-rails-api-with-activemodel-serializers/">Serving Custom JSON From Your Rails API With ActiveModel::Serializers</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-03-01T06:23:01-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/active-model-serializers">Engine Yard</a>.</p>

<h1>Introduction</h1>

<p>These days, there are so many different choices when it comes to serving data from an API. You can build it in Node with <a href="http://expressjs.com/">ExpressJS</a>, in Go with <a href="http://martini.codegangsta.io/">Martini</a>, Clojure with <a href="https://github.com/weavejester/compojure">Compojure</a>, and many more. But in many cases, you just want to bring something to market as fast as you can. For those times, I still reach for <a href="http://rubyonrails.org/">Ruby on Rails</a>.</p>

<p>With Rails, you can spin up a function API server in a very short period of time. Rails is large. Perhaps you object that there&rsquo;s &ldquo;too much magic&rdquo;. Have you ever checked out the <a href="https://github.com/rails-api/rails-api">rails-api gem</a>? It lets you enjoy all the benefits of Rails without including unnecessary view-layer and asset-related code.</p>

<p>Rails-api is maintained by <a href="https://github.com/carlosantoniodasilva">Carlos Antonio Da Silva</a>, <a href="https://github.com/spastorino">Santiago Pastorino</a>, Rails Core team members, and all-around great Rubyist <a href="http://www.steveklabnik.com/">Steve Klabnik</a>. While not busy working on Rails or the Rails API Gem, they found the time to put together the <a href="https://github.com/rails-api/active_model_serializers">active_model_serializers gem</a> to make it easier to format JSON responses when using Rails as an API server.</p>

<p>ActiveModel::Serializers (AMS) is a powerful alternative to <a href="https://github.com/rails/jbuilder">jbuilder</a>, <a href="https://github.com/nesquena/rabl">rabl</a>, and other Ruby templating solutions. It&rsquo;s easy to get started with, but when you want to serve data that quite doesn&rsquo;t match up with the way ActiveRecord (AR) structures things, it can be hard to figure out how to get it to do what you want.</p>

<p>In this post, we&rsquo;ll take a look at how to extend AMS to serve up custom data in the context of a Rails-based chat app.</p>

<h2>Kicking It Off: Setting Up a Rails Server</h2>

<p>Any two users in the system can have a continuous thread that goes back and forth. Let&rsquo;s imagine we are building a chat app, similar to Apple&rsquo;s Messages. People can sign up for the service, then chat with their friends.</p>

<p>Most of the presentation logic will happen in a client-side JavaScript app. For now, we&rsquo;re only concerned with accepting and returning raw data, and we&rsquo;ve decided to use a Rails server to build it.</p>

<p>To get started, we&rsquo;ll run a <code>rails new</code>, but since we&rsquo;re using the <code>rails-api</code> gem, we&rsquo;ll need to make sure we have it installed first, with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install rails-api</span></code></pre></td></tr></table></div></figure>


<p>Once that&rsquo;s done, we&rsquo;ll run the following (familiar) command to start the project:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails-api new mensajes --database=postgresql</span></code></pre></td></tr></table></div></figure>


<p><code>cd</code> into the directory and setup the database with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:create</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Models</h2>

<p>We&rsquo;ll need a couple of models: <code>User</code>s and <code>Messages</code>. The workflow to create them should be fairly familiar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g scaffold user username:string
</span><span class='line'>rails g scaffold message sender_id:integer recipient_id:integer body:text</span></code></pre></td></tr></table></div></figure>


<p>Open up the migrations, and set everything to <code>null: false</code>, then run <code>rake db:migrate</code>.</p>

<p>We&rsquo;ll also need to set up the relationships. Be sure to test these relationships (I would suggest using the <a href="https://github.com/thoughtbot/shoulda-matchers">shoulda gem</a> to make it easy on yourself.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  has_many :sent_messages, class_name: "Message", foreign_key: "sender_id"
</span><span class='line'>  has_many :received_messages, class_name: "Message", foreign_key: "recipient_id"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Message &lt; ActiveRecord::Base
</span><span class='line'>  belongs_to :recipient, class_name: "User", inverse_of: :received_messages
</span><span class='line'>  belongs_to :sender, class_name: "User", inverse_of: :sent_messages
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>Serving the Messages</h2>

<p>Let&rsquo;s send some messages! Imagine for a minute that you&rsquo;ve already set up some kind of token-based authentication system, and you have some way of getting ahold of the user that is making requests to your API.</p>

<p>We can open up the <code>MessagesController</code>, and since we used a <code>scaffold</code>, we should already be able to view all the messages. Let&rsquo;s scope that to the current user. First we&rsquo;ll write a convenience method to get all the sent and received messages for a user, then we&rsquo;ll rework the <code>MessagesController</code> to work the way we want it to.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User &lt; ActiveRecord::Base
</span><span class='line'>  ...
</span><span class='line'>  def messages
</span><span class='line'>    Message.where("sender_id = ? OR recipient_id = ?", self.id, self.id)
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessagesController &lt; ApplicationController
</span><span class='line'>  def index
</span><span class='line'>    @messages = current_user.messages
</span><span class='line'>    render json: @messages
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Assuming that we have created a couple of sent and received messages for the <code>current_user</code>, we should be able to take a look at <code>http://localhost:3000/messages</code> and see some raw JSON that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[{"sender_id":1,"id":1,"recipient_id":2,"body":"YOLO","created_at":"2015-02-03T21:05:12.908Z","updated_at":"2015-02-03T21:05:12.908Z"},{"recipient_id":1,"id":2,"sender_id":2,"body":"Hello, world!","created_at":"2015-02-03T21:05:51.309Z","updated_at":"2015-02-03T21:05:51.309Z"}]</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s kind of ugly. It would be nice if we could remove the timestamps and ids. This is where AMS comes in.</p>

<h2>Adding ActiveModel::Serializers</h2>

<p>Once we add AMS to our project, it should be easy to get a much prettier JSON format back from our <code>MessagesController</code>.</p>

<p>To get AMS, add it to the <code>Gemfile</code> with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem "active_model_serializers", github: "rails-api/active_model_serializers"
</span></code></pre></td></tr></table></div></figure>


<p>Then <code>bundle install</code>. Note that I&rsquo;m using a the edge version of AMS here because it supports <code>belongs_to</code> and other features. See the <a href="https://github.com/rails-api/active_model_serializers/blob/master/README.md">github project README</a> for some information about maintenance and why you might want to use an older version.</p>

<p>Now we can easily set up a serializer with <code>rails g serializer message</code>. Let&rsquo;s take a look at what this generated for us. In <code>app/serializers/message_serializer.rb</code>, we find this code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessageSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Whichever <code>attributes</code> we specify (as a list of symbols) will be returned in the JSON response. Let&rsquo;s skip <code>id</code>, and instead return the <code>sender_id</code>, <code>recipient_id</code>, and <code>body</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessageSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :sender_id, :recipient_id, :body
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Now when we visit <code>/messages</code>, we get this slightly cleaner JSON:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"messages":[{"sender_id":1,"recipient_id":2,"body":"YOLO"},{"sender_id":2,"recipient_id":1,"body":"Hello, world!"}]}</span></code></pre></td></tr></table></div></figure>


<h2>Cleaning Up the Format</h2>

<p>It sure would be nice if we could get more information about the other user, like their username, so that we could display it in the messaging UI on the client-side. That&rsquo;s easy enough, we just change the <code>MessageSerializer</code> to use AR objects as attributes for the <code>sender</code> and <code>recipient</code>, instead of <code>id</code>s.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessageSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :sender, :recipient, :body
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Now we can see more about the Sender and Recipient:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"messages":[{"sender":{"id":1,"username":"Ben","created_at":"2015-02-03T21:04:09.220Z","updated_at":"2015-02-03T21:04:09.220Z"},"recipient":{"id":2,"username":"David","created_at":"2015-02-03T21:04:45.948Z","updated_at":"2015-02-03T21:04:45.948Z"},"body":"YOLO"},{"sender":{"id":2,"username":"David","created_at":"2015-02-03T21:04:45.948Z","updated_at":"2015-02-03T21:04:45.948Z"},"recipient":{"id":1,"username":"Ben","created_at":"2015-02-03T21:04:09.220Z","updated_at":"2015-02-03T21:04:09.220Z"},"body":"Hello, world!"}]}</span></code></pre></td></tr></table></div></figure>


<p>Actually, that might be too much. Let&rsquo;s clean up how <code>User</code> objects are serialized by generating a User serializer with <code>rails g serializer user</code>. We&rsquo;ll set it up to just return the username.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class UserSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :username
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>In the <code>MessageSerializer</code>, we&rsquo;ll use <code>belongs_to</code> to have AMS format our <code>sender</code> and <code>recipient</code> using the <code>UserSerializer</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessageSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :body
</span><span class='line'>  belongs_to :sender
</span><span class='line'>  belongs_to :recipient
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>If we take a look at <code>/messages</code>, we now see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[{"recipient":{"username":"David"},"body":"YOLO","sender":{"username":"Ben"}},{"recipient":{"username":"Ben"},"body":"Hello, world!","sender":{"username":"David"}}]</span></code></pre></td></tr></table></div></figure>


<p>Things are really starting to come together!</p>

<h2>Conversations</h2>

<p>Although we can view all of a user&rsquo;s messages using the <code>index</code> controller action, or a specific message at the <code>show</code> action, there&rsquo;s something important to the business logic of our app that we can&rsquo;t do. We can&rsquo;t view all of the messages sent between two users. We need some concept of a <code>conversation</code>.</p>

<p>When thinking about creating a conversation, we have to ask, does this model need to be stored in the database? I think the answer is no. We already have messages that know which users they belong to. All we really need is a way to get back all the messages between two users from one endpoint.</p>

<p>We can use a Plain Old Ruby Object (PORO) to create this concept of a <code>conversation</code> model. We will <em>not</em> inherit from <code>ActiveRecord::Base</code> in this case.</p>

<p>Since we already know about the <code>current_user</code>, we really only need it to keep track of the other user. We&rsquo;ll call her the <code>participant</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># app/models/conversation.rb
</span><span class='line'>class Conversation
</span><span class='line'>  attr_reader :participant, :messages
</span><span class='line'>
</span><span class='line'>  def initialize(attributes)
</span><span class='line'>    @participant = attributes[:participant]
</span><span class='line'>    @messages = attributes[:messages]
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll want to be able to serve up these conversations, so we&rsquo;ll need a <code>ConversationsController</code>. We want to get all of the conversations for a given user, so we&rsquo;ll add a class-level method to the <code>Conversation</code> model to find them and return them in this format:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># TODO: Insert JSON blob here</span></code></pre></td></tr></table></div></figure>


<p>To make this work, we&rsquo;ll run a <code>group_by</code> on the user&rsquo;s messages, grouping by the <em>other</em> user&rsquo;s id. We&rsquo;ll then map the resulting hash into a collection of <code>Conversation</code> objects, passing in the other user and the list of messages.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Conversation
</span><span class='line'>  ...
</span><span class='line'>  def self.for_user(user)
</span><span class='line'>    user.messages.group_by { |message|
</span><span class='line'>      if message.sender == user
</span><span class='line'>        message.recipient_id
</span><span class='line'>      else
</span><span class='line'>        message.sender_id
</span><span class='line'>      end
</span><span class='line'>    }.map do |user_id, messages|
</span><span class='line'>      Conversation.new({
</span><span class='line'>        participant: User.find(user_id),
</span><span class='line'>        messages: messages
</span><span class='line'>      })
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>If we run this in the Rails Console, it seems to be working.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;Conversation.for_user(User.first)
</span><span class='line'>...
</span><span class='line'>=&gt; [#&lt;Conversation:0x007fbd6e5b9428 @participant=#&lt;User id: 2, username: "David", created_at: "2015-02-03 21:04:45", updated_at: "2015-02-03 21:04:45"&gt;, @messages=[#&lt;Message id: 1, sender_id: 1, recipient_id: 2, body: "YOLO", created_at: "2015-02-03 21:05:12", updated_at: "2015-02-03 21:05:12"&gt;, #&lt;Message id: 2, sender_id: 2, recipient_id: 1, body: "Hello, world!", created_at: "2015-02-03 21:05:51", updated_at: "2015-02-03 21:05:51"&gt;]&gt;]</span></code></pre></td></tr></table></div></figure>


<p>Great! We&rsquo;ll just call this method in our <code>ConversationsController</code> and everything will be great!</p>

<p>First, we&rsquo;ll define the route in <code>config/routes.rb</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Rails.application.routes.draw do
</span><span class='line'>  ...
</span><span class='line'>  resources :conversations, only: [:index]
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Then, we&rsquo;ll write the controller action.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># app/controllers/conversations_controller.rb
</span><span class='line'>
</span><span class='line'>class ConversationsController &lt; ApplicationController
</span><span class='line'>  def index
</span><span class='line'>    conversations = Conversation.for_user(current_user)
</span><span class='line'>    render json: conversations
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Visiting <code>/conversations</code>, we should see a list of all the conversations for the current user.</p>

<h2>Serializing Plain Old Ruby Objects</h2>

<p>Whoops! When we visit that route, we get an error: <code>undefined method</code>new&#8217; for nil:NilClass`. It&rsquo;s coming from this line in the controller:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>render json: conversations</span></code></pre></td></tr></table></div></figure>


<p>It looks like the error is coming from the fact that we don&rsquo;t have a serializer. Let&rsquo;s make one with <code>rails g serializer conversation</code>. We&rsquo;ll edit it to return its attributes, <code>participant</code> and <code>message</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ConversationSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :participant, :messages
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Now when we try, we get another error, coming from the same line of the controller: <code>undefined method 'read_attribute_for_serialization' for #&lt;Conversation:0x007ffc9c1bed10&gt;</code></p>

<p>Digging around in the source code for ActiveModel::Serializers, I couldn&rsquo;t find where that method was defined. So I took a look at ActiveModel itself, and found it <a href="https://github.com/rails/rails/blob/08754f12e65a9ec79633a605e986d0f1ffa4b251/activemodel/lib/active_model/serialization.rb#L141">here</a>. It turns out that it&rsquo;s just an alias for <code>send</code>!</p>

<p>We can add that into our PORO easily enough:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Conversation
</span><span class='line'>  alias :read_attribute_for_serialization :send
</span><span class='line'>  ...
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Or, we could <code>include ActiveModel::Serialization</code> which is where our AR-backed objects got it.</p>

<p>Now when we take a look at <code>/conversations</code>, we get:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[{"participant":{"id":2,"username":"David","created_at":"2015-02-03T21:04:45.948Z","updated_at":"2015-02-03T21:04:45.948Z"},"messages":[{"sender_id":1,"recipient_id":2,"id":1,"body":"YOLO","created_at":"2015-02-03T21:05:12.908Z","updated_at":"2015-02-03T21:05:12.908Z"},{"sender_id":2,"id":2,"recipient_id":1,"body":"Hello, world!","created_at":"2015-02-03T21:05:51.309Z","updated_at":"2015-02-03T21:05:51.309Z"}]}]</span></code></pre></td></tr></table></div></figure>


<p>Whoops. Not quite right. But the problem is similar to the one we had before in the <code>MessageSerializer</code>. Maybe the same approach will work. We&rsquo;ll change the <code>attributes</code> to AR relationships.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ConversationSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  has_many :messages, class_name: "Message"
</span><span class='line'>  belongs_to :participant, class_name: "User"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Almost! Now <code>/conversations</code> returns:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[{"messages":[{"body":"YOLO"},{"body":"Hello, world!"}],"participant":{"username":"David"}}]</span></code></pre></td></tr></table></div></figure>


<p>We can&rsquo;t see who the sender of each message was! AMS isn&rsquo;t using the <code>UserSerializer</code> for the message sender and recipient, because we&rsquo;re not using an AR object.</p>

<p>A little <a href="https://github.com/rails-api/active_model_serializers/blob/master/lib/active_model/serializer.rb#136">source code</a> spelunking point the way to a fix.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MessageSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :body, :recipient, :sender
</span><span class='line'>
</span><span class='line'>  def sender
</span><span class='line'>    UserSerializer.new(object.sender).attributes
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def recipient
</span><span class='line'>    UserSerializer.new(object.recipient).attributes
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Now <code>/conversations</code> gives us what we want:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[{"messages":[{"body":"YOLO","recipient":{"username":"David"},"sender":{"username":"Ben"}},{"body":"Hello, world!","recipient":{"username":"Ben"},"sender":{"username":"David"}}],"participant":{"username":"David"}}]</span></code></pre></td></tr></table></div></figure>


<p>And <code>/messages</code> still works as well!</p>

<h2>Wrapping Up</h2>

<p>The ActiveModel::Serializers gem claims to bring &ldquo;convention over configuration to your JSON generation&rdquo;. It does a great job of it, but when you need to massage the data, things can get a little bit hairy.</p>

<p>Hopefully some of the tricks we&rsquo;ve covered will help you present JSON from your Rails API the way you want. For this, and virtually any other problem caused by <em>the magic</em> getting in the way, I can&rsquo;t suggest digging through the source code enough.</p>

<p>At the end of the day ARS is an excellent choice for getting your JSON API off the ground with a minimum of fuss. Good luck!</p>

<p>P.S. Have a different approach? Prefer <code>rabl</code> or <code>jbuilder</code>? Did I leave something out? Leave us a comment below!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/02/26/getting-started-with-ruby-processing/">Getting Started With Ruby Processing</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-02-26T06:20:55-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post was a featured article in <a href="http://rubyweekly.com/issues/234">Ruby Weekly #234</a>.</p>

<p>It was originally published on <a href="https://blog.engineyard.com/2015/getting-started-with-ruby-processing">Engine Yard</a>.</p>

<h1>Introduction</h1>

<p>If you&rsquo;re like me, you love to code because it is a creative process. In another life, I am a musician.</p>

<p>I&rsquo;ve always loved music because it represents a synthesis of the measurable concreteness of math and the ambiguity of language. Programming is the same way.</p>

<p>But desipite the creative potential of programming, I often myself spending my days working out the kinks of HTTP requests or dealing with SSL certificates. Some part of my yearns for a purely <a href="http://en.wikipedia.org/wiki/Apollonian_and_Dionysian">Apollonion</a> environment in which to use code to make something new and unseen.</p>

<p>When I feel a void for purely creative coding, I turn to the <a href="https://processing.org/">Processing language</a>. Processing is a simple language, based on Java, that you can use to create digital graphics. It&rsquo;s easy to learn, fun to use, and has an amazing online community comprised of programmers, visual artists, musicians, and interdiscplinary artists of all kinds.</p>

<p>In 2009, <a href="https://twitter.com/jashkenas">Jeremy Ashkenas</a>, creator of Backbone.JS, Underscore.JS, and Coffeescript), published the <a href="https://rubygems.org/gems/ruby-processing">ruby-processing gem</a>. It wraps Processing in a &ldquo;thin little shim&rdquo; that makes it even easier to get started as a Ruby developer. In this post, we&rsquo;ll take a look at how you can create your first interactive digital art project in just a few minutes.</p>

<h2>What Is Processing?</h2>

<p>Processing is programming language and IDE built by <a href="http://reas.com/">Casey Reas</a> and <a href="http://benfry.com/">Benjamin Fry</a>, two protegés of indisciplinary digital art guru <a href="http://www.maedastudio.com/">John Maeda</a> at the MIT Media Lab.</p>

<p>Since the project began in 2001, it&rsquo;s been helping teach people to program in a visual art context using a simplified version of Java. It comes packaged as an <a href="https://processing.org/download/">IDE</a> that can be downloaded and used to create and save sketches.</p>

<h2>Why Ruby Processing?</h2>

<p>Since Processing already comes wrapped in an easy-to-use package, you may ask: &ldquo;why should I bother with Ruby Processing?&rdquo;</p>

<p>The answer: if you know how to write Ruby, you can use Processing as a visual interface to a much more complex program. Games, interactive art exhibits, innovative music projects, anything you can imagine; it&rsquo;s all at your fingertips.</p>

<p>Additionally, you don&rsquo;t have to declare types, <code>void</code>s, or understand the differences between <code>float</code>s and <code>int</code>s to get started.</p>

<p>Although there are some drawbacks to using Ruby Processing, most notably slower performance, having Ruby&rsquo;s API available to translate your ideas into sketches more than makes up for it.</p>

<h2>Setup</h2>

<p>When getting started with Ruby Processing for the first time, it can be a little bit overwhelming to get all of the dependencies set up correctly. The gem relies on JRuby, Processing, and a handful of other things. Here&rsquo;s how to get them all installed and working.</p>

<p>I&rsquo;ll assume you already have the following installed: homebrew, wget, java, and a ruby manager such as rvm, rbenv or chruby.</p>

<h3>Processing</h3>

<p><a href="https://www.processing.org/download/">Download Processing</a> from the official website and install it.</p>

<p>When you&rsquo;re done, make sure that the resulting app is located in your <code>/Applications</code> directory.</p>

<h3>JRuby</h3>

<p>Although it&rsquo;s possible to run Ruby Processing on the <a href="http://en.wikipedia.org/wiki/Ruby_MRI">MRI</a>, I highly suggest using JRuby. It works much better, since Processing itself is built on Java.</p>

<p>Install the latest JRuby version (1.7.18 at the time of this writing). For example, if you&rsquo;re using <code>rbenv</code>, the command would be <code>rbenv install jruby-1.7.18</code>, followed by <code>rbenv global jruby-1.7.18</code> to set your current ruby to JRuby.</p>

<h3>Ruby Processing</h3>

<p>Install the <code>ruby-processing</code> gem globally with <code>gem install ruby-processing</code>.
If you&rsquo;re using <code>rbenv</code>, don&rsquo;t forget to run <code>rbenv rehash</code>.</p>

<h3>JRuby Complete</h3>

<p>You&rsquo;ll need the <code>jruby-complete</code> Java jar. Fortunately, there are a couple of built-in Ruby Processing commands that make it easy to install. <code>rp5</code> is the Ruby Processing command. It can be used to do many things, one of which is to install <code>jruby-complete</code> using <code>wget</code>. To do so, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rp5 setup install</span></code></pre></td></tr></table></div></figure>


<p>Once it&rsquo;s complete, you can use <code>rp5 setup check</code> to make sure everything worked.</p>

<h3>Setup Processing Root</h3>

<p>One final step. You&rsquo;ll need to set the root of your Processing app. This one-liner should take care of it for you:</p>

<p><code>echo 'PROCESSING_ROOT: /Applications/Processing.app/Contents/Java' &gt;&gt; ~/.rp5rc</code></p>

<h3>Ready To Go</h3>

<p>Now that we have everything installed and ready to go, we can start creating our first piece of art!</p>

<h2>Making Your First Sketch</h2>

<p>There are two basic parts to a Processing program: <code>setup</code> and <code>draw</code>.</p>

<p>The code in <code>setup</code> runs one time, to get everything ready to go.</p>

<p>The code in <code>draw</code> runs repeatedly in a loop. How fast is the loop? By default, it&rsquo;s 60 frames per second, although it can be limited by your machine&rsquo;s processing power. You can also manipulate it with the <code>frame_rate</code> method.</p>

<p>Here&rsquo;s an example sketch that sets the window size, background and stroke colors, and draws a circle with a square around it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>  <span class="n">size</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span>
</span><span class='line'>  <span class="n">background</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">stroke</span> <span class="mi">255</span>
</span><span class='line'>  <span class="n">no_fill</span>
</span><span class='line'>  <span class="n">rect_mode</span> <span class="no">CENTER</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw</span>
</span><span class='line'>  <span class="n">ellipse</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span>
</span><span class='line'>  <span class="n">rect</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s a quick run-through of what each of these methods is doing:</p>

<p>-<code>size()</code>: Sets the window size. It takes two arguments: width and height (in pixels).
-<code>background()</code>: Sets the background color. It takes four arguments: R, G, B, and an alpha (opacity) value.
-<code>stroke()</code>: Sets the stroke color. Takes RGBA arguments, like <code>background()</code>.
-<code>no_fill()</code>: Tells Processing not to fill in shapes with the fill color. You can turn it back on with <code>fill()</code>, which takes RGBA values.
-<code>rect_mode</code>: Tells Processing to draw rectangles using the x and y coordinates as a center point, with the other two arguments specifying width and height. The other <a href="https://processing.org/reference/rectMode_.html">available modes</a> are: CORNER, CORNERS, and RADIUS.
-<code>ellipse</code>: Draws an ellipse or circle. Takes four arguments: x-coordinate, y-coordinate, width, and height.
-<code>rect</code>: Draws a rectangle or square. Takes four arguments: x-coordinate, y-coordinate, width, and height.</p>

<p>Note that the coordinate system in Processing starts at the top-left corner, not in the middle as in the Cartesian Coordinate System.</p>

<h2>Running the Program</h2>

<p>If you&rsquo;re following along at home, let&rsquo;s see what we&rsquo;ve made! Save the code above into a file called <code>my_sketch.rb</code>.</p>

<p>There are two ways to run your program: you can either have it run once with <code>rp5 run my_sketch.rb</code>, or you can watch the filesystem for changes with <code>rp5 watch my_sketch.rb</code>. Let&rsquo;s just use the <code>run</code> version for now.</p>

<p><img src="http://i.imgur.com/VhQo15W.png"/></p>

<p>Pretty basic, but it&rsquo;s a good start! Using just the seven methods above, you can create all kinds of sketches.</p>

<h2>Other Commonly Used Methods</h2>

<p>Here are a few other useful Processing methods to add to your toolbox:</p>

<p>-<code>line()</code>: Draws a line. Takes four argments: x1, y1, x2, y2. The line is drawn from the point at the x, y coordinates of the first two arguments to the point at the coordinates of the last two arguments.
-<code>stroke_weight()</code>: Sets the width of the stroke in pixels.
-<code>no_stroke()</code>: Tells Processing to draw shapes without outlines.
-<code>smooth()</code>: Tells Processing to draw shapws with anti-aliased edges. On by default, but can be disables with <code>noSmooth()</code>.
-<code>fill()</code>: Sets the fill color of shapes. Takes RGBA arguments.</p>

<p>For a list of all the methods available in vanilla Processing, check out <a href="https://www.processing.org/reference/">this list</a>. Note that the Java implementation of these methods is in <code>camelCase</code>, but in Ruby they are <em>probably</em> in <code>snake_case</code>.</p>

<p><a href="https://github.com/jashkenas/ruby-processing/wiki/Deprecation-of-methods">Some methods have also been deprecated</a>, usually because you can use Ruby to do the same thing more easily.</p>

<p>If you see anything in the Processing docs and can&rsquo;t get it to run in Ruby Processing, use <code>$app.find_method("foo")</code> to to search the method names available in Ruby Processing.</p>

<h2>Responding to Input</h2>

<p>Now that we know how to make a basic sketch, let&rsquo;s build something that can respond to user input. This is where we leave static visual art behind, and start to make interactive digital art.</p>

<p>Although you can use all kinds of physical inputs to control Processing (e.g. Arduino, Kinect, LeapMotion), today we&rsquo;ll just use the mouse.</p>

<p>Processing exposes a number of variables exposing its state at runtime, such as <code>frame_count</code>, <code>width</code>, <code>height</code>. We can use the <code>mouse_x</code> and <code>mouse_y</code> coordinates to control aspects of our program.</p>

<p>Here&rsquo;s a sketch based on the <code>mouse_x</code> and <code>mouse_y</code> positions. It draws lines of random weight starting at the top of the screen at the mouse&rsquo;s x position (<code>mouse_x, 0</code>) to a y coordinate between 0 and 200 pixels to the right of the mouse&rsquo;s y position (<code>mouse_y + offset, height</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>  <span class="n">size</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span>
</span><span class='line'>  <span class="n">background</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">stroke</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">60</span> <span class="c1"># first argument is grayscale value, second is opacity</span>
</span><span class='line'>  <span class="n">frame_rate</span> <span class="mi">8</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw</span>
</span><span class='line'>  <span class="n">r</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>  <span class="n">stroke_weight</span> <span class="n">r</span>
</span><span class='line'>  <span class="n">offset</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">10</span>
</span><span class='line'>  <span class="n">line</span> <span class="n">mouse_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mouse_y</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Load that up and check it out!</p>

<p><img src="http://i.imgur.com/HkS0XiH.png" /></p>

<h2>Wrapping Your Sketch in a Class</h2>

<p>One last not before we go: you can totally call other methods from within your <code>setup</code> and <code>draw</code> methods. In fact, you can even wrap everything in a class that inherits from <code>Processing::App</code>.</p>

<p>You can do everything you normally do in Ruby, so you can build a whole project, with logic branches and state, that controls the visual effect through these two methods.</p>

<p>Here&rsquo;s a snippet from a version of Tic Tac Toe I built with <a href="https://twitter.com/RolenTLe">Rolen Le</a> during gSchool.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;ruby-processing&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TicTacToe</span> <span class="o">&lt;</span> <span class="no">Processing</span><span class="o">::</span><span class="no">App</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:current_player</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="n">size</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span>
</span><span class='line'>    <span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@current_player</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">draw</span>
</span><span class='line'>    <span class="n">create_lines</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_lines</span>
</span><span class='line'>    <span class="n">stroke</span> <span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">666</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">488</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">488</span><span class="p">,</span> <span class="mi">666</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">301</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">488</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">488</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#borders</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">133</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">666</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span> <span class="mi">666</span>
</span><span class='line'>    <span class="n">line</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">666</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To see the rest of the code, visit the <a href="https://github.com/fluxusfrequency/tic-tac-toe">GitHub repo</a>.</p>

<p>Another example of a game I built early on in my programming career can be found <a href="https://github.com/fluxusfrequency/mancala">here</a>. I later did a <a href="http://fluxusfrequency.github.io/blog/2014/01/17/refactoring-2-replace-method-with-method-object/">series</a> of <a href="http://fluxusfrequency.github.io/blog/2014/01/18/refactoring-3-introduce-named-parameter-and-introduce-class-annotation/">refactorings</a> of this <a href="http://fluxusfrequency.github.io/blog/2014/01/27/refactoring-4-remove-middle-man/">code</a> on my <a href="http://fluxusfrequency.github.io/blog/archives/">personal blog</a>.</p>

<p>I&rsquo;m still working on a pattern for game development with that I like. Keep an eye out for future posts about the best way to build a game with Ruby Processing.</p>

<h2>Learning More</h2>

<p>There&rsquo;s so much more you can do in Processing than what we&rsquo;ve covered here! Bézier curves, translations, rotations, images, fonts, audio, video, and 3D sketching are all available.</p>

<p>The best way to figure out how to do a lot of sketching. Just tinkering with the methods covered in this post would be enough to keep you busy creating new things for years.</p>

<p>If you&rsquo;ve really caught the bug and want to go even <em>deeper</em>, check out some of these resources to learn more.</p>

<h3>Built-in Samples</h3>

<p>If you run <code>rp5 setup unpack_samples</code>, you&rsquo;ll get a bunch of Processing sketch samples in a directory located at <code>~/rp_samples</code>. I encourage you to open them up and take a look. There&rsquo;s a lot you can glean by changing little bits of code in other projects.</p>

<h3>Online Examples From Books</h3>

<p>Learning Processing is an excellent book by Daniel Shiffman. In addition to being a valuable resource for Processing users, it has a number of <a href="http://www.learningprocessing.com/examples/">examples available online</a>.</p>

<p>Daniel Shiffman also wrote a book called <a href="http://natureofcode.com/">The Nature of Code</a>. The examples from it have been <a href="https://github.com/ruby-processing/The-Nature-of-Code-Examples-in-Ruby">ported to Ruby</a> and are another great resource for learning more.</p>

<h3>Process Artist</h3>

<p>There&rsquo;s a great Jumpstart Lab tutorial called <a href="http://tutorials.jumpstartlab.com/projects/process_artist.html">Process Artist</a>, that walks you through building a drawing program à la MSPaint.</p>

<h2>Conclusion</h2>

<p>Processing is an awesome multi-disciplinary tool. It sits at the intersection of coding, visual art, photography, sound art, and interactive digital experiences. With the availability of Ruby Processing, it&rsquo;s super easy to get started.</p>

<p>If you&rsquo;re a programmer looking for a way to express your creativity, you couldn&rsquo;t find a better way to do it than to try tinkering with Processing. I hope this post gets you off to a great start. Good luck and keep sketching!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/02/04/setting-up-a-client-side-javascript-project-with-gulp-and-browserify/">Setting Up a Client-Side JavaScript Project With Gulp and Browserify</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-02-04T21:17:21-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/client-side-javascript-project-gulp-and-browserify">Engine Yard</a>.</p>

<h2>Introduction</h2>

<p>For JavaScript developers, it can be hard to keep up to date with the latest frameworks and libraries. It seems like every day there&rsquo;s a new <em>something</em>.js to check out. Luckily, there is one part of the toolchain that doesn&rsquo;t change as often, and that&rsquo;s the build process. That said, it&rsquo;s worth checking out your options every now and then.</p>

<p>My build process toolset has traditionally been comprised of <a href="http://requirejs.org/">RequireJS</a> for dependency loading, and <a href="http://gruntjs.com/">Grunt</a>. They&rsquo;ve worked great, but recently I was pairing with someone who prefers to use <a href="http://gulpjs.com/">Gulp</a> and <a href="http://browserify.org/">Browserify</a> instead. After using them on a couple of projects, I&rsquo;m coming to like them quite a bit. They&rsquo;re great for use with Backbone, Angular, Ember, React, and my own hand-rolled JavaScript projects.</p>

<p>In this post, we&rsquo;ll explore how to set up a clientside JavaScript project for success using Gulp and Browserify.</p>

<h2>Defining the Project Structure</h2>

<p>For the purposes of this post, we&rsquo;ll pretend we&rsquo;re building an app called Car Finder, that helps you remember where you parked your car. If you want to follow along, check out the <a href="https://github.com/fluxusfrequency/car-finder">code on GitHub</a>.</p>

<p>When building a full application that includes both an API server and a clientside JavaScript app, there&rsquo;s a certain project structure that I&rsquo;ve found often works well for me. I like to put my clientside app in a folder one level down from the root of my project, called <code>client</code>. This folder usually has sibling folders named <code>server</code>, <code>test</code>, <code>public</code>, and <code>build</code>. Here&rsquo;s how this would look for Car Finder:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>car-finder
</span><span class='line'>|- build
</span><span class='line'>|- client
</span><span class='line'>   |- less
</span><span class='line'>|- public
</span><span class='line'>   |- javascripts
</span><span class='line'>   |- stylesheets
</span><span class='line'>|- server
</span><span class='line'>|- test</span></code></pre></td></tr></table></div></figure>


<p>The idea is to do our app developent inside of <code>client</code>, then use a build task to compile the JS and copy it to the <code>build</code> folder, where it will be minified, uglified, and copied to <code>public</code> to be served by the backend.</p>

<h2>Pulling In Dependencies</h2>

<p>To get up and running, we&rsquo;ll need to pull in some dependencies.</p>

<p>Run <code>npm init</code> and follow the prompts.</p>

<p>Add <code>browserify</code>, <code>gulp</code>, and our build and testing dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm install --save-dev gulp gulp-browserify browserify-shim gulp-jshint gulp-mocha-phantomjs <span class="se">\</span>
</span><span class='line'>gulp-rename gulp-uglify gulp-less gulp-autoprefixer gulp-minify-css mocha chai
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re using git, you may want to ignore your <code>node_modules</code> folder with <code>echo "node_modules" &gt;&gt; .gitignore</code>.</p>

<h2>Shimming Your Frameworks</h2>

<p>You&rsquo;ll probably want to use <code>browserify-shim</code> to shim jQuery and your JavaScript framework so that you can write <code>var $ = require('jquery')</code> into your code. We&rsquo;ll use jQuery here, but the process is the same for any other library (Angular, Ember, Backbone, React, etc.). To set it up, modify your <code>package.json</code> like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;car-finder&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Ben Lewis&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;gulp-rename&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp&quot;</span><span class="p">:</span> <span class="s2">&quot;^3.8.10&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-mocha-phantomjs&quot;</span><span class="p">:</span> <span class="s2">&quot;^0.5.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-jshint&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.9.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-browserify&quot;</span><span class="p">:</span> <span class="s2">&quot;^0.5.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;browserify&quot;</span><span class="p">:</span> <span class="s2">&quot;^6.3.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;browserify-shim&quot;</span><span class="p">:</span> <span class="s2">&quot;^3.8.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;mocha&quot;</span><span class="p">:</span> <span class="s2">&quot;^2.0.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-minify-css&quot;</span><span class="p">:</span> <span class="s2">&quot;^0.3.11&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-uglify&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.0.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-autoprefixer&quot;</span><span class="p">:</span> <span class="s2">&quot;^2.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;gulp-less&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.3.6&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;chai&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.10.0&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;browserify-shim&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;jquery&quot;</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;browserify&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;transform&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;browserify-shim&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re getting JSHint errors in your editor for this file, you can turn them off with <code>echo "package.json" &gt;&gt; .jshintignore</code>.</p>

<h2>Setting Up Gulp</h2>

<p>Now that we have the <code>gulp</code> package installed, we&rsquo;ll configure <code>gulp</code> tasks to lint our code, test it, trigger the compilation process, and copy our minified JS into the <code>public</code> folder.  We&rsquo;ll also set up a <code>watch</code> task that we can use to trigger a lint and recompile of our project whenever a source file is changed.</p>

<p>We&rsquo;ll start by requiring the <code>gulp</code> packages we want in a <code>gulpfile.js</code> that lives in the root of the project.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Gulp Dependencies</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">rename</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-rename&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build Dependencies</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">browserify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-browserify&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">uglify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-uglify&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Style Dependencies</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">less</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-less&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-autoprefixer&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">minifyCSS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-minify-css&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Development Dependencies</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">jshint</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-jshint&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Test Dependencies</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">mochaPhantomjs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-mocha-phantomjs&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can start defining some tasks.</p>

<h3>JSHint</h3>

<p>To set up linting for our clientside code as well as our test code, we&rsquo;ll add the following to the <code>gulpfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint-client&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./client/**/*.js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">jshint</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">jshint</span><span class="p">.</span><span class="nx">reporter</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint-test&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./test/**/*.js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">jshint</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">jshint</span><span class="p">.</span><span class="nx">reporter</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll also need to define a <code>.jshintrc</code> in the root of our project, so that JSHint will know which rules to apply. If you have a JSHint plugin turned on in your editor, it will show you any linting errors as well. I use <a href="https://github.com/wookiehangover/jshint.vim">jshint.vim</a>. Here&rsquo;s an example of a typical <code>.jshintrc</code> for one of my projects. You&rsquo;ll notice that it has some predefined globals that we&rsquo;ll be using in our testing environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;camelcase&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;curly&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;eqeqeq&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;expr&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;forin&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;immed&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;indent&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;latedef&quot;</span><span class="p">:</span> <span class="s2">&quot;nofunc&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;newcap&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;noarg&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;node&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;nonbsp&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;quotmark&quot;</span><span class="p">:</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;undef&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;unused&quot;</span><span class="p">:</span> <span class="s2">&quot;vars&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;trailing&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;globals&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;after&quot;</span>      <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;afterEach&quot;</span>  <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;before&quot;</span>     <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;beforeEach&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;context&quot;</span>    <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;describe&quot;</span>   <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;it&quot;</span>         <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;window&quot;</span>     <span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mocha</h3>

<p>I&rsquo;m a Test-Driven Development junkie, so one of the first things I always do when setting up a project is to make sure I have a working testing framework. For clientside unit testing, I like to use <a href="https://www.npmjs.org/package/gulp-mocha-phantomjs">gulp-mocha-phantomjs</a>, which we already pulled in above.</p>

<p>Before we can run any tests, we&rsquo;ll need to create a <code>test/client/index.html</code> file for Mocha to load up in the headless PhantomJS browser environment. It will pull Mocha in from our <code>node_modules</code> folder, require <code>build/client-test.js</code> (more on this in a minute), then run the scripts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!doctype html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Mocha Test Runner<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;../../node_modules/mocha/mocha.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;mocha&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;../../node_modules/mocha/mocha.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script&gt;</span><span class="nx">mocha</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="s1">&#39;bdd&#39;</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;../../build/client-test.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">mochaPhantomJS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">mochaPhantomJS</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">mocha</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setting Up Browserify</h2>

<p>Now we need to set up Browserify to compile our code. First, we&rsquo;ll define a couple of <code>gulp</code> tasks: one to build the app, and one to build the tests. We&rsquo;ll copy the result of the compile to <code>public</code> so we can serve it unminified in development, and we&rsquo;ll also put a copy into <code>build</code>, where we&rsquo;ll grab it for minification. The  compiled test file will also go into <code>build</code>. Finally, we&rsquo;ll set up a <code>watch</code> task to trigger rebuilds of the app and test when one of the source files changes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;browserify-client&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lint-client&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;client/index.js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">browserify</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">insertGlobals</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;car-finder.js&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/javascripts&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;browserify-test&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lint-test&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;test/client/index.js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">browserify</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">insertGlobals</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;client-test.js&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;client/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;browserify-client&#39;</span><span class="p">]);</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;test/client/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;browserify-test&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s one more thing we&rsquo;ll need to do before we can run our <code>gulp</code> tasks, which is to make sure we actually have <code>index.js</code> files in each of the folders we&rsquo;ve it to look at, so it doesn&rsquo;t raise an error. Add one to the <code>client</code> and <code>test/client</code> folders.</p>

<p>Now, when we run <code>gulp browserify-client</code> from the command line, we see new <code>build/car-finder.js</code> and <code>public/javascripts/car-finder.js</code> files. In the same way, <code>gulp browserify-test</code> creates a <code>build/client-test.js</code> file.</p>

<h2>More Testing</h2>

<p>Now that we have Browserify set up, we can finish getting our test environment up and running. Let&rsquo;s define a <code>test</code> Gulp task and add it to our <code>watch</code>. We&rsquo;ll add <code>browserify-test</code> as a dependency for the <code>test</code> task, so our <code>watch</code> will just require <code>test</code>. We should also update our watch to run the tests whenever we change any of the app <em>or</em> test files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lint-test&#39;</span><span class="p">,</span> <span class="s1">&#39;browserify-test&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;test/client/index.html&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">mochaPhantomjs</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;client/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;browserify-client&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]);</span>
</span><span class='line'>  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;test/client/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>To verify that this is working, let&rsquo;s write a simple test in <code>test/client/index.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chai&#39;</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;test setup&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should work&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, when we run <code>gulp test</code>, we should see Gulp run the <code>lint-test</code>, <code>browserify-test</code>, and <code>test</code> tasks and exit with one passing example. We can also test the <code>watch</code> task by running <code>gulp watch</code>, then making changes to <code>test/client/index.js</code> or <code>client/index.js</code>, which should trigger the tests.</p>

<h2>Building Assets</h2>

<p>Next, let&rsquo;s turn our attention to the rest of our build process. I like to use <code>less</code> for styling. We&rsquo;ll need a <code>styles</code> task to compile it down to CSS. In the process, we&rsquo;ll use <a href="https://www.npmjs.org/package/gulp-autoprefixer">gulp-autoprefixer</a> so that we don&rsquo;t have to write vendor prefixes in our CSS rules. As we did with the app, we&rsquo;ll create a development copy and a build copy, and place them in <code>public/stylesheets</code> and <code>build</code>, respectively. We&rsquo;ll also add the <code>less</code> directory to our <code>watch</code>, so changes to our styles will get picked up.</p>

<p>We should also uglify our JavaScript files to improve page load time. We&rsquo;ll write tasks for minification and uglification, then copy the minified production versions of the files to <code>public/stylesheets</code> and <code>public/javascripts</code>. Finally, we&rsquo;ll wrap it all up into a <code>build</code> task.</p>

<p>Here are the changes to the <code>gulpfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;styles&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;client/less/index.less&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">less</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">prefix</span><span class="p">({</span> <span class="nx">cascade</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;car-finder.css&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/stylesheets&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;minify&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;styles&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;build/car-finder.css&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minifyCSS</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;car-finder.min.css&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/stylesheets&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;uglify&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;browserify-client&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;build/car-finder.js&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">uglify</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">&#39;car-finder.min.js&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">&#39;public/javascripts&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uglify&#39;</span><span class="p">,</span> <span class="s1">&#39;minify&#39;</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we now run <code>gulp build</code>, we see the following files appear:
- <code>build/car-finder.css</code>
- <code>public/javascripts/car-finder.min.js</code>
- <code>public/stylesheets/car-finder.css</code>
- <code>public/stylesheets/car-finder.min.css</code></p>

<h2>Did It Work?</h2>

<p>We&rsquo;ll want to check that what we&rsquo;ve built is actually going to work.  Let&rsquo;s add a little bit of styling and JS code to make sure it&rsquo;s all getting compiled and served the way we hope it is. We&rsquo;ll start with an <code>index.html</code> file in the <code>public</code> folder. It will load up the development versions of our CSS and JS files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!doctype html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Car Finder<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;stylesheets/car-finder.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;javascripts/car-finder.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll add some styling in <code>client/less/index.less</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="n">DarkOliveGreen</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;ll write our million dollar app in <code>client/index.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;I found your car!&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s put it all together. Run <code>grunt build</code>, then <code>open public/index.html</code>. Our default browser opens a beautiful olive green screen with an alert box. Profit!</p>

<h2>One Task To Rule Them All</h2>

<p>At this point, I usually like to tie it all together with a <code>default</code> Gulp task, so all I have to do is run <code>gulp</code> to check that everything&rsquo;s going together the way I expect, and start watching for changes. Since <code>test</code> already does the linting and browserifying, all we really need here is <code>test</code>, <code>build</code>, and <code>watch</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping Up</h2>

<p>We&rsquo;ve now set up our project to use Browserify and Gulp. The former took the headache out of requiring modules and dependencies, and the latter made defining tasks for linting, testing, <code>less</code> compilation, minification, and uglification a breeze.</p>

<p>I hope you&rsquo;ve found this exploration of Gulp and Browserify has been enlightening. I personally love these tools. For the moment, they&rsquo;re my defaults when creating a personal project. I hope this post helps make your day-to-day development more fun by simplifying things. Thanks for reading!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/01/29/instances/">Instances, Classes, and Modules, Oh My!</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-01-29T21:05:58-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/instances-classes-and-modules">Engine Yard</a> and was later published on the <a href="https://quickleft.com/blog/instances-classes-and-modules-oh-my/">Quick Left Blog</a>.</p>

<h2>Introduction</h2>

<p>One of the biggest challenges of object oriented programming in Ruby is defining the interface of your objects. In other languages, such as Java, there is an explicit way to define an interface that you must conform to. But in Ruby, it&rsquo;s up to you.</p>

<p>Compounding with this difficulty is the problem of deciding which object should own a method that you want to write. Trying to choose between modules, class methods, instance methods, structs, and lambdas can be overwhelming.</p>

<p>In this post, we&rsquo;ll look at several ways to solve the Exercism <a href="http://exercism.io/nitpick/ruby/leap">Leap Year</a> problem, exploring different levels of method visiblitiy and scope level along the way.</p>

<h2>Leap Year</h2>

<p>If you sign up for <a href="http://exercism.io/">Exercism.io</a> and start solving Ruby problems, one of the first problems you will look at is called Leap Year. The tests guide you to write a solution that has an interface that works like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Year</span><span class="o">.</span><span class="n">leap?</span><span class="p">(</span><span class="mi">1984</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>A leap year is defined as a year that is divisible by four, unless it&rsquo;s also divisible by 100. Apparently, centuries aren&rsquo;t leap years. That is, unless they are centuries that are divisible by 400. So there are three rules for leap years:</p>

<p>1) If it&rsquo;s divisible by 400, it&rsquo;s an exceptional century and is a leap year.
2) If it&rsquo;s divisible by 100, it&rsquo;s a mundane century and in not a leap year.
3) Otherwise, if it&rsquo;s divisible by 4, it&rsquo;s a leap year, otherwise it&rsquo;s not.</p>

<h2>The First Approach: Using Class Methods</h2>

<p>Here&rsquo;s one simple solution to this problem. You can rearrange the booleans in a couple of different ways and it will still work. This is the version I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is nice and compact, but not entirely easy to understand. I&rsquo;m a pretty big fan of self-documenting code, so I used the <a href="http://fluxusfrequency.github.io/blog/2014/01/10/refactoring-1-extract-method/">extract method</a> refactoring pattern to name these three rules.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Class Methods and Privacy</h2>

<p>This is a lot more understandable, in my mind. But there&rsquo;s a problem with this. <code>mundane_leap?</code>, <code>century?</code>, and <code>exceptional_century?</code> are all publicly exposed methods. They really only exist in support of <code>leap?</code>, and I&rsquo;m not sure how reusable they are, with the possible exception of <code>century?</code>. If I write this test, it will pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">test_exceptional_century</span>
</span><span class='line'>    <span class="n">assert</span> <span class="no">Year</span><span class="o">.</span><span class="n">exceptional_century?</span><span class="p">(</span><span class="mi">2400</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I would like to make <code>exceptional_century?</code> private, so that it can&rsquo;t be accessed outside of the <code>Year</code> class. I can try something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, unfortunately, this won&rsquo;t work. The test still passes, becuase the <code>private</code> keyword doesn&rsquo;t work on class methods. Instead, I would have to use <code>private_class_method</code> after my method definition.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">private_class_method</span> <span class="ss">:mundane_leap?</span><span class="p">,</span> <span class="ss">:century?</span><span class="p">,</span> <span class="ss">:exceptional_century?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if I run that last test, it will raise an error.</p>

<h2>All About the Eigenclass</h2>

<p>In my mind, what we&rsquo;ve now done is somewhat better, but there&rsquo;s still a smell here. I&rsquo;ll get to exactly what that is in just a moment, but for now I&rsquo;ll say that it&rsquo;s due to the fact that we&rsquo;ve defined all of these methods on the singleton class, or eigenclass, of <code>Year</code>. If you don&rsquo;t know about eigenclasses, you can read about them <a href="http://madebydna.com/all/code/2011/06/24/eigenclasses-demystified.html">here</a>.</p>

<p>We can define methods on an eigenclass by prepending each method definition with <code>self.</code>, or we can use <code>class &lt;&lt; self</code> or <code>class &lt;&lt; Year</code> and nesting our method definitions inside of that block. Doing it this way makes it possible to use the <code>private</code> keyword, because we&rsquo;re now working at the instance level of scope. If we were to introduce <code>class &lt;&lt; self</code>, then, we could do away with our <code>private_class_method</code> call.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>      <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we haven&rsquo;t really changed much here. In my mind, there&rsquo;s still a big smell, which is this. <a href="http://en.wikipedia.org/wiki/Class_%28computer_programming%29">According to Wikipedia</a>, a class is (emphasis mine) &ldquo; an extensible program-code-template for <em>creating objects</em> &rdquo;. Our <code>Year</code> class never creates a single instance. It&rsquo;s just an eigenclass that happens to be able to create (mostly) useless <code>Year</code> instances.</p>

<p>So where <em>should</em> we be putting class-level methods that are not associated with any instance object?</p>

<h2>Second Approach: Module Functions</h2>

<p>In Ruby, the <code>Class</code> object inherits from <code>Module</code>. A module is basically a collection of methods, constants, and classes. Their primary feature is that they can be mixed into other modules and classes to extend their functionality. They&rsquo;re also frequently used for namespacing (for example, the <code>ActiveRecord</code> constant is a module).</p>

<p>We can put our <code>Year</code> implementation into a module without changing much: just swap the word <code>class</code> for <code>module</code>. Instead of using <code>class &lt;&lt; self</code> as we did for the class version, we can use <code>extend self</code> in our module, and get the same effect, allowing us to use the <code>private</code> keyword. <code>extend</code> takes the methods defined in a module and makes them into class-level methods on the target module (or class). This is in contrast with <code>include</code>, which mixes them in as instance-level methods. Thus, if we extend the module into itself, it gets all of it&rsquo;s own methods at the class level.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Year</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we wanted to define some other methods in a <code>Year</code> class that had nothing to do with leap years, we could change the name of our module to <code>Leap</code> and mix it into a <em>class</em> called <code>Year</code>.</p>

<p>If we want to make the three leap year rule methods private, we now have another choice of how to do it. We can use <code>module_function</code>.  <code>module_function</code> will make these methods available to the module, but when they get mixed into the class, they will be private. Module functions allow you to be selective with what can be called by the module itself, while still defining methods that can be mixed into other modules and classes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Leap</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">||</span> <span class="n">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">module_function</span> <span class="ss">:mundane_leap?</span><span class="p">,</span> <span class="ss">:century?</span><span class="p">,</span> <span class="ss">:exceptional_century?</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Year</span><span class="p">;</span> <span class="kp">extend</span> <span class="no">Leap</span><span class="p">;</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we run the tests, they will all still pass, with the exception of the one we wrote that tries to call <code>exceptional_century?</code></p>

<h2>Third Approach: Instance Methods</h2>

<p>I want to stay with the idea that we might want a <code>Year</code> class that can do other things unrelated to determining whether we are talking about leap year or not. Really, there are a bunch of different years, but they all have certain things in common (which era they fall in, whether they are leap, etc.). In my mind, this would be a good use case for instances instead of class level methods.</p>

<p>What it look like if we brought the responsibility for knowing whether a year is leap back into a <code>Year</code> class, but passing that behavior onto <em>instances</em> of year, instead of putting it on the eigenclass?</p>

<p>It&rsquo;s a little weird to be able to do something like <code>Year.new(2015).year</code>, so I&rsquo;ll name the state we&rsquo;re going to store <code>reckoning</code> instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">leap?</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">leap?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:reckoning</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">reckoning</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@reckoning</span> <span class="o">=</span> <span class="n">reckoning</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">leap?</span>
</span><span class='line'>    <span class="n">mundane_leap?</span> <span class="o">||</span> <span class="n">exceptional_century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mundane_leap?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">century?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">century?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exceptional_century?</span>
</span><span class='line'>    <span class="n">reckoning</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The instance-based approach has certain advantages. We don&rsquo;t have to use anything exotic like <code>private_class_method</code>, <code>class &lt;&lt; self</code>, or <code>module_function</code>, to make our methods private. This might make things easier to understand for future maintainers of our code.</p>

<p>We also gained access to the <code>reckoning</code>, that could be used to calculate other properites in the future. For example, if we wanted to write <code>to_julian</code> or <code>to_hebrew</code> methods, we&rsquo;d already have the number we&rsquo;d need to use to calculate that available to us.</p>

<p>Finally, we can now use a <code>protected</code> section as well. Methods in this section will only be visible to other instances of <code>Year</code>. We might use it to do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Year</span>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">recoking</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">reckoning</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>We&rsquo;ve looked at several different ways to write a program that can tell us whether a given year is a leap year. Each has its advantages and disadvantages.</p>

<p>We started with a class method that was a single-liner. There&rsquo;s a lot of value in the compactness of <code>year % 4 == 0 &amp;&amp; !(year % 100 == 0) || year % 400 == 0</code>. But it&rsquo;s also fairly hard to understand. If we decide to split some of that logic into separate methods, now we&rsquo;re faced with the problem of how to keep these new methods out of the interface of <code>Year</code>.</p>

<p>We used an eigenclass-based approach, simply hiding the implementation methods with <code>private_class_method</code>. We solved it using a module, treating the <code>leap?</code> method both as a mix-in and as a <code>module_function</code>. Finally, we pushed the functionality down to the instance level, which could help us in dealing with multiple <code>Year</code> objects down the road.</p>

<p>Which of these approaches is best?</p>

<p>It depends on lots of things: how you feel about privacy, how you expect the program to change in the future, how comfortable you are with scope and the more arcane methods in Ruby.  At the very least, it&rsquo;s nice to know what&rsquo;s available to you when thinking about what methods you want to expose, and what level of scope you should use it on.  I hope this post will factor into your thoughts when making these kind of decisions in the future.</p>

<p>P.S. What do you think? Did this make sense? Should I have used Structs or Lambdas? Throw us a comment below!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/01/22/measuring-client-side-javascript-test-coverage-with-istanbul/">Measuring Client-Side JavaScript Test Coverage With Istanbul</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-01-22T21:16:59-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2015/measuring-clientside-javascript-test-coverage-with-istanbul">Engine Yard</a>.</p>

<p>It was also published on the <a href="https://quickleft.com/blog/measuring-clientside-javascript-test-coverage-istanbul/">Quick Left Blog</a>.</p>

<h2>Introduction</h2>

<p>Testing is a vital part of any development process. Whether a project&rsquo;s authors are hoping for scalability, fewer bugs, or just code that stands the test of time, a solid test suite is essential.</p>

<p>It&rsquo;s all well and good writing tests, but how do you know that you&rsquo;ve tested the code that matters? Did you cover the most important components? Did you test <a href="http://engineering.imvu.com/2012/05/08/writing-resilient-unit-tests-3/">the sad path</a>? The edge cases? What about the <a href="http://emptystat.es/">zero states</a>?</p>

<p>Using <a href="http://gotwarlost.github.io/istanbul/">Istanbul</a>, you can generate a nice coverage report to answer these questions. In this article, we&rsquo;ll look at how to get it set up in a typical clientside JS project.</p>

<h2>A Note About Metrics</h2>

<p>Before we get into the process of setting up Istanbul, I&rsquo;d like to talk about code coverage as a metric. Metrics in programming can be very two-sided. On the one hand, they can be very useful in measuring velocity and predicting completion of new features. But, they can also become self-fulfilling prophecies leading to bad code.</p>

<p>For example, if a project manager or tech lead measures her programmers&#8217; effectiveness by counting the lines of code they write, she will not find that those who wrote the most lines are the ones that wrote the best code. In fact, there&rsquo;s a danger that some of the programmers will adopt a verbose style, using far more lines than necessary to get the same thing done, in order to bump their ranking.</p>

<p>Placing a strong emphasis on test coverage as a metric can lead to a similar problem. Imagine that a company adopts a policy that any pull request must increase or maintain the percentage of lines tested. What will be the result?</p>

<p>I imagine that in many cases, developers will write good tests to accompany their features and bugfixes. But what happens if there’s a rush and they just want to get the code in?</p>

<p>Test coverage tools only count the lines that were hit when the test suite was run, so the developer can just run the line in question during the test, while making a trivial assertion. The result? The line is marked covered, but nothing meaningful is being tested.</p>

<p>Rather than using test coverage as a measure of developer thoroughness, it makes a lot more sense to use coverage as a way of seeing which code <em>isn&rsquo;t</em> covered (hint: it&rsquo;s often <code>else</code> branches). That information can then be used to prioritize testing goals.</p>

<p>In summary: don&rsquo;t use code coverage to measure what&rsquo;s tested, use it to find out what isn&rsquo;t.</p>

<h2>Time to Test</h2>

<p>Let&rsquo;s imagine that we have a clientside JavaScript application written in Angular, Ember, or Backbone and templated with Handlebars. It&rsquo;s compiled with Browserify and built with NPM scripts.</p>

<p>This application has been around for a couple of years, and due to business pressures, its authors have only managed to write a handful of tests. At this point, the app is well-established, and there <em>is</em> a testing setup in place, but there&rsquo;s also a lot of code that&rsquo;s untested.</p>

<p>Recently, the company behind the application closed a funding round, and they&rsquo;re feeling flush. We&rsquo;ve been brought in to write some tests.</p>

<p>Because we&rsquo;re hotshots and we want to show off, we decide to begin by taking a snapshot of the current code coverage, so that we can brag about how many percentage points we added to the coverage when we&rsquo;re done.</p>

<h2>Setting up Istanbul</h2>

<p>This is where <a href="http://gotwarlost.github.io/istanbul/">Istanbul</a> comes in. Istanbul is a code coverage tool written in JavaScript by <a href="https://github.com/gotwarlost">Krishnan Anantheswaran</a> of Yahoo!.</p>

<p>It can be a little tricky to set up, so let&rsquo;s take a look at one way to do it.</p>

<p>There are four steps in our approach:</p>

<ol>
<li>Instrument the source code with Istanbul</li>
<li>Run <code>mocha-phantomjs</code>, passing in a <code>hooks</code> argument</li>
<li>Use a <code>phantomjs</code> hook file to write out the results when testing is complete</li>
<li>Run the <code>Istanbul</code> cli to generate the full report as an HTML file</li>
</ol>


<p>Let&rsquo;s get started.</p>

<h3>1. Instrument the Source</h3>

<p>We&rsquo;ll need to find a way to run our code through Istanbul after it&rsquo;s been compiled, so the first step is to set up an NPM task that will pipe compiled code into a tool like <a href="https://github.com/devongovett/browserify-istanbul">browserify-istanbul</a>.</p>

<p>Just in case you&rsquo;re not using <code>browserify</code>, a variety of other Istanbul NPM packages exist for instrumenting code, including <a href="https://github.com/SBoudrias/gulp-istanbul">browserify-gulp</a>, <a href="https://github.com/justspamjustin/grunt-istanbul-reporter">grunt-istanbul-reporter</a>, and <a href="https://github.com/bem/borschik-tech-istanbul">borschik-tech-istanbul</a>.</p>

<p>For the moment, let&rsquo;s imagine that we <em>are</em> using Browserify. We already have NPM tasks in place to compile our code for development/production and for testing. Here&rsquo;s what they look like. Note that the <code>-o</code> option to <code>browserify</code> specifies the output file for the build and the <code>-d</code> option turns on debugging.</p>

<p>In <code>package.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="s2">&quot;build&quot;</span><span class="o">:</span> <span class="s2">&quot;browserify ./js/main.js -o html/static/build/js/myapp.js&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;build-test&quot;</span><span class="o">:</span> <span class="s2">&quot;browserify -r handlebars:hbsfy/runtime ./js/test/index.js -o html/static/build/js/test.js -d --verbose&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use the <code>build-test</code> task as a template for a new <code>build-test-coverage</code> task.</p>

<p>Before we do that, we&rsquo;ll want to make sure we pull in <code>browserify-istanbul</code> with <code>npm install --save-dev browserify-istanbul</code>.</p>

<p>Next, we&rsquo;ll write the task in <code>package.json</code>. We&rsquo;ll ignore the Handlebars templates and Node modules when we load everything into Istanbul. We&rsquo;ll also use the <code>-t</code> option to Browserify to use a <a href="https://github.com/substack/module-deps#transforms">transform module</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="s2">&quot;build-test-coverage&quot;</span><span class="o">:</span> <span class="s2">&quot;mkdir -p html/static/build/js/ &amp;&amp; browserify -r handlebars:hbsfy/runtime -t [ browserify-istanbul --ignore **/*.hbs **/bower_components/** ] ./js/test/index.js -o html/static/build/js/test.js -d&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the <code>browserify-istanbul</code> package and the <code>build-test-coverage</code> script in place, we&rsquo;ve got our code instrumented, and we&rsquo;re ready to move on to step two.</p>

<h3>2. Run <code>mocha-phantomjs</code>, Passing in a Hooks Argument</h3>

<p>Now that the code is all built and ready to go, we need to pass it into a test framework. We&rsquo;ll use write a cli script that spawns <a href="https://github.com/metaskills/mocha-phantomjs">mocha-phantomjs</a> in a child process. We&rsquo;ll pass in a hooks argument that specifies a <code>phantom_hooks.js</code> file we&rsquo;ve yet to write.</p>

<p>(Note: if you&rsquo;re using <code>gulp</code> or <code>grunt</code>, you may want to check out <a href="https://github.com/mrhooray/gulp-mocha-phantomjs">gulp-mocha-phantomjs</a> or <a href="https://github.com/jdcataldo/grunt-mocha-phantomjs">grunt-mocha-phantomjs</a> for this step.)</p>

<p>In <code>js/test/cli.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span><span class="o">!</span><span class="err">/usr/bin/env node</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;mocha-phantomjs&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>  <span class="s1">&#39;http://localhost:9000/static/js/test/index.html&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;--timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;25000&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;--hooks&#39;</span><span class="p">,</span> <span class="s1">&#39;./js/test/phantom_hooks.js&#39;</span>
</span><span class='line'><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">child</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Mocha process exited with code &#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>With our cli script in place, we&rsquo;ve now got a way to put our Istanbulified code into PhantomJS, so we&rsquo;ll move to step three.</p>

<h3>3. Use a PhantomJS Hook File to Write the Results</h3>

<p>In the script we wrote in the last section, we passed a hooks file to <code>mocha-phantomjs</code>, but we hadn&rsquo;t created it yet. Let&rsquo;s do that now.</p>

<p>After all the tests have run, our hook will grab the <code>__coverage__</code> property of the window, which contains the result of our coverage run, and write it to a <code>coverage/coverage.json</code> file.</p>

<p>We&rsquo;ll load this data into the Istanbul CLI to generate a more readable report in the next step.</p>

<p>In <code>js/test/phantom_hooks.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">afterEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">runner</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">coverage</span> <span class="o">=</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">__coverage__</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">coverage</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Writing coverage to coverage/coverage.json&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">fs</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;coverage/coverage.json&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">coverage</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;No coverage data generated&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>With our coverage data saved, we&rsquo;re ready to move on to the last step.</p>

<h3>4. Run the Istanbul CLI to Generate the Full Report</h3>

<p>The final step in our process is to take the coverage data generated in step three and plug it into the Istanbul CLI to generate a coverage report HTML file.</p>

<p>We&rsquo;ll write an NPM script that executes the <code>instanbul report</code> command, passing it the folder where we saved our results (<code>coverage</code>), and specifying <code>lcov</code> as our output format. This option will save both <code>lcov</code> and <code>html</code> files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="s2">&quot;coverage-report&quot;</span><span class="o">:</span> <span class="s2">&quot;istanbul report --root coverage lcov&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have all the scripts we need to generate and view our coverage report.</p>

<h2>Generating the Report</h2>

<p>We&rsquo;ll need to run each of the commands that we&rsquo;ve defined before we&rsquo;ll be able to view our results (you may want to wrap these in a single NPM task for convenience).</p>

<ul>
<li><code>npm run build-test-coverage</code> to compile our test code and load it into Istanbul</li>
<li><code>./js/test/cli.js</code> to run the tests with <code>mocha-phantomjs</code> and write the <code>coverage.json</code> file</li>
<li><code>npm run coverage-report</code> to format the coverage results as an HTML file</li>
</ul>


<p>Once we&rsquo;ve completed these steps, we should see a new <code>coverage/lcov-report</code> folder containing an <code>index.html</code> file and a few assets to make it look pretty.</p>

<h2>Viewing the Report</h2>

<p>If we open the generated file in our browser, we&rsquo;ll see an easy-to-read breakdown of our coverage.</p>

<p>There are four category columns at the top of the page, each telling us about a different aspect of our coverage.</p>

<ul>
<li><em>Statements</em> tells up how many of the statements in our code were touched during the test run.</li>
<li><em>Branches</em> tells us how many of our logical <code>if</code>/<code>else</code> branches were touched</li>
<li><em>Functions</em> tells us how many of our functions were touched</li>
<li><em>Lines</em> tells us the total lines of code that were touched</li>
</ul>


<p>There&rsquo;s also a list of the folders in our project, each with a categorical coverage breakdown. You can also click on each of the folders to further break down the coverage file by file. If you then click on a file, you&rsquo;ll see its contents highlighted in green and red to indicate covered and uncovered lines.</p>

<p>The ability to zoom in and out on our project and see the categorical breakdown at each level makes Istanbul particularly nice to work with.  It also makes it easy to dig in and explore places in your code base that might benefit from some additional testing.</p>

<h2>Wrapping Up</h2>

<p>If you haven&rsquo;t added code coverage to your JS projects yet, I highly recommend it. Getting everything up and running is a minimal time investment, and it can really pay off.</p>

<p>Although I would discourage you from measuring the success of your test suite based on percentage points only, getting an in-depth look at what you currently are and aren&rsquo;t touching can really pave the way to uncovering bugs you didn&rsquo;t even know you had.</p>

<p>I hope that this post has helped you get Istanbul up and running with a minimum of heartache. Until next time, keep testing!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2015/01/16/five-ruby-methods-you-should-be-using/">Five Ruby Methods You Should Be Using</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2015-01-16T06:55:21-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post was featured as one of Ruby Weekly&rsquo;s <a href="http://rubyweekly.com/issues/279">Best Links of 2015</a>.
Before that, it was the top featured article in <a href="http://rubyweekly.com/issues/229">Ruby Weekly #229</a>.
It was also the top featured article in issue #15.1 of the <a href="http://www.pointer.io/">Pointer.io</a> newsletter.</p>

<p>It was originally published on <a href="https://blog.engineyard.com/2015/five-ruby-methods-you-should-be-using">Engine Yard</a> and also appeared on the <a href="https://quickleft.com/blog/five-ruby-methods-you-should-be-using/">Quick Left Blog</a>.</p>

<h2>Introduction</h2>

<p>There&rsquo;s something magical about the way that Ruby just flows from your fingertips. why once <a href="http://mislav.uniqpath.com/poignant-guide/book/chapter-2.html">said</a> &ldquo;Ruby will teach you to express your ideas through a computer.&rdquo; Maybe that&rsquo;s why Ruby has become such a <a href="http://blog.codeeval.com/codeevalblog/2014">popular choice</a> for modern web development.</p>

<p>Just as in English, there are lots of ways to say the same thing in Ruby. I spend a lot of time reading and nitpicking people&rsquo;s code on <a href="http://exercism.io">Exercism</a>, and I often see exercises solved in a way that could be greatly simplified if the author had only known about a certain Ruby method.</p>

<p>Here&rsquo;s a look at some lesser-used methods solve a specific problem very well.</p>

<h2>Object#tap</h2>

<p>Did you ever find yourself calling a method on some object, and the return value not being what you wanted it to? You were hoping to get back the object, but instead you got back some other value. Maybe you wanted to add an arbitrary value to a set of parameters stored in a hash. You update it with <code>Hash.[]</code>, but you get back <code>'bar</code> instead of the params hash, so you have to return it explicitly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">params</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>  <span class="n">params</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>params</code> line at the end of that method seems extraneous.</p>

<p>We can clean it up with <a href="http://www.ruby-doc.org/core-2.1.5/Object.html#method-i-tap">Object#tap</a>.</p>

<p>It&rsquo;s easy to use. Just call it on the object, then pass <code>tap</code> a block with the code that you wanted to run. The object will be yielded to the block, then be returned. Here&rsquo;s how we could use it to improve <code>update_params</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">params</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are dozens of great places to use <code>Object#tap</code>. Just keep your eyes open for methods called on an object that don&rsquo;t return the object, when you wish that they would.</p>

<h2>Array#bsearch</h2>

<p>I don&rsquo;t know about you, but I do a lot of looking through arrays for data. Ruby enumerables make it easy to find what I need: <code>select</code>, <code>reject</code>, and <code>find</code> are valuable tools that I use daily. But when the dataset is big, I start to worry about the length of time it will take to go through all of those records.</p>

<p>If you&rsquo;re using <code>ActiveRecord</code> and dealing with a <code>SQL</code> database, there&rsquo;s a lot of magic that happens behind the scenes to make sure that your searches are conducted with the least algorithmic complexity. But sometimes you have to pull all of the data out of the database before you can work with it. For example, if the records are encrypted in the database, you can&rsquo;t query them very well with <code>SQL</code>.</p>

<p>At times like these, I think hard about how to sift through the data with an algorithm that has the least complex <em>Big O</em> classification that I can. If you don&rsquo;t know about Big O notation, check out Justin Abrahms&rsquo;s <a href="https://justin.abrah.ms/computer-science/big-o-notation-explained.html">Big-O Notation Explained By A Self-Taught Programmer</a> or the <a href="http://bigocheatsheet.com/">Big-O Complexity Cheat Sheet</a>.</p>

<p>The basic gist is that algorithms can take more or less time, depending on their complexity, which is ranked in this order: O(1), O(log n), O(n), O(n log(n)), O(n<sup>2</sup>), O(2<sup>n</sup>), O(n!). So we prefer searches to be in one of the classifications at the beginning of this list.</p>

<p>When it comes to searching through arrays in Ruby, the first method that comes to mind is <code>Enumerable#find</code>, also known as <code>detect</code>. However, this method will search through the entire list until the match is found. While that&rsquo;s great if the record is at the beginning, it&rsquo;s a problem if the record is at the end of a really long list. It takes O(n) complexity to run a <code>find</code> search.</p>

<p>There is a faster way. Using <a href="http://www.ruby-doc.org/core-2.1.5/Array.html#method-i-bsearch">Array#bsearch</a>, you can find a match with only O(log n) complexity. To find out more about how a Binary Search works, check out my post <a href="http://fluxusfrequency.github.io/blog/2014/01/31/building-a-binary-search/">Building A Binary Search</a>.</p>

<p>Here&rsquo;s a look at the difference in search times between the two approaches when searching a range of 50,000,000 numbers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">50_000_000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="ss">:find</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">40_000_000</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="ss">:bsearch</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="o">.</span><span class="n">bsearch</span> <span class="p">{</span><span class="o">|</span><span class="n">number</span><span class="o">|</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">40_000_000</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">user</span>       <span class="nb">system</span>     <span class="n">total</span>       <span class="n">real</span>
</span><span class='line'><span class="n">find</span>     <span class="mi">3</span><span class="o">.</span><span class="mo">020000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">3</span><span class="o">.</span><span class="mo">030000</span>   <span class="p">(</span><span class="mi">3</span><span class="o">.</span><span class="mo">02</span><span class="mi">8417</span><span class="p">)</span>
</span><span class='line'><span class="n">bsearch</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">000006</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>bsearch</code> is much faster. However, there is a pretty big catch involved with using <code>bsearch</code>: the array must be sorted. This somewhat limits its usefulness, but it&rsquo;s still worth keeping in mind for occasions where it might come in handy, such finding a record in by a <code>created_at</code> timestamp that has already been loaded from the database.</p>

<h2>Enumerable#flat_map</h2>

<p>When dealing with relational data, sometimes we need to collect a bunch of unrelated attributes and return them in an array that is not nested. Let&rsquo;s imagine you had a blog application, and you wanted to find the authors of comments left on posts written in the last month by a given set of users.</p>

<p>You might do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">map</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You would then end up with a result such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[[[</span><span class="s1">&#39;Ben&#39;</span><span class="p">,</span> <span class="s1">&#39;Sam&#39;</span><span class="p">,</span> <span class="s1">&#39;David&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;Keith&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="o">[[]</span><span class="p">,</span> <span class="o">[</span><span class="kp">nil</span><span class="o">]]</span><span class="p">,</span> <span class="o">[[</span><span class="s1">&#39;Chris&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[]]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But you just wanted the authors! I guess we can call <code>flatten</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'>    <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another option would have been to use <code>flat_map</code>.</p>

<p>This just does the flattening as you go:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CommentFinder</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_users</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">flat_map</span> <span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>      <span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">flat_map</span> <span class="p">{</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
</span><span class='line'>        <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s not too much different, but better than having to call <code>flatten</code> a bunch of times.</p>

<h2>Array.new with a Block</h2>

<p>One time, when I was in bootcamp, our teacher Jeff Casimir (founder of <a href="http://turing.io/">Turing School</a>) asked us to build the game Battleship in an hour. It was a great exercise in object-oriented programming. We needed <code>Rule</code>s, <code>Player</code>s, <code>Game</code>s, and <code>Board</code>s.</p>

<p>Creating a represention of a <code>Board</code> is a fun exercise. After several iterations, I found the easiest way to set up an 8x8 grid was to do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Board</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">board</span>
</span><span class='line'>    <span class="vi">@board</span> <span class="o">||=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;0&#39;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s going on here? When you call <a href="http://www.ruby-doc.org/core-2.1.5/Array.html#method-c-new">Array.new</a> with an argument, it creates an array of that length:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [nil, nil, nil, nil, nil, nil, nil, nil]</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you pass it a block, it populates each of its members with the result of evaluating that block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;O&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; [&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So if you pass an array with eight elements a block that produces an array with eight elements that are all <code>'O'</code>, you end up with an 8x8 array populated with <code>'O'</code> strings.</p>

<p>Using the <code>Array#new</code> with a block pattern, you can create all kinds of bizarre arrays with default data and any amount of nesting.</p>

<h2>&lt;=></h2>

<p>The <a href="http://www.ruby-doc.org/core-2.1.5/Object.html#method-i-3C-3D-3E">spaceship</a>, or sort, operator is one of my favorite Ruby constructs. It appears in most of the built-in Ruby classes, and is useful when working with enumerables.</p>

<p>To illustrate how it works, let&rsquo;s look at how it behaves for <code>Fixnums</code>.  If you call <code>5&lt;=&gt;5</code>, it returns <code>0</code>. If you call <code>4&lt;=&gt;5</code>, it returns <code>-1</code>. If you call <code>5&lt;=&gt;4</code>, it returns <code>1</code>. Basically, if the two numbers are the same, it returns <code>0</code>, otherwise it returns <code>-1</code> for least to greatest sorting, and <code>1</code> for reverse sorting.</p>

<p>You can use the spaceship in your own classes by including the <code>comparable</code> module and redefining <code>&lt;=&gt;</code> with logic branching to make it return <code>-1</code>, <code>0</code>, and <code>1</code> for the cases you want.</p>

<p>Why would you ever want to do that?</p>

<p>Here&rsquo;s a cool use of it I came across on Exercism one day. There&rsquo;s an exercise called Clock, where you have to adjust the hours an minutes on a clock using custom <code>+</code> and <code>-</code> methods. It gets complicated when you try to add more than 60 minutes, because that will make your minute value invalid. So you have to adjust by incrementing another hour and subtracting 60 from the minutes.</p>

<p>One user, <code>dalexj</code>, had a brilliant way to solve this, using the spaceship operator:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">fix_minutes</span>
</span><span class='line'>    <span class="k">until</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">member?</span> <span class="n">minutes</span>
</span><span class='line'>      <span class="vi">@hours</span> <span class="o">-=</span> <span class="mi">60</span> <span class="o">&lt;=&gt;</span> <span class="n">minutes</span>
</span><span class='line'>      <span class="vi">@minutes</span> <span class="o">+=</span> <span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="o">&lt;=&gt;</span> <span class="n">minutes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@hours</span> <span class="o">%=</span> <span class="mi">24</span>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It works like this: until the minutes passed in are between 0 and 60, he subtracts either <code>1</code> or <code>-1</code> from the hours, depending on whether the minute amount is greater than 60. He then adjusts the minutes, adding either <code>-60</code> or <code>60</code> depending on the sort order.</p>

<p>The spaceship is great for defining custom sort orders for your objects, and can also come in handy for arithmetic operations if you remember that it returns one of three <code>Fixnum</code> values.</p>

<h2>Wrapping Up</h2>

<p>Getting better at writing code is a process of learning. Since Ruby is a language, a lot of the time I spend trying to improve is spent of reading &ldquo;literature&rdquo; (i.e. code on Exercism andGitHub), and reading (what is essentially) the dictionary for my language: (<a href="http://ruby-doc.org/">Rubydocs</a>.</p>

<p>It&rsquo;s so much easier to write expressive code when you know more methods. I hope that this collection of curiosities helped expand your Ruby vocabulary.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/12/18/seven-reasons-i-love-minitest/">Seven Reasons I Love Minitest</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-12-18T05:36:48-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post was a featured article in <a href="http://rubyweekly.com/issues/225">Ruby Weekly</a>.</p>

<p>It originally appeared on <a href="https://blog.engineyard.com/2014/seven-reasons-i-love-minitest">Engine Yard</a>, and was also published on the <a href="https://quickleft.com/blog/seven-reasons-i-love-minitest/">Quick Left Blog</a>.</p>

<h2>Introduction</h2>

<p>The other day at our company standup, I mentioned that I was eager to read an article on [Concurrency in Minitest] (<a href="http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/">http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/</a>) that was featured in <a href="http://rubyweekly.com/issues/216">Ruby Weekly</a>. One of my coworkers asked: &ldquo;people still use Minitest?&rdquo; My reply: &ldquo;you mean you&rsquo;re not using Minitest yet?&rdquo;</p>

<p>I love Minitest. It&rsquo;s small, lightweight, and ships with Ruby. It&rsquo;s used by respected programmers like <a href="http://rubyrogues.com/001-rr-testing-practices-and-tools/">Aaron Patterson</a>, Katrina Owen, Sandi Metz, and of course, DHH. Here&rsquo;s a look at why Minitest remains a powerful and popular choice for testing Ruby code.</p>

<h2>Witness the Firepower of this Fully Armed and Operational Testing Tool</h2>

<p>Although I come from a <a href="http://fluxusfrequency.github.io/blog/2013/10/03/the-history-of-programming-in-the-life-of-russ-lewis/">family of programmers</a>, I entered the profession by going to a bootcamp.  I was a student in the second <a href="http://www.galvanize.it/school/">gSchool</a> class. At that time, it was being taught by <a href="http://jumpstartlab.com/">Jumpstart Lab</a>.  My instructors were <a href="https://twitter.com/j3">Jeff Casimir</a>, <a href="https://twitter.com/franklinwebber">Franklin Webber</a>, and [Katrina Owen] (<a href="https://twitter.com/kytrinyx">https://twitter.com/kytrinyx</a>).</p>

<p>My classmates and I were brought up with TDD from day one. We practiced it in everything we did. The tool we used was Minitest. When it was first introduced, I scoffed a little because of the name.</p>

<p>&ldquo;Why are we using a &lsquo;mini&rsquo; testing framework?  I want to use what the pros use,&rdquo;
I complained to Katrina.</p>

<p>&ldquo;Minitest is a fully-featured testing framework, and is used in plenty of production apps,&rdquo; was her reply.</p>

<p>I&rsquo;ve been using it ever since. Here are seven reasons I think Minitest is the bees&#8217; knees.</p>

<h2>1. It&rsquo;s Simple</h2>

<p>Minitest ships with Ruby because it&rsquo;s easy to understand, and can be written by anyone who knows the language.  I love this simplicity because it makes it easy to focus on designing code.  Just imagine what you want it to do, and write your assertion, and make it pass.</p>

<p>I recently reached out to Katrina to ask her thoughts on what&rsquo;s good about Minitest. Its simplicity was at the top of her list:</p>

<p>&ldquo;It&rsquo;s simpler. There&rsquo;s no &lsquo;magic&rsquo; (just plain Ruby) [&hellip;] When there is &#8220;magic&rdquo; then it&rsquo;s very easy to assume that you <em>can&rsquo;t</em> understand it [&hellip;] You can read through the [Minitest] source code, and understand what is going on.&#8221;</p>

<p>I also asked Sandi Metz what she thought of Minitest. She said:</p>

<p>&ldquo;Minitest is wonderfully simple and encourages this same simplicity in tests and code.&rdquo;</p>

<p>Minitest is low in sugar. All you need to know is <code>assert</code> for booleans, and <code>assert_equal</code> for everything else. If you want to test a negative case, use <code>refute</code> or <code>refute_equal</code> instead. For everything else, just write Ruby.</p>

<h2>2. It&rsquo;s Extensible</h2>

<p>The relatively &ldquo;low-level&rdquo; status of Minitest makes it easy to customize tests. Katrina observes:</p>

<p>&ldquo;Because Minitest is so simple, it&rsquo;s not too hard to extend. It feels like a tool that I can shape to my needs, rather than a tool that I need to use the way it was intended.&rdquo;</p>

<p>If you want to repeat an assertion in multiple contexts, you can write a custom assertion for it, and call it in as many tests as you need.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Do some additional work here</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="s1">&#39;11 MPS&#39;</span><span class="p">,</span> <span class="n">swallow</span><span class="o">.</span><span class="n">speed</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_african</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;African&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_european</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;European&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_average_speed</span><span class="p">(</span><span class="n">swallow</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are testing something that requires nearly the same test to be run repeatedly, for example when testing a controller that has a user authentication <code>before_action</code>, you can create a shared example by <a href="https://canaryup.com/blog/shared-examples-with-minitest">including a module</a>.</p>

<p>If you need even more control, you can create an object with custom behavior that inherits from <code>Minitest::Test</code>, and have your tests inherit from it. Doing so allows you to completely customize your test suite with new methods as you see fit.</p>

<p>Finally, Minitest comes with hooks to help you easily write extensions to the gem. You can define a plugin by adding a <code>minitest/XXX_plugin.rb</code> file to your project folder, and Minitest will automatically find and require it. You can use extensions to define command-line options, custom reporters, and anything else you want Minitest to be able to do.</p>

<h2>3. It&rsquo;s Flat If You Use Assert</h2>

<p>The default syntax for Minitest is <code>assert</code>. Although the BDD <code>expect</code> syntax is available in <a href="https://github.com/seattlerb/minitest/blob/master/lib/minitest/spec.rb">mintest/spec</a>, I recommend giving <code>assert</code> a try. Maybe you love expectations because they read like English, sort of. Although <code>assert</code> doesn&rsquo;t try to imitate natural language, it&rsquo;s actually quite intuitive to use. It also provides the benefit of making your test files flat.</p>

<p>With nested <code>context</code>, <code>describe</code>, and <code>it</code> blocks, it can be difficult to remember what <code>it</code> refers to, and which <code>before</code> blocks are accessible in your scope. I find myself scanning indentation in BDD tests to figure out what scope I&rsquo;m working in.</p>

<p>When you use <code>assert</code> syntax, your test file is flat. You start with a test class, then you write a bunch of test methods inside of it. It&rsquo;s clear that the only variables available are those defined in the <code>setup</code> method or in the test itself. This flatness also means it gets painful quickly if your test is tied to too many dependencies. As Katrina puts it, &ldquo;the lack of nested contexts means that I&rsquo;m faced with the appropriate amount of pain when I make bad choices. It quickly becomes ugly if I have too many dependencies. I like that.&rdquo;</p>

<p>Using <code>assert</code> also makes it easy to document the desired behavior of your code: just name the test method to describe what you are testing. If you&rsquo;re really worried you&rsquo;ll forget what the test was for, you can output a message to the console if the test fails:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">test</span> <span class="s1">&#39;it calculates the air-speed velocity of an unladen swallow&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">swallow</span> <span class="o">=</span> <span class="no">Swallow</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">wing_span</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="ss">laden</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;European&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;11 MPS&#39;</span>
</span><span class='line'>  <span class="n">actual</span> <span class="o">=</span> <span class="n">swallow</span><span class="o">.</span><span class="n">average_speed</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s1">&#39;The average speed of an unladen</span>
</span><span class='line'><span class="s1">    swallow was incorrect&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Minitest&rsquo;s flatness is also beneficial when it comes to practicing a Test-Driven workflow. You can <code>skip</code> all of the tests in a file easily, without scanning through nested blocks. Then you can make them pass, one at a time.</p>

<h2>4. It Lends Itself to A Good Test-Driven Workflow</h2>

<p>Minitest is awesome for getting into a red/green/refactor loop. Write a test, watch it fail, make it pass, refactor. Repeat. A Minitest file is just a list of tests that are waiting for you to make them pass.</p>

<p>Plus, since you&rsquo;re just writing Ruby, you can use a style like this to get the next test set up with a minimum of effort:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">test</span> <span class="s1">&#39;something&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expected</span> <span class="o">=</span> <span class="c1"># some code</span>
</span><span class='line'>  <span class="n">actual</span> <span class="o">=</span> <span class="c1"># some simple result</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to repeat an assertion in different contexts, you can write a method for it, and call it in as many tests as you want to. Need a <a href="https://canaryup.com/blog/shared-examples-with-minitest">shared example</a>? Include a module.</p>

<h2>5. Minitest::Benchmark is Awesome</h2>

<p>If you are dealing with large amounts of data, and performance is a concern, <a href="https://github.com/seattlerb/minitest/blob/master/lib/minitest/benchmark.rb">Minitest::Benchmark</a> is your new best friend.</p>

<p>It lets you test your algorithms in a repeatable manner, to make sure that their algorithmic efficiency don&rsquo;t accidentally get changed. You can collect benchmarks in &ldquo;tab-separated format, making it easy to paste into a spreadsheet for graphing or further analysis&rdquo;.</p>

<p>Here are a few of the assertions in Minitest::Benchmark that might be of interest:</p>

<ul>
<li><code>assert_performance_constant</code></li>
<li><code>assert_performance_exponential</code></li>
<li><code>assert_performance_logarithmic</code></li>
<li><code>assert_performance_linear</code></li>
</ul>


<h2>6. It&rsquo;s Randomized By Default</h2>

<p>Running the tests in a different order each time can help catch bugs caused by unintended dependencies between examples. Here&rsquo;s how Aaron Patterson described the benefit of randomized tests in an <a href="http://rubyrogues.com/001-rr-testing-practices-and-tools/">episode of Ruby Rogues</a>:</p>

<p>&ldquo;I’m sure you’ve been in a situation where your [&hellip;] test fails in isolation, but when you run [the entire test suite] it works. [T]hat’s typically because one test set up some particular environment that another test depended on. [&hellip;] Since Minitest runs the test in a random order, you can’t make one test depend another, so you’ll see an error case.&rdquo;</p>

<h2>7. It&rsquo;s Faster</h2>

<p>Minitest doesn&rsquo;t create any matchers or example objects that have to be garbage collected. Many people have benchmarked Minitest against other frameworks, and it usually comes out at ahead. Often it&rsquo;s a marginal difference, but sometimes it comes out <a href="http://blog.rawonrails.com/2012/01/very-cursory-test-of-rspec-28-speed.html">significantly ahead</a>.</p>

<p>Minitest also supports concurrent test runs. Although I thought this would lead to great speed gains, it turns out that it <a href="http://chriskottom.com/blog/2014/10/exploring-minitest-concurrency/">only makes a difference in JRuby and Rubinius</a>. The Matz Ruby Implementation (MRI) <a href="https://blog.engineyard.com/2010/concurrency-real-and-imagined-in-mri-threads">doesn&rsquo;t get speed gains</a> when using concurrency. Still, it&rsquo;s nice to know that the option is there, in case you are using JRuby or Rubinius, or the MRI changes in the future.</p>

<h2>Have You Tried It?</h2>

<p>I&rsquo;ve talked to a lot of people that are surprised when I say I prefer Minitest. They often ask, &ldquo;why should I switch to Minitest?&rdquo; Perhaps a better question to ask is this one, posed by <a href="https://github.com/metaskills/holy_grail_harness/issues/3">Ken Collins</a>: &ldquo;What is in [other testing frameworks] that you need that Minitest does not offer?&rdquo;</p>

<p>Programming tools are a matter of individual taste. When I&rsquo;ve asked programmers about Minitest, they&rsquo;ve all expressed that they were not <em>against</em> RSpec or other frameworks. Sandi Metz said: &ldquo;I&rsquo;m agnostic about testing frameworks [&hellip;] I also use RSpec and I find it equally useful in it&rsquo;s own way.&rdquo; Katrina Owen said: &ldquo;I don&rsquo;t dislike RSpec, but I do prefer Minitest.&rdquo; In the end, I think most would agree that testing frameworks are a personal choice.</p>

<p>That said, if you haven&rsquo;t used Minitest lately (or ever), why not check it out?  If you&rsquo;re curious, but feel like you still need some convincing, just try it!  It&rsquo;s a small investment. You&rsquo;ll be up and running in a few minutes. Why not go try the first Ruby <a href="http://exercism.io/getting-started">Exercism</a>?</p>

<p>I hope this tour of Minitest&rsquo;s features has been informative, and piqued your interest in this fabulous test framework. Is there anything I missed? Disagree? Let&rsquo;s talk! Please share your point of view in the comments section, or tweet at me at @fluxusfrequency.</p>

<h2>Other Resources</h2>

<p><a href="http://www.slideshare.net/markykang/minitest-2013-0910">A Big Look At Minitest</a>
<br />
An informative slide deck that explores the ins and outs of Minitest.</p>

<p><a href="https://speakerdeck.com/ahawkins/bow-before-minitest">Bow Before Minitest</a>
<br />
A more opinionated slide deck comparing Minitest with other testing
tools.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2014/12/09/caching-asynchronous-queries-in-backbone/">Caching Asynchronous Queries in Backbone</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2014-12-09T06:32:04-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post originally appeared on <a href="https://blog.engineyard.com/2014/caching-asynchronous-queries-backbone">Engine Yard</a>.</p>

<p>It was also published on the <a href="https://quickleft.com/blog/caching-asynchronous-queries-in-backbone-js/">Quick Left Blog</a>.</p>

<h2>Introduction</h2>

<p>I was working on a <em>Backbone</em> project with Bob Bonifield recently, when we came across a problem. We were building an administration panel to be used internally by a client, and there were a couple of views that needed to display the same information about users in a slightly different way. To prevent unnecessary AJAX calls, we decided to cache the result of <code>Backbone.Model#fetch</code> at two levels of our application.</p>

<p>The result: less network time and a snappier user experience.</p>

<p>Here&rsquo;s how we did it.</p>

<h2>Caching the Controller Call</h2>

<p>We decided to use Brent Ertz&rsquo;s <a href="https://www.npmjs.org/package/backbone-route-control">backbone-route-control</a> package. It makes separation of concerns in the Backbone router easier by splitting the methods associated with each route into controllers.</p>

<p>I&rsquo;ll show how we set up the <code>UsersController</code> to handle the first level of caching. In this example, we&rsquo;ll use <code>backbone-route-control</code>. If you weren&rsquo;t using it, you could accomplish the same thing in the Backbone router.</p>

<p>First, we set up the app view and initialized a new Router as a property of it, passing in the controllers we wanted to use.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Main</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">UsersController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;controllers/users&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">controllers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">users</span><span class="o">:</span> <span class="k">new</span> <span class="nx">UsersController</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we defined the router and set it up to use the UsersController to
handle the appropriate routes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Router</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">BackboneRouteControl</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone-route-control&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">BackboneRouteControl</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;users/:id&#39;</span><span class="o">:</span> <span class="s1">&#39;users#show&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;users/:id/dashboard&#39;</span><span class="o">:</span> <span class="s1">&#39;users#dashboard&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Caching the User at the Controller Level</h2>

<p>After we got the router set up, we defined the UsersController and the appropriate route methods. We needed to wait until the user was loaded before we could generate the DOM, because we needed to display some data about the user.</p>

<p>We opted to cache the ID of the last user that was accessed by either the <code>show</code> or <code>dashboard</code> method, so that we wouldn&rsquo;t repeat the fetch call when we didn&rsquo;t need to. We set the result of the call to <code>Backbone.Model#fetch</code> (a promise) to a variable called <code>userLoadedDeferred</code>, and passed it down the the views themselves.</p>

<p>In doing so, we took advantage of the fact that, behind the scenes, <code>fetch</code> uses <a href="http://api.jquery.com/jquery.ajax/">jQuery.ajax</a> and returns a <a href="http://api.jquery.com/category/deferred-object/">deferred object</a>. When saving the result of a call to <code>jQuery.ajax</code> to variable, the value of the deferred&rsquo;s <code>.complete</code> or <code>.fail</code> callback will always return the same payload after it has been fetched from the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// UsersController</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">UsersController</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">lastUserID</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">userLoadedDeferred</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">user</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">lastUser</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_checkLastUser</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">usersView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserShowView</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">lastUser</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span><span class="o">:</span> <span class="nx">userLoadedDeferred</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">usersView</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">dashboard</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_checkLastUser</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">usersView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserDashboardView</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">lastUser</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span><span class="o">:</span> <span class="nx">userLoadedDeferred</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">usersView</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_checkLastUser</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">lastUserId</span> <span class="o">!=</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">lastUserId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">lastUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span> <span class="p">});</span>
</span><span class='line'>        <span class="nx">userLoadedDeferred</span> <span class="o">=</span> <span class="nx">lastUser</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Caching the User at the Model Level</h2>

<p>Although our <code>UsersController</code> was now caching the result of a fetch for a given user, we soon found that also needed to refetch the user to display their information in a sidebar view as well.</p>

<p>Since the <code>UsersController</code> and the <code>SidebarView</code> were making two separate calls to the <code>User</code> model <code>fetch</code> method, we decided to do some more caching in the Backbone Model. We opted to save the results of the <code>fetch</code> call for 30 seconds, only making a new server request if the timer had expired.</p>

<p>This allowed us to simply call <code>fetch</code> from within the view, without needing to know whether the <code>User</code> model was making an AJAX call or just returning the cached user data.</p>

<p>Here&rsquo;s what the code looked like in the model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// User Model</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// Set the timeout length at 30 seconds.</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">FETCH_CACHE_TIMEOUT</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// set a flag to bust the cache if we have ever set it</span>
</span><span class='line'>    <span class="c1">// before, and it&#39;s been more than 30 seconds</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">bustCache</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">&lt;</span> <span class="nx">FETCH_CACHE_TIMEOUT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// if we&#39;ve never cached the call to `fetch`, or if we&#39;re busting</span>
</span><span class='line'>    <span class="c1">// the cache, make a note of the current time, hit the server, and</span>
</span><span class='line'>    <span class="c1">// set the cache to this.lastFetchDeferred.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">bustCache</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">lastFetched</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// return the promise object that was cached</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">User</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Busting the Cache</h2>

<p>Later on in our development, we came across a situation where we needed to force a new fetch of <code>User</code>, right after updating some of their attributes. Because we were caching the result for 30 seconds, the newly updated attributes were not getting pulled from the server on our next fetch call. To overcome this, we neede to bust our cache manually. To make this happen, we changed our overridden <code>fetch</code> method to take an option that allowed us to force a refetch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// User Model</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// check if we passed the forceRefetch flag in the options</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">forceRefetch</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceRefetch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// updated the check to if the flag was passed</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">lastFetchDeferred</span> <span class="o">||</span> <span class="nx">bustCache</span> <span class="o">||</span> <span class="nx">forceRefetch</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Caching the <code>User</code> model in this app reduced our network time by quite a bit. Initially, we were making <em>two</em> server calls per route, because we had to fetch the user to display data in both the main view and the sidebar. After saving the result of the <code>fetch</code> in the controller, we were now only calling to the server once per User ID.</p>

<p>With the addition of model-level caching, we were also able to remove the duplicated call between the main views and the sidebar view, by saving the results of the <code>fetch</code> call for 30 seconds.</p>

<p>Overall, we reduced four calls per route to one call per 30 seconds. Making these adjustments helped make our application behave a lot more smoothly, and reduced server load in the process.</p>

<p>P.S. Have you implemented anything like this before? What are some of the tricks you use to make Backbone more efficient? Tweet at me @fluxusfrequency.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/04/25/how-to-choose-the-right-tech-stack-for-your-app/">How To Choose The Right Tech Stack For Your App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/29/why-we-use-test-driven-development-tdd/">Why We Use Test-Driven Development (TDD)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/12/five-hacks-to-level-up-your-learning-as-a-developer/">Five Hacks To Level Up Your Learning As A Developer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/08/how-to-learn-best-as-a-developer/">How To Learn Best As A Developer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/17/how-to-write-a-technical-blog-post-part-3/">How To Write A Technical Blog Post: Part 3</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 -  Ben Lewis <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
